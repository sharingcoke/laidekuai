# 来得快二手交易网站——需求与技术方案（汇总版）

> 来源：需求1.md + 需求2.md，已统一口径，去除歧义，可直接作为开发蓝本。
> 技术栈：Spring Boot 3.2 + Spring Security + JWT + MyBatis(+Plus) + MySQL 8.0 + Vue 3 + Vite + Element Plus
> 端口建议：前端 5173 | 后端 9090

---

## 目录（按“需求/技术方案”组织；可直接分工开发）
0. 决策记录（V1 已确认口径）
1. 角色与边界（权限模型）
2. 用户场景（无歧义）
3. 功能需求矩阵（最终版）
4. 核心业务规则（库存/拆单/支付/超时取消/退款/结算/风控/运费）
5. 数据模型与索引（摘要 + 索引表）
6. 状态机（订单/订单项/商品/退款/评价）
7. API 设计（字段/示例/Mock）
8. 状态约束表（API × 状态 × 副作用）
9. 前端交互规格（按钮显隐/禁用矩阵 + 页面 ASCII 原型）
10. 技术架构与工程目录（前后端分离）
11. 配置与错误码（必须硬编码一致）
12. 前端接口 Mock 集合（Swagger 示例 / Postman 导出样例）
13. 评价模块（买家评价 / 卖家回复）
14. 风险与优先级（开发顺序建议）
15. DDL/索引/外键策略（Flyway 为唯一来源）
16. 代码改动清单（文件路径 + 关键代码修改点）
17. 可选项口径（已确认）
18. 上线前检查清单（部署检查）
19. 数据迁移与版本管理（DDL 升级约定）

---

## 0. 决策记录（V1 已确认口径）
| 主题 | 决策（V1） | 说明/理由 |
|---|---|---|
| 拆单 | ✅ 必须按 seller_id 拆单（一个 orders 严格属于一个卖家） | 解决跨卖家发货/收货/结算卡死；卖家查询无需 JOIN 去重 |
| 支付体验 | ✅ 拆单后分别支付（不做合并支付单） | 降低聚合支付/分账复杂度；前端需强提示 |
| 库存扣减时机 | ✅ 下单即“锁库存”（扣 goods.stock），15 分钟未支付自动取消释放 | 防超卖；需要定时任务幂等释放 |
| 退款（逆向流程） | ✅ 极简：仅支持“已支付未发货退款”（PAID→REFUNDING→REFUNDED/PAID） | 已发货退货（SHIPPED→REFUNDED）留待 V2 |
| 结算资金流 | ✅ 轻量：orders.is_settled 表示“确认收货即时记账/视同已打款” | 不做 wallet/transaction_log；可 V2 扩展 |
| 运费 | ✅ V1 全场包邮 shipping_fee=0（字段保留） | 拆单下运费拆分复杂；V1 简化 |
| 角色模型 | ✅ 买卖一体：登录用户默认可发布商品 | 不做“卖家申请/审核” |
| 风控 | ✅ 活跃订单数（PENDING_PAY + PAID）> 10 拒绝下单 | 防恶意锁库存；CANCELED/REFUNDED/COMPLETED/REFUNDING 不计入 |
| 图片存储 | ✅ 本地磁盘 + 静态映射 /static/files/{uuid}.ext（白名单、限大小） | 生产部署需持久化卷；抽象 FileStorageService 便于换 OSS |
| DDL/Flyway | ✅ 从第一天起强制使用 Flyway 管理 DDL；V1__init.sql 即“单套 DDL” | 禁止手工跑 SQL 改结构；profiles 仅切换数据库连接 |
| 外键（FK） | ✅ 不使用物理外键；仅加索引 + 应用层校验 | 避免并发下外键维护成本与潜在写入阻塞风险 |
| refresh_token | ✅ V1 不做 refresh_token；access_token 过期需重新登录 | 简化鉴权链路；V2 可再扩展 |
| 错误码 | ✅ 前后端必须硬编码一致 | 可在前端做 code→i18n key 映射 |
| orders.seller_id | ✅ 必须加入 orders 表并加索引 | 拆单后订单归属明确；性能与权限更安全 |
| 评价维度 | ✅ 按订单项评价（One Item One Review） | 解决“一单多商品”评价歧义；利于商品评分 |

---

## 1. 角色与边界
| 角色 | 定义 | 权限边界 |
|---|---|---|
| 游客 | 未登录 | 仅浏览 APPROVED 商品/公告 |
| 登录用户 | 买卖一体 | 可买、可发布商品（需归属校验），可留言/收藏/购物车/下单/评价 |
| 管理员 | 平台治理 | 商品审核、卖家治理、留言治理、评价治理、公告、用户管理、退款审核、代发货 |

> 角色最终决策：买卖一体（不强制卖家角色）。如需"卖家申请"可作为可选流程，不影响默认权限开放。

### 1.1 权限矩阵（RBAC 详细视图）

> 本矩阵定义了各角色对所有功能模块的访问权限，作为前后端权限校验的唯一依据。

| 功能模块 | 子功能 | 游客 | 普通用户 | 管理员 | 说明 |
|---|---|---|---|---|---|
| **商品浏览** | 浏览商品列表 | ✓ | ✓ | ✓ | 仅 APPROVED 状态 |
| | 按分类筛选 | ✓ | ✓ | ✓ | |
| | 关键词搜索 | ✓ | ✓ | ✓ | V1: SQL LIKE |
| | 查看商品详情 | ✓ | ✓ | ✓ | 仅 APPROVED 状态 |
| | 查看非公开商品 | ✗ | 仅自己 | ✓ | DRAFT/PENDING/REJECTED/OFFLINE |
| **购物车** | 查看购物车 | ✗ | ✓ | ✓ | |
| | 加入购物车 | ✗ | ✓ | ✓ | 需登录 |
| | 修改数量 | ✗ | ✓ | ✓ | 归属校验 |
| | 删除购物车项 | ✗ | ✓ | ✓ | 归属校验 |
| **下单** | 创建订单（拆单） | ✗ | ✓ | ✓ | 买家身份 |
| | 支付订单 | ✗ | ✓ | ✓ | 买家身份 |
| | 取消订单 | ✗ | ✓ | ✓ | 买家身份，PENDING_PAY 状态 |
| | 查看我的订单 | ✗ | ✓ | ✓ | 买家身份 |
| | 查看我卖的订单 | ✗ | ✓ | ✓ | 卖家身份（orders.seller_id=当前用户） |
| | 管理员查看全量订单 | ✗ | ✗ | ✓ | ADMIN 可查询/筛选全量订单 |
| **发货** | 卖家发货 | ✗ | ✓ | ✓ | 卖家身份，item_status=PAID |
| | 管理员代发货 | ✗ | ✗ | ✓ | ADMIN 可操作所有订单 |
| **收货** | 确认收货 | ✗ | ✓ | ✓ | 买家身份，status=SHIPPED |
| **退款** | 申请退款 | ✗ | ✓(买家) | ✗ | status=PAID 且未发货 |
| | 卖家审核退款 | ✗ | ✓(卖家) | ✓ | orders.seller_id=当前用户 或 ADMIN |
| | 管理员审核退款 | ✗ | ✗ | ✓ | ADMIN 可审核所有退款 |
| **商品发布** | 创建商品 | ✗ | ✓ | ✓ | seller_id=当前用户 |
| | 编辑自己的商品 | ✗ | ✓ | ✓ | 归属校验 |
| | 提交审核 | ✗ | ✓ | ✓ | 归属校验 |
| | 下架商品 | ✗ | ✓ | ✓ | 归属校验 |
| | 审核商品 | ✗ | ✗ | ✓ | ADMIN |
| **评价** | 创建评价 | ✗ | ✓(买家) | ✓ | order.status ∈ {COMPLETED, REFUNDED} |
| | 查看商品评价 | ✓ | ✓ | ✓ | 公开，仅 visible 状态 |
| | 卖家回复评价 | ✗ | ✓(卖家) | ✓ | 归属校验：order_item.seller_id=当前用户 |
| | 治理评价（隐藏/删除） | ✗ | ✗ | ✓ | ADMIN |
| **留言** | 发布留言 | ✗ | ✓ | ✓ | 需登录，不限归属 |
| | 回复留言 | ✗ | ✓ | ✓ | 需登录，不限归属 |
| | 治理留言（隐藏/删除） | ✗ | ✗ | ✓ | ADMIN |
| **收藏** | 收藏商品 | ✗ | ✓ | ✓ | |
| | 查看收藏列表 | ✗ | ✓ | ✓ | |
| | 取消收藏 | ✗ | ✓ | ✓ | 归属校验 |
| **地址管理** | 新增/编辑/删除地址 | ✗ | ✓ | ✓ | 归属校验 |
| **公告** | 查看公告列表 | ✓ | ✓ | ✓ | 仅 PUBLISHED 状态 |
| | 查看公告详情 | ✓ | ✓ | ✓ | 仅 PUBLISHED 状态 |
| | 发布/编辑/下架公告 | ✗ | ✗ | ✓ | ADMIN |
| **用户管理** | 查看用户列表 | ✗ | ✗ | ✓ | ADMIN |
| | 禁用/启用用户 | ✗ | ✗ | ✓ | ADMIN |
| | 重置用户密码 | ✗ | ✗ | ✓ | ADMIN |
| **文件上传** | 上传图片 | ✗ | ✓ | ✓ | 需登录，UUID 文件名 |
| **分类管理** | 查看分类列表 | ✓ | ✓ | ✓ | 仅 ENABLED 状态 |
| | 新增/编辑/删除分类 | ✗ | ✗ | ✓ | ADMIN，删除前需校验无商品引用 |

**归属校验说明**：
- **商品归属**：goods.seller_id = 当前用户
- **订单买家归属**：orders.buyer_id = 当前用户
- **订单卖家归属**：orders.seller_id = 当前用户
- **购物车归属**：cart.user_id = 当前用户
- **收藏归属**：favorite.user_id = 当前用户
- **地址归属**：address.user_id = 当前用户
- **评价买家归属**：review.buyer_id = 当前用户（创建时）
- **评价卖家归属**：order_item.seller_id = 当前用户（回复时）

**权限校验流程**：
1. **认证层**：Spring Security JWT Filter 验证 Token 有效性
2. **角色层**：@PreAuthorize("hasRole('ADMIN')") 等注解校验角色
3. **归属层**：Service 层校验资源归属（如 goods.seller_id == currentUserId）
4. **状态层**：Controller/Service 层校验状态机约束（如只能对 PAID 订单申请退款）

---

## 2. 用户场景（无歧义）

> 目标：任何人读完本章，都能用同样的方式复述“用户怎么用、系统必须怎么做”。

### 2.1 场景 S1：游客浏览商品
1. 游客打开首页，看到商品列表（仅 APPROVED）。
2. 游客可按分类筛选、按关键词搜索（V1：SQL LIKE），可进入商品详情。
3. 游客不能收藏/加入购物车/下单/留言；点击相关按钮应提示先登录（前端）或返回 40101（后端）。

### 2.2 场景 S2：登录用户发布二手商品（买卖一体）
1. 用户注册/登录。
2. 进入“发布商品”页面填写：标题、分类、价格、库存、封面图、详情。
3. 保存为 DRAFT（草稿）或直接“提交审核”进入 PENDING。
4. 管理员审核：通过→APPROVED；驳回→REJECTED（带 audit_reason）。
5. 商品 APPROVED 后对外可见；卖家可下架→OFFLINE。

### 2.3 场景 S3：跨卖家下单（拆单）并分别支付（V1）
1. 用户将多个商品加入购物车（可能来自不同卖家）。
2. 用户在购物车点击“去结算”，选择收货地址，提交订单。
3. 后端在同一事务内执行：
   - 校验商品状态=APPROVED、库存>=qty、商品未下架。
   - 条件扣减库存（锁库存）。
   - 按 seller_id 拆单：生成 N 个 orders（每个卖家一个），及对应 order_items。
4. 前端进入“下单成功”页：明确提示“已拆成 N 个订单，请分别支付”。
5. 用户逐单点击“去支付”（模拟支付）；每个订单分别从 PENDING_PAY → PAID。

### 2.4 场景 S4：卖家发货、买家确认收货、系统结算
1. 卖家进入"我卖出的订单"，查询属于自己的 orders（orders.seller_id=当前用户）。
2. 卖家对订单项逐个点击"发货"（V1 为订单项级发货）。
3. **发货接口中包含聚合逻辑**：当某个 orders 下全部 order_items 都已 SHIPPED 时，该 orders 状态自动更新为 SHIPPED。
4. 买家在"我的订单"对 SHIPPED 的 orders 点击"确认收货"。
5. 系统将 orders 状态置为 COMPLETED，并将 is_settled=1、settled_time=now，同时批量更新 order_items.item_status=COMPLETED 与 order_item.order_status=COMPLETED。

### 2.5 场景 S5：超时取消（15 分钟未支付）释放库存（幂等）
1. 用户提交订单后未支付，订单处于 PENDING_PAY。
2. 15 分钟后，定时任务扫描超时订单：将其置为 CANCELED，并释放库存。
3. 定时任务重复扫描同一订单不得重复释放库存（幂等）。

### 2.6 场景 S6：退款（V1：仅"未发货退款"）
1. 买家对 PAID 且"未发货"的订单发起退款申请：PAID → REFUNDING。
2. 管理员或卖家审核：
   - 通过：REFUNDING → REFUNDED，**审核通过时释放库存**（因为未发货，库存占用需回滚）。
   - 驳回：REFUNDING → PAID，不释放库存。
3. **退款驳回后买家可再次申请退款，但同一订单申请退款达到 2 次后，第 3 次申请将自动进入争议处理流程**。
4. SHIPPED/COMPLETED 的退货退款不在 V1 范围（V2 扩展）。

> 说明：库存释放的时机是"退款审核通过时"（REFUNDING → REFUNDED），而非申请退款时。

### 2.7 场景 S7：争议处理（管理员裁决）
1. 当买家对同一订单申请退款达到 2 次并被驳回后，第 3 次申请退款时系统自动进入争议处理流程。
2. 买家在第 3 次申请退款时填写原因，系统自动创建争议记录，订单状态变更为 DISPUTED（争议中）。
3. 管理员查看争议详情，进行最终裁决：
   - **裁决退款**：订单状态变更为 REFUNDED，自动释放库存，买家无需再操作。
   - **裁决完成交易**：订单状态变更为 COMPLETED，买家不可再申请退款，卖家获得交易收益。
4. 争议处理无时效限制，直到管理员做出裁决。
5. 管理员拥有最高权限，可随时介入任何退款/争议情况进行裁决。

### 2.8 场景 S8：评价（按订单项）与卖家回复
1. 买家对订单状态 ∈ {COMPLETED, REFUNDED} 的订单项进行评价（每个订单项最多 1 条）。
2. 卖家/管理员可对订单项评价进行回复。
3. REFUNDED 的评价用于投诉/反馈：**商品详情页评分统计必须不计入均分**（仅展示为"退款评价"）。

---

## 3. 功能需求矩阵（最终版）

| 功能模块 | 游客 | 登录用户 | 管理员 |
|---|---|---|---|
| 注册/登录 | - | ✅ | ✅ |
| 个人中心 | - | ✅ | ✅ |
| 商品浏览/搜索 | ✅ | ✅ | ✅ |
| 商品详情 | ✅ | ✅ | ✅ |
| 收藏 | - | ✅ | ✅ |
| 购物车 | - | ✅ | ✅ |
| 发布/编辑/下架商品 | - | ✅(归属) | ✅ |
| 提交审核 | - | ✅(归属) | ✅ |
| 商品审核 | - | - | ✅ |
| 创建订单（拆单） | - | ✅ | - |
| 我的订单（买家） | - | ✅ | - |
| 订单管理（管理员） | - | - | ✅ |
| 卖家订单项发货 | - | ✅(归属) | ✅（可代发货） |
| 退款申请/审核 | - | 买家申请 | 管理员/卖家审核 |
| 争议处理 | - | 买家发起 | 管理员裁决 |
| 留言 | ✅(登录才可发) | ✅ | ✅治理 |
| 评价/回复 | - | 买家评价/卖家回复 | ✅（可评价/回复/治理） |
| 公告管理 | - | - | ✅ |
| 用户/卖家治理 | - | - | ✅ |

---

## 4. 核心业务规则（库存/拆单/支付/超时取消/退款/结算/风控/运费）

### 4.1 核心业务流程（拆单+支付+退款）
- 下单：address_id + items[{goods_id, qty}] → 校验(归属/状态/库存) → 事务扣库存 → 按 seller_id 拆单生成多条 orders + order_items → 返回拆单摘要（order_count, orders[]）。
- 支付：订单状态 PENDING_PAY → PAID（模拟支付）；拆单后“分别支付”，前端提示需逐单支付。
- 发货：卖家对订单项发货（PAID→SHIPPED），发货后聚合：若该单全部子项 SHIPPED，则主单→SHIPPED。
- 确认收货/结算：买家对单个 orders 确认收货（SHIPPED→COMPLETED），同时设置 is_settled=1, settled_time=now，并批量更新 order_items.item_status 与 order_item.order_status。
- 超时取消：PENDING_PAY 超 15 分钟，定时任务条件取消并释放库存（幂等）。
- 退款（已确认实现，极简）：PAID 未发货可申请 → REFUNDING → 管理员/卖家审核 → REFUNDED（释放库存）或回退 PAID。

---

### 4.2 需求条款与非功能指标
- R-01 商品可见性：游客仅能看到 APPROVED。
- R-02 买卖一体：登录即可发布，所有卖家操作需归属校验。
- R-03 拆单：按 seller_id 必拆，任意多卖家必生成多单。
- R-04 防超卖：扣库存使用条件更新 + 影响行数判定。
- R-05 状态机：所有状态变更必须校验当前状态（见第7章）。
- R-06 归属：商品/订单/订单项/地址/留言(可选)等必须做 seller_id / buyer_id / user_id 校验。
- R-07 超时取消幂等：重复扫描不重复释放库存。
- R-08 上传：白名单 jpg/png/webp，<=20MB，UUID 文件名，/static/files/** 映射。
- R-09 分页：page 默认10，最大50，参数 page/size。
- R-10 支付体验：拆单后分别支付，前端提示分单支付。
- R-11 风控：同一用户"活跃订单"（PENDING_PAY+PAID）数量 > 10 拒绝新订单，返回 40903（风控拦截）。
- 非功能：
  - 可用性：核心接口 99% 成功率；
  - 性能：列表接口 p95 < 500ms（验收方法见第16.4）；
  - 安全：JWT + 角色 + 归属 + 状态机 + 条件更新；
  - 日志：登录、下单、扣库存失败、发货、审核、超时取消、退款操作均记录。

---

### 4.3 业务规则（全局明确）
- 支付与取消：仅 PENDING_PAY 可 pay/cancel；重复操作返回 40901。
- 发货：仅订单项级，需 seller_id=当前用户，orders.status=PAID 且 item_status=PAID。
- 聚合：主单 SHIPPED/COMPLETED 由子项全 SHIPPED/COMPLETED 驱动。
- 结算(is_settled)：表示"已确认收货并记账可结算/视同已打款"。当前逻辑为确认收货即时置 is_settled=1, settled_time=now（无T+N、无钱包提现）。
- 订单归属：orders 必须带 seller_id（拆单后单卖家归属），索引 idx_orders_seller 便于卖家查询。
- **"未发货"明确定义（V1）**：orders.status = PAID 且 所有 order_items.item_status = PAID。
- 退款与库存（V1 支持"未发货退款"，已发货退货暂不实现）：
  - 申请：仅 PAID 未发货可申请退款 → REFUNDING。
  - 审核通过：REFUNDING → REFUNDED，同时释放库存（因为未发货，占用库存需回滚）。
  - 审核驳回：回到 PAID。
  - SHIPPED/COMPLETED 场景的退货/退款暂不支持（留待 V2），因此无库存回滚。
- 运费：V1 全场包邮；字段 shipping_fee 预留，拆单时可独立计费。
- 锁库存风控：buyer 的"活跃"订单数>10 即拒绝创建订单，返回 40903（风控拦截）。统计范围：WHERE buyer_id=? AND status IN (PENDING_PAY, PAID)。**说明**：仅统计用户作为买家的订单（不包含自己卖给自己，REFUNDING 状态不计入）。
- 风控拦截错误码：活跃订单超限返回 40903（用于前端差异化提示）。
- 上传存储：V1 本地磁盘；抽象 FileStorageService，未来可换 OSS；生产需持久化卷，返回URL统一 /static/files/{uuid}.ext，拒绝路径穿越。
- 购物车：下单后购物车商品不会被自动删除，用户需手动删除；订单取消/退款不自动恢复购物车，用户需手动重新加入。
- 下单库存不足策略（V1 无歧义）：**下单为原子操作**，任一商品库存不足则整单失败（不做“部分下单”）；返回 40902（库存不足）并提示具体 goods_id/标题（建议）。
  - 体验说明（V1 接受）：订单取消/退款后购物车不自动恢复，用户需要手动重新加购；前端可提示“如需再次购买，请重新加入购物车”（不做自动回填，留待 V2 优化）。
- 审计日志落库（V1 必做）：管理员/卖家关键操作（退款审核、代发货、商品审核）写入 audit_log。
- 消息中心（买家/卖家）：由订单状态变更 + 公告拼接展示，不单独建表。

### 4.4 边界情况处理（V1 明确口径）
- **用户账户删除**：V1 不支持账户删除功能；若未来实现，需确保有活跃订单时禁止删除或保留订单数据
- **商品删除/下架**：订单中的商品信息使用快照（goods_title, goods_cover），不受商品后续变更影响
- **卖家账户禁用**：V1 支持 DISABLED 状态阻止登录；禁用卖家账户时：
  - PENDING_PAY 订单：关闭并释放库存
  - PAID（未发货）订单：自动退款（PAID → REFUNDED，释放库存）
  - REFUNDING 订单：等待退款审核完成后再处理（不允许直接禁用）
  - DISPUTED 订单：等待争议解决后再处理（不允许直接禁用）
  - SHIPPED/COMPLETED 订单：**禁止禁用**，需等待订单完成后再处理
  - 禁用前需检查是否有 REFUNDING/DISPUTED/SHIPPED/COMPLETED 状态订单，如有则提示先处理完这些订单
- **订单项数量限制**：单次下单建议不超过 50 个订单项（应用层校验），避免事务过大
- **金额精度**：total_amount 使用 DECIMAL(12,2)，计算时注意四舍五入
- **分类树层级**：V1 固定为 3 层分类结构（一级分类 → 二级分类 → 三级分类）
  - 应用层校验：创建分类时 parent_id 必须存在且 level < 3
  - 一级分类：parent_id = NULL, level = 1
  - 二级分类：parent_id 指向一级分类, level = 2
  - 三级分类：parent_id 指向二级分类, level = 3
  - 前端使用级联下拉框选择
  - **循环引用检测**：创建分类时需检测循环引用（A→B→C→A），使用递归查询检查parent_id链条，确保不会形成闭环
  - **删除约束**：删除分类前需检查是否有子分类或商品引用，如有则拒绝删除

---

### 4.5 超时取消的幂等实现（必须实现）
扫描条件：
- status = PENDING_PAY
- created_at <= NOW() - INTERVAL ? MINUTE （使用配置的timeout-minutes）
- updated_at <= NOW() - INTERVAL 1 MINUTE （防止已更新的订单被重复处理）

单订单处理（强幂等门闩）：
1. `UPDATE orders SET status='CANCELED', updated_at=NOW(), cancel_reason='TIMEOUT' WHERE id=? AND status='PENDING_PAY' AND updated_at <= NOW() - INTERVAL 1 MINUTE`
2. 仅当 `affected_rows = 1` 时，才执行释放库存（按 order_items 逐条回补 goods.stock）。
3. 同步更新 order_item.order_status = CANCELED（保持冗余状态一致性）。
4. `affected_rows = 0`：说明订单已被其他线程处理（已支付/已取消/已更新），跳过且不得释放库存。

【增强幂等性说明】
- 增加 `updated_at` 条件防止定时任务重复处理同一订单
- 使用配置的 `order.timeout-minutes` 而非硬编码15分钟
- 记录取消原因 cancel_reason='TIMEOUT'，便于后续分析
- 定时任务扫描时记录每次处理的订单数，便于监控

---

### 4.6 退款时库存释放口径（无歧义）
| 场景 | 状态流转 | 是否释放库存 | 说明 |
|---|---|---|---|
| 未发货退款（V1 支持） | PAID → REFUNDING → REFUNDED | ✅ 是 | 未发货，商品仍在卖家手上；锁库存需回滚 |
| 已发货退货退款（V2） | SHIPPED → … → REFUNDED | V2 决策 | V1 不实现；若实现需定义退货验收与库存去向 |
| 已确认收货后退款（V2） | COMPLETED → … | ❌ 默认不释放 | 商品已交付；如退货成功才可能回到库存（需定义） |

退款审核幂等（必须实现）：
- 退款通过/驳回接口必须使用条件更新：`WHERE id=? AND status='REFUNDING'`。
- 仅当 `affected_rows=1` 时才允许执行后续动作（通过时释放库存、写审核日志等）；`affected_rows=0` 返回 40901（状态冲突）。
- `affected_rows=0` 的常见原因：重复点击、并发审核（卖家/管理员同时操作）、或订单状态已被其他流程改变。

---

## 5. 数据模型与索引（摘要 + 索引表）
- user：id, username(UNIQUE), password_hash, role, status(ACTIVE/DISABLED), nick_name, phone, avatar_url, created_at
- category：id, name, parent_id, level(1/2/3), sort, status(ENABLED/DISABLED), created_at
- goods：id, seller_id, category_id, title, sub_title, price, stock, detail, image_urls(JSON数组), status(DRAFT/PENDING/APPROVED/REJECTED/OFFLINE), audit_reason, audit_by, audit_at, created_at, updated_at
- cart：id, user_id, goods_id(UNIQUE), qty, created_at, updated_at
- address：id, user_id, receiver_name/phone, province/city/district/detail, is_default, status, created_at
- orders：id, order_no, buyer_id, seller_id(拆单归属), total_amount, shipping_fee(默认0), status{PENDING_PAY,PAID,REFUNDING,REFUNDED,SHIPPED,COMPLETED,CANCELED,DISPUTED}, cancel_reason, remark, pay_time, address_id, receiver_*, is_settled, settled_time, refund_request_count, created_at, updated_at
- order_item：id, order_id, goods_id, seller_id, goods_title/cover, price, quantity, amount, item_status{PENDING_PAY,PAID,SHIPPED,COMPLETED}, order_status(冗余订单主单状态), ship_company, tracking_no, ship_time
- message：id, goods_id, user_id, content, is_purchased(实时JOIN计算，不主动维护), status(visible/hidden/deleted), created_at
- message_reply：id, message_id, replier_id, content, status(visible/hidden/deleted), created_at
- dispute：id, order_id, applicant_id, applicant_type(BUYER/SELLER), reason, status(PENDING/RESOLVED), resolution(REFUND/COMPLETE), admin_id, admin_note, created_at, resolved_at
- favorite：id, user_id, goods_id (UNIQUE)
- notice：id, title, content, status(DRAFT/PUBLISHED/OFFLINE), published_at, created_at
- review（评价，按订单项评价 One Item One Review）：id, order_id, order_item_id, goods_id, buyer_id, is_refunded, rating(1-5), content, images, seller_reply, reply_time, status(visible/hidden/deleted), created_at
- audit_log：id, order_id, action, operator_id, operator_role, reason, created_at
- cart：id, user_id, goods_id, qty, created_at, updated_at
- 索引要点：goods(seller_id,category_id,status,created_at)；orders(status,created_at,is_settled,buyer_id,seller_id,order_no)；order_item(order_id,seller_id,item_status,goods_id)；favorite UNIQUE(user_id,goods_id)；cart UNIQUE(user_id,goods_id)；address(user_id,is_default)；message(goods_id,status,is_purchased)；review(order_item_id,goods_id)；dispute(order_id,status)；category(parent_id,level)。

> 评价模块补充：见第13章。

### 5.0 ER 实体关系图（Entity-Relationship Diagram）

> 本图采用 Crow's Foot Notation（乌鸦脚标记法）展示核心表之间的关联关系。

**图例说明**：
```
┌──────────────┐
│   TABLE      │  实体表
├──────────────┤
│ PK id        │  PK = Primary Key（主键）
│ FK ref_id    │  FK = Foreign Key（逻辑外键）
│ UK field     │  UK = Unique Key（唯一约束）
│ IX field     │  IX = Index（普通索引）
└──────┬───────┘
       │
       ├────||  1:N (一对多)
       ├────|o  0:N (零对多)
       ├────||  N:1 (多对一)
       └────||  1:1 (一对一)
```

**核心实体关系**：
```
                                    ┌──────────────┐
                                    │   category   │
                                    ├──────────────┤
                                    │ PK id        │
                                    │    name      │
                                    │ FK parent_id │
                                    │    status    │
                                    └──────┬───────┘
                                           │ 1
                                           │
                                           │ N
┌──────────────┐                      ┌──────▼───────┐
│    user      │                      │    goods     │
├──────────────┤ 1                  ├──────────────┤
│ PK id        │◄───────────────────││ FK seller_id │
│ UK username  │  (发布商品)          │ PK id         │
│    role      │                     │ FK category_id│
│    status    │                     │    title      │
└──────┬───────┘                     │    stock     │
       │                             │    price     │
       │ 1                           │    status    │
       │                             └──────┬───────┘
       │ N                                   │ 1
       │                                    │
       │ N                                   │ N
┌──────▼───────┐                      ┌──────▼───────┐
│   orders     │                      │ order_item   │
├──────────────┤ 1                  ├──────────────┤
│ PK id        │◄───────────────────││ FK order_id  │
│ UK order_no  │  (拆单：一卖家一单) │ PK id         │
│ FK buyer_id  │                     │ FK goods_id  │
│ FK seller_id │                     │ FK seller_id │
│    status    │                     │    item_status│
│ FK address_id│                     └──────┬───────┘
└──────┬───────┘                            │ 1
       │ 1                                 │
       │ N                                 │ N
┌──────▼───────┐                     ┌──────▼───────┐
│   address    │                     │    review    │
├──────────────┤                     ├──────────────┤
│ PK id        │                     │ PK id         │
│ FK user_id   │                     │ UK order_item_id│
└──────────────┘                     │    rating     │
                                     │ is_refunded  │
                                     └──────────────┘

┌──────────────┐                      ┌──────────────┐
│    cart      │                      │   favorite   │
├──────────────┤                     ├──────────────┤
│ FK user_id   │                     │ FK user_id   │
│ FK goods_id  │                     │ FK goods_id  │
│ UK (user+goods)│                   │ UK (user+goods)│
└──────────────┘                     └──────────────┘

┌──────────────┐ 1                  ┌──────────────┐
│   message    │◄───────────────────││ message_reply│
├──────────────┤ N (楼层回复)        ├──────────────┤
│ PK id        │                     │ PK id         │
│ FK goods_id  │                     │ FK message_id │
│ FK user_id   │                     │ FK replier_id│
│    status    │                     │    status    │
└──────────────┘                     └──────────────┘

┌──────────────┐
│   notice     │
├──────────────┤
│ PK id        │
│    title     │
│    content   │
│    status    │
└──────────────┘

┌──────────────┐
│  audit_log   │
├──────────────┤
│ PK id        │
│ FK order_id  │
│ FK operator_id│
│    action    │
└──────────────┘

┌──────────────┐ 1
│   dispute    │◄───────────────────│ orders
├──────────────┤
│ PK id        │
│ FK order_id  │
│    status    │
│  resolution  │
└──────────────┘
```

**关系定义**：
| 关系 | 类型 | 说明 |
|------|------|------|
| user → goods | 1:N | 一个用户可发布多个商品 |
| user → orders (buyer) | 1:N | 一个用户作为买家可拥有多个订单 |
| user → orders (seller) | 1:N | 一个用户作为卖家可拥有多个订单 |
| goods → order_item | 1:N | 一个商品可出现在多个订单项中（快照） |
| goods → message | 1:N | 一个商品可有多条留言 |
| orders → dispute | 1:1 | 一个订单只能有一个争议记录（如果有） |
| order_item → review | 1:1 | 一个订单项只能评价一次（UK 约束） |
| message → message_reply | 1:N | 一条留言可有多条回复 |
| user → cart | 1:N | 一个用户可有多个购物车项 |
| user → favorite | 1:N | 一个用户可收藏多个商品 |

### 5.1 索引表（Index Catalog，必须实现）
| 表 | 索引/约束 | 字段 | 目的 |
|---|---|---|---|
| user | UNIQUE | username | 防重复注册 |
| goods | INDEX | seller_id | 卖家商品管理 |
| goods | INDEX | category_id | 分类筛选 |
| goods | INDEX | status | 商品可见性筛选 |
| goods | INDEX | created_at | 列表排序 |
| goods | INDEX | title | 搜索（prefix% 可借助前缀特性；contains% 接受扫描） |
| orders | UNIQUE | order_no | 防重复单号 |
| orders | INDEX | buyer_id | 买家订单列表 |
| orders | INDEX | seller_id | 卖家订单列表（关键） |
| orders | INDEX | status | 订单筛选 |
| orders | INDEX | created_at | 订单排序/超时扫描 |
| orders | INDEX | is_settled | 结算列表/统计 |
| orders | INDEX(联合) | status, created_at | 超时取消扫描加速 |
| order_item | INDEX | order_id | 订单详情 |
| order_item | INDEX | seller_id | 卖家发货列表 |
| order_item | INDEX | item_status | 发货筛选 |
| order_item | INDEX | order_status | 待发货筛选（排除REFUNDING/REFUNDED/DISPUTED） |
| favorite | UNIQUE | user_id, goods_id | 防重复收藏 |
| cart | UNIQUE | user_id, goods_id | 防重复购物车行 |
| review | UNIQUE | order_item_id | 一项一评（核心约束） |
| review | INDEX | goods_id | 商品评价列表 |
| review | INDEX | order_id | 订单页聚合展示评价（保留的原因） |
| review | INDEX | status | 管理员治理筛选 |
| audit_log | INDEX | order_id | 订单审计查询 |
| audit_log | INDEX | operator_id | 管理员/卖家操作追踪 |
| message | INDEX | goods_id, status, is_purchased | 商品留言查询（is_purchased字段保留，实际查询采用实时JOIN order_item判断是否已购买） |
| goods_images | INDEX | goods_id, sort_order | 商品图片排序查询 |
| dispute | INDEX | order_id | 订单争议查询 |
| dispute | INDEX | status | 争议状态筛选 |
| category | INDEX | parent_id, level | 分类层级查询（支持3层分类） |

### 5.2 复合索引优化建议（V2 可选）
> 说明：以下复合索引可进一步优化查询性能，V1 阶段可暂不实施，但需在设计时保留扩展性。

| 表 | 复合索引 | 典型查询场景 | 说明 |
|---|---|---|---|
| message | INDEX(goods_id, status, created_at) | 查询某商品的可见留言按时间排序 | 单字段索引也可，复合索引更高效 |
| message_reply | INDEX(message_id, status, created_at) | 查询某留言的可见回复按时间排序 | 同上 |
| order_item | INDEX(order_id, item_status) | 查询某订单下各状态的订单项 | 发货状态筛选 |
| review | INDEX(goods_id, is_refunded) | 查询某商品的正常评价（排除退款评价） | 评分统计优化 |

### 5.3 user.role 取值范围（无歧义）
V1 口径：角色只有两类（买卖一体，不区分 SELLER）：
- `USER`：普通用户（默认）
- `ADMIN`：管理员

建议存储方式：
- `role VARCHAR(20) NOT NULL`，取值范围仅允许 `USER`/`ADMIN`（由应用层校验）。
- `status VARCHAR(20) NOT NULL`，取值范围仅允许 `ACTIVE`/`DISABLED`（由应用层校验）。

### 5.4 关键表-用途对照表
| 表 | 用途 | 关键业务字段 | 备注 |
|---|---|---|---|
| goods | 商品基础/审核 | seller_id, status, stock, price | 审核 + 库存扣减 |
| orders | 主单 | buyer_id, seller_id, status, is_settled | 拆单、一卖家一单 |
| order_item | 子单 | order_id, goods_id, seller_id, item_status, order_status | 发货/聚合/待发货查询 |
| review | 评价 | order_item_id, is_refunded, rating | 一项一评；退款评价标记 |
| message | 留言 | goods_id, user_id, status | 楼层问答；软删 |
| message_reply | 回复 | message_id, replier_id, status | 可软删 |
| favorite | 收藏 | user_id, goods_id | 唯一约束防重复 |
| cart | 购物车 | user_id, goods_id, quantity | 下单原子校验库存 |
| notice | 公告 | title, content, status | 管理员发布 |
| user | 账号 | role, status, nick_name, avatar | 买卖一体 |
| audit_log | 审计日志 | order_id, action, operator_id, reason | 退款/代发货/审核记录 |

---

## 6. 状态机（订单/订单项/商品/退款/评价）
- 订单主单：
  - PENDING_PAY → PAID → SHIPPED → COMPLETED
  - PENDING_PAY → CANCELED
  - PAID → REFUNDING → REFUNDED 或 PAID（驳回）
- 订单项（V1）：
  - PENDING_PAY → PAID → SHIPPED → COMPLETED
  - 订单级退款时，item_status 保持不变（不随 orders.status 变化）
  - 查询"待发货订单项"时需额外校验：orders.status NOT IN (REFUNDING, REFUNDED)
  - 扩展点（V2）：PAID/SHIPPED → REFUNDING_ITEM → REFUNDED_ITEM
- 商品审核：
  - DRAFT/REJECTED/OFFLINE → PENDING → APPROVED → OFFLINE
  - PENDING → REJECTED
- 留言治理：可见 → 隐藏/删除。

### 6.1 状态机图（ASCII）
订单主单（orders.status）
```text
            +-------------------+
            |   PENDING_PAY     |
            +-------------------+
              | pay()      | timeoutCancel()/cancel()
              v            v
        +-----------+   +-----------+
        |   PAID    |   | CANCELED  |
        +-----------+   +-----------+
           | refundApply() (未发货)
           v
     +-------------+   approve()   +-----------+
     |  REFUNDING  | ----------->  | REFUNDED  |
     +-------------+               +-----------+
           | reject()
           v  (回到同一个 PAID 节点：表示"退款驳回后仍为已支付未发货")
           |
           | [第3次申请退款时]
           v
     +-------------+
     |  DISPUTED   | ------------------------.
     |  (争议中)    |                         |
     +-------------+                         |
           |                                 |
           | 管理员裁决                        |
           +-------+-------+                 |
           |               |                 |
           v               v                 |
     +-----------+   +-----------+            |
     | REFUNDED  |   | COMPLETED  |<-----------+
     |  (退款)   |   | (完成交易)  |
     +-----------+   +-----------+

     (发货/收货主线)
     PAID --ship--> SHIPPED --confirm--> COMPLETED
```

订单项（order_item.item_status，V1）
```text
PENDING_PAY  ->  PAID  ->  SHIPPED  ->  COMPLETED
```

【V1 特别说明】
- 订单项（item_status）不参与退款流程，保持 PENDING_PAY → PAID → SHIPPED → COMPLETED
- 退款状态仅体现在订单主单（orders.status）上：REFUNDING、REFUNDED、DISPUTED
- order_item.order_status 字段冗余存储订单主单状态，便于查询"待发货订单项"时直接排除 REFUNDING/REFUNDED/DISPUTED 状态
- 查询"待发货订单项"：WHERE item_status=PAID AND order_status NOT IN (REFUNDING, REFUNDED, DISPUTED)
- V1 设计简化：订单项仅关注发货状态，退款由订单主单统一管理
 - **一致性要求**：orders.status 变更时必须同步更新 order_item.order_status（见第8.1状态约束表）

### 6.2 关键业务流程详解

> 本节通过详细流程图说明核心业务逻辑，帮助理解状态机的实际执行过程。

#### 6.2.1 下单拆单流程（核心）

```text
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              下单拆单完整流程                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

用户（买家）
    │
    │ 1. 选择收货地址 + 多个商品（可能来自不同卖家）
    │
    ▼
┌───────────────┐
│  前端：购物车   │
│  或 商品详情页  │
└───────┬───────┘
        │
        │ POST /api/orders
        │ { address_id: 1, items: [{goods_id:101,qty:1}, {goods_id:202,qty:2}] }
        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           后端：OrderController.createOrder                     │
└─────────────────────────────────────────────────────────────────────────────────┘
    │
    │ 2. 风控检查
    ▼
┌───────────────────────────────────────┐
│ 统计活跃订单数（PENDING_PAY+PAID）>10 ? │
│ YES → 返回 40903（风控拦截）           │
│ NO  ▼                                  │
└───────────────────────────────────────┘
    │
    │ 3. 校验地址归属
    ▼
┌───────────────────────────────────────┐
│ address.user_id == buyerId ?          │
│ NO → 返回 40301（越权）                │
│ YES ▼                                  │
└───────────────────────────────────────┘
    │
    │ 4. 开启事务，锁库存（条件扣减）
    ▼
┌─────────────────────────────────────────────────────────────────────┐
│ FOR EACH item IN items:                                            │
│   UPDATE goods                                                      │
│   SET stock = stock - #{qty}                                        │
│   WHERE id = #{goods_id} AND status='APPROVED' AND stock>=#{qty}   │
│   IF affected_rows == 0: ROLLBACK → 返回 40902（库存不足）          │
│ END FOR                                                            │
└─────────────────────────────────────────────────────────────────────┘
    │
    │ 5. 按卖家分组拆单
    ▼
┌─────────────────────────────────────────────────────────────────────┐
│ GROUP BY goods.seller_id                                            │
│ 示例：[{101,seller_id:11,qty:1}, {102,seller_id:11,qty:2},         │
│       {201,seller_id:22,qty:1}]                                    │
│ 分组结果：seller_id=11 → [{101,qty:1}, {102,qty:2}]                │
│          seller_id=22 → [{201,qty:1}]                              │
└─────────────────────────────────────────────────────────────────────┘
    │
    │ 6. 为每个卖家创建订单
    ▼
┌─────────────────────────────────────────────────────────────────────┐
│ FOR EACH seller_group:                                              │
│   INSERT orders (order_no, buyer_id, seller_id, status=            │
│     'PENDING_PAY', total_amount, ...)                              │
│   FOR EACH item IN seller_group.items:                             │
│     INSERT order_items (order_id, goods_id, goods_title,           │
│       goods_cover, price, quantity, amount,                        │
│       item_status='PENDING_PAY', order_status='PENDING_PAY')        │
│   END FOR                                                          │
│ END FOR                                                            │
│ COMMIT                                                             │
└─────────────────────────────────────────────────────────────────────┘
    │
    │ 7. 返回拆单结果
    ▼
┌─────────────────────────────────────────────────────────────────────┐
│ {                                                                  │
│   "code": 0,                                                       │
│   "data": {                                                        │
│     "order_count": 2,              // 拆成2个单                    │
│     "orders": [{order_id, order_no, seller_id, amount, status}]    │
│   }                                                                │
│ }                                                                  │
└─────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────┐
│  前端：下单成功页          │
│  - 显示拆成的N个订单       │
│  - 强调"需分别支付"        │
└───────────────────────────┘

【关键点】
• 幂等性：库存扣减使用条件更新 WHERE id=? AND stock>=qty
• 原子性：整个流程在一个事务中完成
• 数据一致性：订单项保存商品快照（goods_title, goods_cover）
```

#### 6.2.2 订单生命周期流转

```text
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        订单状态机完整流转图                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

              [下单拆单]
                   │
                   ▼
              PENDING_PAY ◄─────┐
              (待支付)           │ 15分钟超时
            ┌───┴────┐          │ 自动取消
            │        │          │
        [支付]   [手动取消]      │
            │        │          │
            ▼        ▼          │
           PAID   CANCELED ─────┘
        (已支付)  (已取消)
            │
      ┌─────┼─────┐
      │     │     │
  [申请退款] [发货] [管理员代发货]
      │     │     │
      ▼     ▼     ▼
  REFUNDING SHIPPED
  (退款审核中)(已发货)
      │     │
  ┌───┴─┐   │ [确认收货]
  │     │   │
[通过][驳回] │
  │     │   │
  ▼     ▼   ▼
REFUNDED PAID COMPLETED
(已退款)  (已完成)
       (结算)
```

**各阶段说明**：

| 当前状态 | 可执行操作 | 目标状态 | 关键副作用 |
|---------|----------|---------|-----------|
| PENDING_PAY | 支付 | PAID | 设置pay_time，批量更新order_items.item_status=PAID |
| PENDING_PAY | 取消 | CANCELED | 释放库存（幂等） |
| PAID | 申请退款（未发货）| REFUNDING | 校验所有订单项未SHIPPED |
| PAID | 发货 | SHIPPED | 订单项级发货，全部发货后聚合主单状态 |
| REFUNDING | 审核通过 | REFUNDED | 条件UPDATE，affected_rows=1才释放库存 |
| REFUNDING | 审核驳回 | PAID | 条件UPDATE，不释放库存 |
| SHIPPED | 确认收货 | COMPLETED | 设置is_settled=1, settled_time=now |

#### 6.2.3 超时取消流程（幂等设计）

```text
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        15分钟未支付自动取消流程                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

[定时任务] 每分钟执行一次
    │
    ▼
┌───────────────────────────────────────┐
│ SELECT * FROM orders                  │
│ WHERE status='PENDING_PAY'            │
│   AND created_at <= NOW()-15 MINUTE   │
└───────────────┬───────────────────────┘
                │
                │ 发现超时订单
                ▼
        ┌───────────────┐
        │ FOR EACH 订单  │
        └───────┬───────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ 【幂等门闩】条件 UPDATE                                                         │
│ UPDATE orders                                                                 │
│ SET status='CANCELED', updated_at=NOW()                                       │
│ WHERE id=? AND status='PENDING_PAY'                                          │
│                                                                               │
│ affected_rows = ?                                                            │
└─────────────────────────────────────┬───────────────────────────────────────┘
                                      │
                    ┌─────────────────┴─────────────────┐
                    │                                   │
              affected_rows = 1                  affected_rows = 0
              (成功抢锁)                          (锁已被其他线程拿)
                    │                                   │
                    ▼                                   ▼
          ┌───────────────┐                    ┌───────────────┐
          │  释放库存      │                    │  跳过，不做操作  │
          │  回补 goods.  │                    │  (避免重复释放) │
          │  stock += qty │                    └───────────────┘
          └───────────────┘

【为什么需要幂等？】
• 定时任务每分钟执行，可能与上次执行重叠
• 用户手动取消与定时取消可能同时发生
• 分布式环境下多实例可能同时处理同一订单

【并发场景演示】
  12:00 用户下单 (PENDING_PAY)
  12:10 用户点击"取消订单" → affected_rows=1 → 释放库存
  12:15 定时任务扫描 → affected_rows=0 → 跳过（避免重复释放）

【如果没有幂等门闩】
  12:10 用户取消 → 库存 +10
  12:15 定时任务 → 库存 +10
  → 结果：库存虚增，数据不一致！
```

#### 6.2.4 退款完整流程

```text
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            退款业务流程图（V1）                                 │
│                    仅支持：已支付未发货 (PAID → REFUNDED)                      │
└─────────────────────────────────────────────────────────────────────────────────┘

        ┌──────────────────┐
        │   订单状态：PAID  │
        │  (已支付未发货)   │
        └─────────┬────────┘
                  │
         [买家申请退款]
                  │
                  ▼
        ┌──────────────────┐
        │  POST /api/orders │
        │  /{id}/refund    │
        └─────────┬────────┘
                  │
        ┌─────────┴────────┐
        │                  │
        ▼                  ▼
┌───────────────┐  ┌───────────────┐
│   校验失败     │  │   校验成功     │
│   返回错误     │  │  状态变更为    │
│               │  │  REFUNDING    │
└───────────────┘  └───────┬───────┘
                           │
                  ┌────────┴────────┐
                  │                 │
                  ▼                 ▼
          ┌───────────────┐ ┌───────────────┐
          │  卖家审核     │ │  管理员审核   │
          │/api/seller/.. │ │/api/admin/..  │
          └───────┬───────┘ └───────┬───────┘
                  │                 │
        ┌─────────┴───────┐──────────┘
        │                 │
  ┌─────┴─────┐   ┌─────┴─────┐
  ▼           ▼   ▼           ▼
┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐
│审核通过│ │审核驳回│ │审核通过│ │审核驳回│
│approve│ │reject │ │approve│ │reject │
└───┬───┘ └───┬───┘ └───┬───┘ └───┬───┘
    │         │         │         │
    ▼         ▼         ▼         ▼
┌───────┐ ┌───────┐ ┌───────┐ ┌───────┐
│REFUNDED│ │  PAID │ │REFUNDED│ │  PAID  │
│(已退款) │ │(回退) │ │(已退款) │ │(回退) │
│+释放库存│ │       │ │+释放库存│ │       │
└───────┘ └───────┘ └───────┘ └───────┘

【关键点】
• 幂等性：UPDATE WHERE status='REFUNDING'，affected_rows=0 返回40901
• 库存释放：仅未发货退款释放库存（因为下单时已锁库存）
• 接口分离：卖家/api/seller/...、管理员/api/admin/...路径分离
• 并发冲突：条件UPDATE作为门闩，避免重复审核

【affected_rows=0的常见原因】
• 重复点击审核按钮
• 卖家/管理员同时审核同一订单
• 订单状态已被其他流程改变
```

#### 6.2.4 争议处理流程（V1 争议解决机制）

```text
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            争议处理流程图（V1）                                  │
│                  买家申请退款被驳回 2 次后 → 强制争议处理                        │
└─────────────────────────────────────────────────────────────────────────────────┘

        ┌──────────────────┐
        │   订单状态：PAID  │
        │  (已支付未发货)   │
        └─────────┬────────┘
                  │
         [买家第1次申请退款]
                  │
                  ▼
        ┌──────────────────┐
        │  状态：REFUNDING  │
        └─────────┬────────┘
                  │
         [卖家/管理员审核驳回]
                  │
                  ▼
        ┌──────────────────┐
        │   回到 PAID 状态  │
        │  退款次数+1=1     │
        └─────────┬────────┘
                  │
         [买家第2次申请退款]
                  │
                  ▼
        ┌──────────────────┐
        │  状态：REFUNDING  │
        └─────────┬────────┘
                  │
         [卖家/管理员审核驳回]
                  │
                  ▼
        ┌──────────────────┐
        │   回到 PAID 状态  │
        │  退款次数+1=2     │
        └─────────┬────────┘
                  │
         [买家第3次申请退款]
                  │
                  ▼
        ┌──────────────────┐
        │  系统检测到退款   │
        │  申请次数=2，强制 │
        │  进入争议处理流程 │
        └─────────┬────────┘
                  │
                  ▼
        ┌──────────────────┐
        │  POST /api/disputes│
        │  order_id, reason │
        │  (系统内部调用)   │
        └─────────┬────────┘
                  │
         ┌────────┴────────┐
         │                 │
    ┌────┴────┐      ┌─────┴─────┐
    ▼         ▼      ▼           ▼
┌──────────┐ ┌──────────┐ ┌──────────┐
│校验失败  │ │校验成功  │ │参数错误  │
│返回错误  │ │创建争议  │ │返回400   │
└──────────┘ │订单状态  │ └──────────┘
             │变更为    │
             │DISPUTED  │
             └────┬─────┘
                  │
                  ▼
        ┌──────────────────┐
        │   争议状态：PENDING│
        │   订单状态：DISPUTED│
        └─────────┬────────┘
                  │
         ┌────────┴────────┐
         │                 │
    [管理员介入争议]    [买家查看争议进度]
         │                 │
         ▼                 ▼
┌──────────────────┐  ┌──────────────────┐
│ GET /api/admin/  │  │ GET /api/disputes│
│ disputes         │  │ /{id}            │
└────────┬─────────┘  └──────────────────┘
         │
         ▼
┌──────────────────┐
│  查看争议详情     │
│  - order_id      │
│  - applicant_id  │
│  - reason        │
│  - 退款历史记录   │
└────────┬─────────┘
         │
    [管理员做出裁决]
         │
         ▼
┌──────────────────┐
│ POST /api/admin/ │
│ disputes/{id}    │
│ /resolve         │
│ resolution:      │
│ REFUND/COMPLETE  │
└────────┬─────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌─────────┐ ┌─────────┐
│裁决退款 │ │裁决完成 │
│REFUND   │ │COMPLETE │
└────┬────┘ └────┬────┘
     │           │
     ▼           ▼
┌─────────┐ ┌─────────┐
│REFUNDED │ │COMPLETED│
│(已退款) │ │(已完成) │
│+释放库存│ │不可退款 │
└─────────┘ └─────────┘

【关键点】
• 触发条件：买家对同一订单申请退款达到 2 次并被驳回后
• 强制流程：第 3 次申请退款时，系统强制创建争议记录
• 状态变更：订单状态从 PAID → DISPUTED → REFUNDED/COMPLETED
• 管理员权限：管理员拥有最高权限，可随时介入任何争议进行裁决
• 无时效限制：争议处理无时间限制，直到管理员做出最终裁决
• 自动执行：管理员裁决后，系统自动更新订单状态，无需买家/卖家再次操作
• 裁决退款：订单状态变更为 REFUNDED，自动释放库存
• 裁决完成：订单状态变更为 COMPLETED，买家不可再申请退款

【争议记录表 dispute】
• id: 争议记录ID
• order_id: 关联订单ID
• applicant_id: 申请人ID（买家）
• applicant_type: 申请人类型（BUYER/SELLER）
• reason: 争议原因
• status: 争议状态（PENDING 待处理 / RESOLVED 已解决）
• resolution: 裁决结果（REFUND 退款 / COMPLETE 完成交易）
• admin_id: 处理管理员ID
• admin_note: 管理员备注
• created_at: 创建时间
• resolved_at: 解决时间

【管理员裁决说明】
• 裁决退款（REFUND）：支持买家退款申请，订单状态变更为 REFUNDED，释放库存
• 裁决完成（COMPLETE）：支持卖家，订单状态变更为 COMPLETED，交易完成，买家不可再申请退款
• 管理员备注：记录裁决理由，便于后续查阅和审计
```

#### 6.2.5 商品审核状态机

```text
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        商品状态机完整流转图                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

         [创建/编辑商品]
              │
              ▼
         DRAFT (草稿)
              │
         [提交审核]
              │
              ▼
         PENDING (待审核)
              │
      ┌───────┴───────┐
      │               │
 [管理员审核通过] [管理员审核驳回]
      │               │
      ▼               ▼
   APPROVED       REJECTED
   (已上架)        (已驳回)
+ 对外可见      + 驳回原因
      │               │
  [下架]         [重新提交]
      │               │
      ▼               ▼
   OFFLINE        PENDING
   (已下架)       (重新审核)
      │
  [重新上架]
      │
      ▼
   PENDING

【可见性规则】
• 游客/普通用户：仅可见 status='APPROVED' 的商品
• 卖家本人：可见自己发布的所有状态商品
• 管理员：可见所有商品，不受状态限制

【状态约束】
• DRAFT/REJECTED/OFFLINE → PENDING：提交审核
• PENDING → APPROVED：管理员审核通过
• PENDING → REJECTED：管理员审核驳回（需audit_reason）
• APPROVED → OFFLINE：下架商品
#### 6.2.6 用户注册登录流程

```text
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            用户注册登录流程                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

【注册流程】
  用户填写表单
      │
      ▼
  POST /api/auth/register
  { username, password, nick_name(可选) }
      │
      ▼
  ┌───────────────────────┐
  │ 后端校验：              │
  │ 1. username 是否已存在  │
  │ 2. password 长度≥6      │
  │ 3. username 长度3-32    │
  └───────────┬───────────┘
              │
      ┌───────┴───────┐
      │               │
  校验失败         校验成功
      │               │
      ▼               ▼
  返回错误      INSERT user
  (40001)      (password_hash,
               role='USER',
               status='ACTIVE')
                  │
                  ▼
          注册成功，返回用户信息

【登录流程】
  用户输入账号密码
      │
      ▼
  POST /api/auth/login
  { username, password }
      │
      ▼
  ┌───────────────────────┐
  │ 后端校验：              │
  │ 1. username 是否存在    │
  │ 2. 密码是否正确         │
  │ 3. 用户状态是否正常      │
  └───────────┬───────────┘
              │
      ┌───────┴───────┐
      │               │
  校验失败         校验成功
      │               │
      ▼               ▼
  返回错误      生成 JWT Token
  (40101)      (包含 user_id, role)
                  │
                  ▼
          ┌───────────────┐
          │ 返回登录凭证：  │
          │ {             │
          │   access_token,│
          │   token_type,  │
          │   expires_in,  │
          │   user: {     │
          │     id,        │
          │     username,  │
          │     nick_name, │
          │     avatar_url │
          │   }           │
          │ }             │
          └───────────────┘

【Token使用】
  后续请求携带 Token：
  Authorization: Bearer {access_token}

  后端通过 JWT Filter 解析 Token，获取 user_id 和 role
  用于权限校验和归属校验
```

#### 6.2.7 商品发布流程

```text
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           商品发布完整流程                                       │
└─────────────────────────────────────────────────────────────────────────────────┘

卖家（登录用户）
    │
    │ 点击"发布商品"
    ▼
┌───────────────┐
│  填写商品信息  │
│  - 标题        │
│  - 分类        │
│  - 价格        │
│  - 库存        │
│  - 封面图      │
│  - 详情描述    │
└───────┬───────┘
        │
    ┌───┴────┐
    │        │
[保存草稿] [提交审核]
    │        │
    ▼        ▼
DRAFT    PENDING
(草稿)   (待审核)
    │        │
    │        ▼
    │    ┌──────────────────┐
    │    │ 等待管理员审核    │
    │    └────────┬─────────┘
    │             │
    │     ┌───────┴────────┐
    │     │                │
    │     ▼                ▼
    │ [审核通过]        [审核驳回]
    │     │                │
    │     ▼                ▼
    │  APPROVED         REJECTED
    │  (已上架)          (已驳回)
    │     │                │
    │     │           [修改后重新提交]
    │     │                │
    │  [下架]              ▼
    │     │             PENDING
    │     ▼                │
    │  OFFLINE            ...
    │  (已下架)             │
    │     │                │
    │  [重新上架]           │
    │     │                │
    │     ▼                │
    │   PENDING            │
    │     │                │
    └─────┴────────────────┘
          │
          ▼
    所有用户可见

【注意】
• 只有 APPROVED 状态的商品才对普通用户可见
• DRAFT 状态只有卖家自己可见
• REJECTED 状态会显示驳回原因，卖家修改后可重新提交
• OFFLINE 状态商品不对外展示，但卖家可以重新提交审核
```

#### 6.2.8 购物车流程

```text
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            购物车完整流程                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

用户浏览商品
    │
    │ [加入购物车]
    ▼
POST /api/cart
{ goods_id: 101, qty: 1 }
    │
    ▼
┌───────────────────────────────────────┐
│ 后端校验：                              │
│ 1. 商品是否存在                        │
│ 2. 商品状态是否为 APPROVED              │
│ 3. 库存是否充足                        │
└───────────────┬───────────────────────┘
                │
        ┌───────┴───────┐
        │               │
    校验失败         校验成功
        │               │
        ▼               ▼
    返回错误      检查购物车是否已有该商品
    (40401)      ┌─────────────────────┐
                │ cart表中是否存在     │
                │ user_id+goods_id?   │
                └─────────┬───────────┘
                          │
                  ┌───────┴────────┐
                  │                │
              已存在           不存在
                  │                │
                  ▼                ▼
          更新数量            插入新记录
          qty += qty         INSERT cart
                  │                │
                  └────────┬───────┘
                           ▼
                    返回成功

【注意】
• 购物车数据不锁定库存，下单时二次校验库存
• 订单取消/退款后不自动恢复购物车
• 购物车项有唯一约束：UNIQUE(user_id, goods_id)
```

#### 6.2.9 发货流程（卖家视角）

```text
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            卖家发货完整流程                                       │
└─────────────────────────────────────────────────────────────────────────────────┘

卖家登录
    │
    │ 进入"我卖出的订单"
    ▼
GET /api/seller/orders
    │
    ▼
查询：WHERE seller_id = 当前用户
    │
    ▼
选择 PAID 状态的订单
    │
    ▼
对某个订单项点击"发货"
    │
    ▼
POST /api/seller/order-items/{id}/ship
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 后端校验：                                                                        │
│ 1. order_item.id 是否存在                                                       │
│ 2. order_item.item_status 是否为 PAID                                           │
│ 3. orders.status 是否为 PAID（不是REFUNDING/REFUNDED/DISPUTED）                  │
│ 4. orders.seller_id 是否为当前用户                                                │
└─────────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
更新订单项状态：PAID → SHIPPED
    │
    ▼
检查该订单下所有订单项是否都已 SHIPPED
    │
    ├─ YES → 订单主单状态也变为 SHIPPED，并同步 order_item.order_status=SHIPPED
    └─ NO → 主单保持 PAID（order_item.order_status 仍为 PAID）
    │
    ▼
返回成功

【管理员代发货】
POST /api/admin/order-items/{id}/ship
相同逻辑，但不需要 seller_id 归属校验（ADMIN可操作所有订单）

【注意】
• 发货是订单项级别的操作
• 主单 SHIPPED 状态由订单项聚合驱动
• REFUNDING/REFUNDED/DISPUTED 状态的订单不允许发货
```

#### 6.2.10 确认收货流程

```text
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            确认收货完整流程                                       │
└─────────────────────────────────────────────────────────────────────────────────┘

买家查看"已发货"状态的订单
    │
    │ 对某个订单点击"确认收货"
    ▼
POST /api/orders/{id}/confirm
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 后端校验：                                                                        │
│ 1. orders.id 是否存在                                                           │
│ 2. orders.status 是否为 SHIPPED                                                  │
│ 3. orders.buyer_id 是否为当前用户                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 开启事务：                                                                        │
│                                                                               │
│ 1. 更新主单状态：SHIPPED → COMPLETED                                              │
│    + is_settled = 1                    // 标记为已结算                           │
│    + settled_time = NOW()              // 结算时间                             │
│                                                                               │
│ 2. 更新所有订单项：item_status → COMPLETED                                       │
│    + 同步 order_item.order_status = COMPLETED                                   │
│                                                                               │
│ COMMIT                                                                       │
└─────────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
返回成功

【结算说明】
• is_settled = 1 表示"已确认收货并完成结算"
• settled_time 用于财务对账
• V1 采用"确认收货即时结算"模式（无钱包系统）

【注意】
• 只有 SHIPPED 状态的订单可以确认收货
• 确认收货后订单状态变为 COMPLETED，不可撤销
• COMPLETED 状态的订单可以进行评价
```

#### 6.2.11 评价流程

```text
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            评价完整流程                                           │
└─────────────────────────────────────────────────────────────────────────────────┘

买家完成订单（COMPLETED 或 REFUNDED）
    │
    │ 进入"我的订单"，选择已完成订单
    ▼
对某个订单项点击"评价"
    │
    ▼
┌───────────────────────────┐
│ 评价填写页：                │
│ - 订单项信息（只读）         │
│ - 评分：1-5星               │
│ - 评价内容：必填             │
│ - 评价图片：可选             │
└───────────┬───────────────┘
            │
            │ [提交评价]
            ▼
    POST /api/reviews
    {
      order_item_id: 5001,
      rating: 5,
      content: "很好用",
      images: ["/static/files/rev1.jpg"]
    }
            │
            ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 后端处理：                                                                        │
│ 1. 校验订单状态是否为 COMPLETED 或 REFUNDED                                      │
│ 2. 校验 order_item_id 是否属于当前用户                                           │
│ 3. 校验该 order_item 是否已被评价（UNIQUE约束）                                   │
│ 4. 读取订单状态，确定 is_refunded 值：                                            │
│    - order.status = REFUNDED → is_refunded = 1                                  │
│    - order.status = COMPLETED → is_refunded = 0                                 │
│ 5. 插入评价记录                                                                │
└─────────────────────────────────────────────────────────────────────────────────┘
            │
            ▼
        评价成功

【卖家回复评价】
POST /api/reviews/{id}/reply
{ seller_reply: "感谢支持！" }
    │
    ▼
更新评价：seller_reply, reply_time

【评价展示规则】
• 商品详情页显示所有 is_refunded=0 的评价（退款评价不计入均分）
• 退款评价单独展示，标注"退款评价"
• 卖家回复显示在评价下方
• 评分统计只计算 is_refunded=0 的评价

【注意】
• 每个订单项只能评价一次（UNIQUE(order_item_id)）
• 评价创建后不允许修改
• 卖家可以多次回复（覆盖更新）
```

#### 6.2.12 留言回复流程

```text
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            留言回复完整流程                                       │
└─────────────────────────────────────────────────────────────────────────────────┘

用户浏览商品详情 → 滚动到"留言/问答"区域
    │
    │ [登录用户]点击"我要提问"
    ▼
┌───────────────────────────┐
│ 留言填写框：                │
│ 请输入您的留言... [提交]    │
└───────────┬───────────────┘
            │
            │ [提交留言]
            ▼
    POST /api/messages
    { goods_id: 101, content: "请问成色如何？" }
            │
            ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 后端处理：                                                                        │
│ 1. 校验用户是否已登录                                                            │
│ 2. 校验 goods_id 是否存在且状态为 APPROVED                                       │
│ 3. 插入留言：INSERT message (goods_id, user_id, content, status='visible')     │
└─────────────────────────────────────────────────────────────────────────────────┘
            │
            ▼
        留言成功，刷新列表

【回复留言】
任何登录用户都可以对留言进行回复（不限制归属）
    │
    │ 点击某条留言的"回复"按钮
    ▼
    POST /api/messages/{id}/replies
    { content: "9成新，功能正常" }
            │
            ▼
插入回复：INSERT message_reply (message_id, replier_id, content, status='visible')

【管理员治理】
POST /api/admin/messages/{id}/hide     → 隐藏
POST /api/admin/messages/{id}/delete    → 软删除（status='deleted'）

软删除：不物理删除数据，只更新 status 字段
客户端列表只返回 status='visible' 的内容

【注意】
• V1 只支持两层结构：message → message_reply（不做"回复的回复"）
• 任何登录用户都可以回复留言（不限制归属）
• 管理员可以治理任意留言/回复
```

#### 6.2.13 收藏流程

```text
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            收藏完整流程                                           │
└─────────────────────────────────────────────────────────────────────────────────┘

用户浏览商品
    │
    │ 点击"收藏"按钮（❤图标）
    ▼
POST /api/favorites
{ goods_id: 101 }
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 后端处理：                                                                        │
│ 1. 校验用户是否已登录                                                            │
│ 2. 校验 goods_id 是否存在                                                        │
│ 3. 检查是否已收藏：                                                              │
│    SELECT COUNT(*) FROM favorite WHERE user_id=? AND goods_id=?                 │
│  IF COUNT > 0: 返回"已收藏"                                                     │
│  ELSE: INSERT favorite (user_id, goods_id, created_at)                          │
└─────────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
    收藏按钮变为"已收藏"状态（红色❤）

【查看收藏】
GET /api/favorites
返回当前用户的收藏列表（包含商品详情）

【取消收藏】
DELETE /api/favorites/{id}
删除收藏记录（需归属校验：favorite.user_id = 当前用户）

【注意】
• 收藏表有唯一约束：UNIQUE(user_id, goods_id)
• 商品被删除/下架后，收藏记录保留，但商品信息需特殊处理
```

#### 6.2.14 搜索流程

```text
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            商品搜索完整流程                                       │
└─────────────────────────────────────────────────────────────────────────────────┘

用户在搜索框输入关键词
    │
    │ V1 采用前缀匹配（利用索引，性能最优）
    │   例：搜 "iph" → 匹配 "iPhone", "ipad"（不匹配"某iph"）
    │
    │ [点击搜索]
    ▼
GET /api/goods?keyword=手机&category_id=1&page=1&size=10
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 后端处理：                                                                        │
│ 1. 构建查询条件：                                                                │
│    - 普通用户：固定 WHERE status='APPROVED'                                     │
│    - 管理员：可按 status 筛选                                                   │
│    - category_id：如果传入，添加 AND category_id=?                              │
│                                                                               │
│ 2. 关键词匹配：                                                                  │
│    IF match='prefix':                                                          │
│      WHERE title LIKE CONCAT(#{keyword}, '%')    -- 利用索引前缀特性             │
│    ELSE IF match='contains':                                                   │
│      WHERE title LIKE CONCAT('%', #{keyword}, '%')  -- 全表扫描（小数据量可接受） │
│                                                                               │
│ 3. 分页查询：LIMIT #{size} OFFSET #{offset}                                    │
│ 4. 返回结果：{ page, size, total, records: [...] }                            │
└─────────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
返回商品列表 + 分页信息

【搜索优化】
• V1 采用前缀匹配：WHERE title LIKE CONCAT(#{keyword}, '%')，可利用索引
• 建议创建索引：CREATE INDEX idx_goods_title ON goods(title)
• V2可考虑引入 Elasticsearch 等搜索引擎支持全文搜索

【注意】
• 游客和普通用户只能搜索 APPROVED 状态的商品
• 管理员可以搜索所有状态的商品（通过 status 参数）
```

#### 6.2.15 时序图：关键业务交互流程

> 本节采用 UML Sequence Diagram 标准展示系统各组件之间的交互顺序。

**UML 时序图图例**：
```
Actor   参与者（用户/外部系统）
Object  对象/组件
→       同步调用
→→      异步消息
loop    循环
alt     条件分支
opt     可选分支
```

##### 6.2.15.1 下单锁库存时序图（Order Creation with Inventory Lock）

```text
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    Sequence Diagram: Order Creation with Inventory Lock        │
└─────────────────────────────────────────────────────────────────────────────────┘

   Buyer       Frontend      Controller      Service       MyBatis       MySQL
    │             │               │              │             │             │
    │  selectItems()             │              │             │             │
    │  submitOrder()             │              │             │             │
    │────────────►│               │              │             │             │
    │             │ POST /api/orders            │             │             │
    │             │ {address_id, items}         │             │             │
    │             │──────────────►│              │             │             │
    │             │               │              │             │             │
    │             │               │ checkRiskControl()            │             │
    │             │               │─────────────►│             │             │
    │             │               │              │ SELECT COUNT(*)       │
    │             │               │              │ WHERE buyer_id=?      │
    │             │               │              │ AND status IN (...)   │
    │             │               │              │────────────►│           │
    │             │               │              │ ◄───────────│           │
    │             │               │◄─────────────│             │           │
    │             │               │              │             │           │
    │             │               │ beginTransaction()          │           │
    │             │               │─────────────►│             │           │
    │             │               │              │             │           │
    │             │               │              │ loop  [foreach item]          │
    │             │               │              │  lockInventory()             │
    │             │               │              │────────────►│           │
    │             │               │              │             │ UPDATE goods│
    │             │               │              │             │ SET stock  │
    │             │               │              │             │ WHERE id=? │
    │             │               │              │             │ AND stock>=qty
    │             │               │              │             │──────────►│
    │             │               │              │             │ ◄─────────│
    │             │               │              │  affected_rows?
    │             │               │              │  ◄─────────│             │
    │             │               │              │    if rows=0: ROLLBACK
    │             │               │              │────────────►│           │
    │             │               │              │             │──────────►│
    │             │               │              │             │ ROLLBACK   │
    │             │               │              │             │           │
    │             │               │              │ splitOrderBySeller()       │
    │             │               │              │────────────►│           │
    │             │               │              │             │ INSERT orders│
    │             │               │              │             │──────────►│
    │             │               │              │             │ INSERT order_items
    │             │               │              │             │──────────►│
    │             │               │              │ commit()    │           │
    │             │               │              │────────────►│           │
    │             │               │              │             │──────────►│
    │             │               │              │             │ COMMIT    │
    │             │               │◄─────────────│◄────────────│           │
    │             │◄──────────────│              │             │           │
    │ ◄───────────│ {code:0, order_count:2, orders:[...]}               │
    │             │               │              │             │           │
    │  payOrders()               │              │             │           │
    │────────────►│               │              │             │           │

───────────────────────────────────────────────────────────────────────────────────
                     Concurrent Scenario: Stock Race Condition
───────────────────────────────────────────────────────────────────────────────────

   BuyerB                                                  BuyerA
    │                                                        │
    │ UPDATE goods SET stock-=1 WHERE id=101 AND stock>=1    │
    │───────────────────────────────────────────────────────►│
    │                                                        │ UPDATE goods SET stock-=1 WHERE id=101 AND stock>=1
    │                                                        │──────────────────────────────────────────────────────►│
    │                     MySQL Row Lock (Transaction Isolation)             │
    │                                                        │
    │ affected_rows=1 ✓                                      │
    │ COMMIT                                                  │
    │                                                        │ affected_rows=0 ✗
    │                                                        │ ROLLBACK
    │                                                        │
    │ Return success                                         │ Return 40902 (Insufficient Stock)
```

##### 6.2.15.2 退款审核时序图（Refund Approval）

```text
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    Sequence Diagram: Refund Approval Workflow                  │
└─────────────────────────────────────────────────────────────────────────────────┘

   Buyer      Seller       Admin       Service      MyBatis       MySQL
    │            │             │            │             │            │
    │ applyRefund()            │            │             │            │
    │────────────►│            │            │             │            │
    │            │            │            │ POST /api/orders/{id}/refund
    │            │            │            │─────────────►│            │
    │            │            │            │             │            │
    │            │            │            │ validate: status='PAID' AND not shipped
    │            │            │            │ UPDATE orders SET status='REFUNDING'
    │            │            │            │             │───────────►│
    │            │            │            │ INSERT audit_log(action='REFUND_APPLY')
    │            │            │            │             │───────────►│
    │            │            │            │             │            │
    │ ◄──────────│            │            │ {code:0}     │            │
    │            │            │            │             │            │
    │            │ approve()  │            │             │            │
    │            │────────────►│            │             │            │
    │            │            │            │ POST /api/seller/orders/{id}/refund/approve
    │            │            │            │─────────────►│            │
    │            │            │            │ [Idempotent Check]
    │            │            │            │ UPDATE orders SET status='REFUNDED'
    │            │            │            │ WHERE id=? AND status='REFUNDING'
    │            │            │            │             │───────────►│
    │            │            │            │ affected_rows?
    │            │            │            │   =1 ✓      │            │
    │            │            │            │   =0 ✗ → 40901           │
    │            │            │            │◄────────────│            │
    │            │            │            │ releaseInventory()
    │            │            │            │ UPDATE goods SET stock+=qty
    │            │            │            │ FROM order_items WHERE order_id=?
    │            │            │            │─────────────►│───────────►│
    │            │            │            │ insertAuditLog()
    │            │            │            │ INSERT audit_log(action='REFUND_APPROVE')
    │            │            │            │─────────────►│───────────►│
    │            │            │            │             │            │
    │            │ ◄──────────│            │ {code:0}     │            │
    │            │            │            │             │            │

───────────────────────────────────────────────────────────────────────────────────
                        Admin Approval Path (Alternative)
───────────────────────────────────────────────────────────────────────────────────

                           Admin
                             │
                             │ POST /api/admin/orders/{id}/refund/approve
                             │──────────────────────────────────────────────────────►│
                             │                                                       (same logic)
                             │◄──────────────────────────────────────────────────────│

───────────────────────────────────────────────────────────────────────────────────
                    Concurrent Scenario: Seller + Admin Approval Race
───────────────────────────────────────────────────────────────────────────────────

   Seller                    Admin                    MySQL
     │                         │                          │
     │ UPDATE ...WHERE status='REFUNDING'                          │
     │──────────────────────────────────────────────────────────►│
     │                         │                          affected_rows=1 ✓
     │ COMMIT                   │                          │
     │                         │ UPDATE ...WHERE status='REFUNDING'
     │                         │──────────────────────────────────────────────────►│
     │                         │                          affected_rows=0 ✗
     │                         │◄─────────────────────────────────────────────────│
     │                         │ Return 40901 "Status Conflict"
```

##### 6.2.15.3 发货聚合时序图（Shipping Aggregation）

```text
┌─────────────────────────────────────────────────────────────────────────────────┐
│              Sequence Diagram: Order Item Shipping → Order Aggregation          │
└─────────────────────────────────────────────────────────────────────────────────┘

   Seller   Frontend  Controller  Service   MyBatis   MySQL
     │         │          │          │          │          │
     │ viewOrders()       │          │          │          │
     │────────►│          │          │          │          │
     │         │ GET /api/seller/orders
     │         │──────────►│          │          │          │
     │         │          │ query WHERE seller_id=? AND status='PAID'
     │         │          │──────────►│          │          │
     │         │◄─────────│◄─────────│          │          │
     │  [Order #1001            │          │          │
     │   ItemA x1, ItemB x2]     │          │          │
     │ shipItem(ItemA)│          │          │          │
     │────────►│          │          │          │          │
     │         │ POST /api/seller/order-items/{id}/ship
     │         │──────────►│          │          │          │
     │         │          │ validate:                         │
     │         │          │ - item exists                     │
     │         │          │ - item_status='PAID'              │
     │         │          │ - orders.status='PAID'            │
     │         │          │──────────►│          │          │
     │         │          │          │ beginTransaction()  │          │
     │         │          │          │─────────►│          │
     │         │          │          │          │ UPDATE order_item
     │         │          │          │          │ SET item_status='SHIPPED'
     │         │          │          │          │──────────►│─────────►│
     │         │          │          │          │ [Aggregation Logic]
     │         │          │          │          │ SELECT COUNT(*)
     │         │          │          │          │ FROM order_item
     │         │          │          │          │ WHERE order_id=?
     │         │          │          │          │ AND item_status<>'SHIPPED'
     │         │          │          │          │──────────►│─────────►│
     │         │          │          │          │◄─────────│◄─────────│
     │         │          │          │          │ alt count=0      │
     │         │          │          │          │ [All items shipped]
     │         │          │          │          │──────────►│─────────►│
     │         │          │          │          │ UPDATE orders SET status='SHIPPED'
     │         │          │          │          │ WHERE id=?
     │         │          │          │          │──────────►│─────────►│
     │         │          │          │          │ end [alt]
     │         │          │          │ commit()  │          │
     │         │          │          │─────────►│──────────►│─────────►│
     │         │◄─────────│◄─────────│◄─────────│          │          │
     │  "发货成功"              │          │          │
     │ shipItem(ItemB)│          │          │          │
     │────────►│ ... same flow ...          │          │
     │         │          │          │          │ count=0 ✓         │
     │         │          │          │          │ Order Status: PAID → SHIPPED
     │◄────────│          │          │          │          │
     │  "发货成功，订单已全部发货完成"        │          │          │
```
## 7. API 设计（字段/示例/Mock）
- 需登录：除登录/注册/商品列表/详情/公告外均需。
- ADMIN：审核、治理、退款审核、公告、用户管理接口。
- 归属校验：goods(卖家)、orders(买家)、order_item(卖家)、address(用户)、message_reply(可选归属)。
- 状态约束示例：
  - /api/orders/{id}/pay：PENDING_PAY→PAID，否则40901。
  - /api/orders/{id}/cancel：PENDING_PAY→CANCELED。
  - /api/seller/order-items/{id}/ship：orders.status=PAID 且 item_status=PAID，seller归属。
  - /api/orders/{id}/confirm：status=SHIPPED→COMPLETED，置 is_settled=1。
  - /api/orders/{id}/refund：status=PAID且未发货→REFUNDING。
  - /api/seller/orders/{id}/refund/approve：REFUNDING→REFUNDED（释放库存，卖家审核）。
  - /api/seller/orders/{id}/refund/reject：REFUNDING→PAID（不释放库存，卖家审核）。
  - /api/admin/orders/{id}/refund/approve：REFUNDING→REFUNDED（释放库存，管理员审核）。
  - /api/admin/orders/{id}/refund/reject：REFUNDING→PAID（不释放库存，管理员审核）。
  - 超时取消幂等实现建议：UPDATE orders SET status='CANCELED' WHERE id=? AND status='PENDING_PAY' [可加 updated_at 条件避免重复扫描]；影响行数=1 才继续释放库存；可选CAS/版本号实现。

### 7.1 分页接口响应格式（统一约定）

所有列表接口（如商品列表、订单列表、评价列表）统一返回：

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "page": 1,
    "size": 10,
    "total": 123,
    "records": []
  }
}
```

### 7.2 搜索接口定义（V1：SQL LIKE）

商品列表/搜索统一使用：GET `/api/goods`

查询参数：
- `keyword`：可选，关键词（采用前缀匹配：title LIKE CONCAT(#{keyword}, '%')）
- `category_id`：可选
- `status`：仅管理员可传（普通用户固定APPROVED）
- `page` / `size`：分页

搜索SQL约定：
- V1 采用前缀匹配（可利用索引）：`title LIKE CONCAT(#{keyword}, '%')`
- 建议创建索引：CREATE INDEX idx_goods_title ON goods(title)

### 7.3 通用响应与错误（强约束）
统一响应外层：
```json
{ "code": 0, "message": "ok", "data": {} }
```

通用错误码（必须前后端硬编码一致）：见第11章。

### 7.4 核心 API 速览表（便于沟通）
| 模块 | 路径 | 方法 | 前置状态/约束 | 权限 |
|---|---|---|---|---|
| 下单 | /api/orders | POST | 库存>=qty；goods=APPROVED；活跃订单≤10 | 登录 |
| 订单列表(管理员) | /api/admin/orders | GET | - | Admin |
| 支付 | /api/orders/{id}/pay | POST | status=PENDING_PAY | Buyer |
| 取消 | /api/orders/{id}/cancel | POST | status=PENDING_PAY | Buyer |
| 发货 | /api/seller/order-items/{id}/ship | POST | orders.status=PAID & item=PAID | Seller |
| 代发货 | /api/admin/order-items/{id}/ship | POST | orders.status=PAID & item=PAID | Admin |
| 收货 | /api/orders/{id}/confirm | POST | status=SHIPPED | Buyer |
| 退款申请 | /api/orders/{id}/refund | POST | status=PAID 且未发货 | Buyer |
| 退款通过 | /api/seller|admin/orders/{id}/refund/approve | POST | status=REFUNDING | Seller/Admin |
| 退款驳回 | /api/seller|admin/orders/{id}/refund/reject | POST | status=REFUNDING | Seller/Admin |
| 评价 | /api/reviews | POST | order.status ∈ {COMPLETED,REFUNDED} | Buyer/Admin |
| 评价回复 | /api/reviews/{id}/reply | POST | review 存在 | Seller/Admin |
| 留言 | /api/messages | POST | goods=APPROVED | 登录 |
| 留言回复 | /api/messages/{id}/replies | POST | message 可见 | 登录 |
| 收藏 | /api/favorites | POST | goods=APPROVED | 登录 |
| 卖家商品 | /api/seller/goods | GET | - | Seller |
| 地址 | /api/addresses | POST | - | 登录 |
| 公告 | /api/notices | GET | - | 公开 |
| 分类 | /api/categories | GET | - | 公开 |
| 用户治理 | /api/admin/users | GET | - | Admin |
| 评价治理 | /api/admin/reviews | GET | - | Admin |
| 审计日志 | /api/admin/audit-logs | GET | - | Admin |

### 7.5 Auth（登录/注册）
| 接口 | 方法 | 说明 | 权限 |
|---|---|---|---|
| /api/auth/register | POST | 注册 | 公开 |
| /api/auth/login | POST | 登录 | 公开 |
| /api/auth/me | GET | 当前用户信息 | 登录 |

请求体：POST /api/auth/register
| 字段 | 类型 | 必填 | 约束 |
|---|---|---|---|
| username | string | 是 | 3-32；唯一 |
| password | string | 是 | 6-32；后端存 password_hash（BCrypt） |
| nick_name | string | 否 | 0-32 |

响应示例：POST /api/auth/login
```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "access_token": "jwt...",
    "token_type": "Bearer",
    "expires_in": 86400,
    "user": { "id": 1, "username": "u1", "nick_name": "小明", "avatar_url": "/static/files/xxx.png" }
  }
}
```

### 7.6 Upload（图片上传）
| 接口 | 方法 | Content-Type | 权限 |
|---|---|---|---|
| /api/upload | POST | multipart/form-data | 登录 |

表单字段：
| 字段 | 类型 | 必填 | 约束 |
|---|---|---|---|
| file | file | 是 | jpg/png/webp；<=20MB；服务端生成 UUID 文件名 |

响应示例：
```json
{ "code": 0, "message": "ok", "data": { "url": "/static/files/2f6e...a3.webp" } }
```

### 7.7 Goods（商品）
| 接口 | 方法 | 说明 | 权限 |
|---|---|---|---|
| /api/goods | GET | 商品列表/搜索 | 公开（仅 APPROVED）/管理员可看全量 |
| /api/seller/goods | GET | 我发布的商品列表 | 登录（seller=当前用户） |
| /api/goods/{id} | GET | 商品详情 | 公开（仅 APPROVED）/归属或管理员可看非公开 |
| /api/goods | POST | 创建商品 | 登录（seller=当前用户） |
| /api/goods/{id} | PUT | 编辑商品 | seller归属或ADMIN |
| /api/goods/{id}/submit | POST | 提交审核 | seller归属或ADMIN |
| /api/goods/{id}/offline | POST | 下架 | seller归属或ADMIN |
| /api/admin/goods/{id}/approve | POST | 审核通过 | ADMIN |
| /api/admin/goods/{id}/reject | POST | 审核驳回 | ADMIN |

说明：`/api/seller/goods` 返回当前登录用户 seller_id 的全部商品（包含 DRAFT/PENDING/REJECTED/OFFLINE/APPROVED）。

请求体：POST /api/goods
| 字段 | 类型 | 必填 | 约束 |
|---|---|---|---|
| title | string | 是 | 1-80 |
| category_id | long | 是 | 必须存在 |
| price | decimal | 是 | >=0 |
| stock | int | 是 | >=0 |
| image_urls | string[] | 否 | 由 /api/upload 返回的 URL 数组，支持多张图片，不限制数量。上传时的数组顺序即为 sort_order（0,1,2...）；编辑时全量覆盖；支持部分更新（需传入完整数组） |
| detail | string | 否 | 富文本/Markdown 均可，V1 不做 XSS 防护需谨慎 |
| submit | boolean | 否 | true 表示创建后直接进入 PENDING；false/缺省进入 DRAFT |

### 7.8 Cart（购物车）
| 接口 | 方法 | 说明 | 权限 |
|---|---|---|---|
| /api/cart | GET | 购物车列表 | 登录 |
| /api/cart | POST | 加入购物车 | 登录 |
| /api/cart/{id} | PUT | 改数量 | 登录（归属） |
| /api/cart/{id} | DELETE | 删除项 | 登录（归属） |

请求体：POST /api/cart
| 字段 | 类型 | 必填 | 约束 |
|---|---|---|---|
| goods_id | long | 是 | 必须存在；且 goods.status=APPROVED |
| qty | int | 是 | >=1 |

### 7.9 Orders（订单：拆单、支付、取消、收货、退款）
| 接口 | 方法 | 说明 | 权限 |
|---|---|---|---|
| /api/orders | POST | 创建订单（按卖家拆单） | 登录（buyer=当前用户） |
| /api/orders | GET | 我的订单列表 | 登录（buyer=当前用户） |
| /api/admin/orders | GET | 订单列表（管理员） | ADMIN |
| /api/orders/{id} | GET | 订单详情 | 登录（buyer=当前用户 或 seller=当前用户 或 ADMIN） |
| /api/orders/{id}/pay | POST | 模拟支付 | 登录（buyer=当前用户） |
| /api/orders/{id}/cancel | POST | 取消订单 | 登录（buyer=当前用户） |
| /api/orders/{id}/confirm | POST | 确认收货 | 登录（buyer=当前用户） |
| /api/orders/{id}/refund | POST | 申请退款 | 登录（buyer=当前用户） |
| /api/seller/orders/{id}/refund/approve | POST | 退款通过（卖家审核） | 登录（seller归属） |
| /api/seller/orders/{id}/refund/reject | POST | 退款驳回（卖家审核） | 登录（seller归属） |
| /api/admin/orders/{id}/refund/approve | POST | 退款通过（管理员审核） | ADMIN |
| /api/admin/orders/{id}/refund/reject | POST | 退款驳回（管理员审核） | ADMIN |

#### 7.9.1 退款审核接口归属（避免歧义）
- “退款审核”属于订单域能力，因此接口归类在 Orders 模块下（尽管卖家也可审核）。
- 卖家审核接口使用 `/api/seller/orders/...` 前缀，仅表示“当前登录人以卖家身份审核”，并不影响管理员审核接口。

请求体：POST /api/orders
```json
{
  "address_id": 1,
  "items": [
    { "goods_id": 101, "qty": 1 },
    { "goods_id": 202, "qty": 2 }
  ]
}
```

请求体：POST /api/orders/{id}/refund
```json
{
  "reason": "未发货想取消/卖家沟通无回应"
}
```
说明：
- reason 必填；当第 3 次申请退款自动转争议时，该 reason 会写入 dispute.reason。

响应示例（拆单结果）：
```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "order_count": 2,
    "orders": [
      { "order_id": 1001, "order_no": "O202601270001", "seller_id": 11, "amount": 88.00, "status": "PENDING_PAY" },
      { "order_id": 1002, "order_no": "O202601270002", "seller_id": 22, "amount": 39.90, "status": "PENDING_PAY" }
    ]
  }
}
```

响应示例：GET /api/orders（订单列表）
```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "page": 1,
    "size": 10,
    "total": 2,
    "records": [
      {
        "order_id": 1001,
        "order_no": "O202601270001",
        "seller_id": 11,
        "total_amount": 88.00,
        "status": "PENDING_PAY",
        "created_at": "2026-01-27T12:00:00",
        "updated_at": "2026-01-27T12:00:00"
      },
      {
        "order_id": 1002,
        "order_no": "O202601270002",
        "seller_id": 22,
        "total_amount": 39.90,
        "status": "PAID",
        "created_at": "2026-01-27T12:05:00",
        "updated_at": "2026-01-27T12:06:00"
      }
    ]
  }
}
```
说明：订单列表**不返回物流字段**（ship_company/tracking_no/ship_time），物流信息仅在订单详情接口返回。
若 status=CANCELED，订单详情响应应包含 `cancel_reason`（TIMEOUT/MANUAL）。
管理员列表补充：GET /api/admin/orders 支持筛选参数（示例：status、buyer_id、seller_id、order_no、created_at_range）。

响应示例：GET /api/orders/{id}（订单详情）
```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "order_id": 1002,
    "order_no": "O202601270002",
    "buyer_id": 5,
    "seller_id": 22,
    "status": "SHIPPED",
    "total_amount": 39.90,
    "shipping_fee": 0.00,
    "receiver_name": "张三",
    "receiver_phone": "138****1234",
    "receiver_full_address": "北京市朝阳区XXX",
    "items": [
      {
        "order_item_id": 5001,
        "goods_id": 101,
        "goods_title": "二手键盘",
        "goods_cover": "/static/files/xx.png",
        "price": 39.90,
        "quantity": 1,
        "amount": 39.90,
        "item_status": "SHIPPED",
        "ship_company": "顺丰",
        "tracking_no": "SF123456789",
        "ship_time": "2026-01-27T15:30:00"
      }
    ],
    "created_at": "2026-01-27T12:05:00",
    "updated_at": "2026-01-27T15:30:00"
  }
}
```

退款申请补充说明（无歧义）：
- 若 `refund_request_count < 2`：/api/orders/{id}/refund 正常进入 REFUNDING；
- 若 `refund_request_count >= 2`：第 3 次申请退款时，系统**自动创建争议记录**并将订单状态置为 DISPUTED，返回 dispute_id（前端不再展示“申请退款”，改为“查看争议”）。

### 7.10 Seller（卖家发货）
| 接口 | 方法 | 说明 | 权限 |
|---|---|---|---|
| /api/seller/orders | GET | 我卖出的订单列表 | 登录（seller=当前用户） |
| /api/seller/order-items/{id}/ship | POST | 订单项发货 | 登录（seller归属） |

### 7.10.1 Admin（管理员代发货）
| 接口 | 方法 | 说明 | 权限 |
|---|---|---|---|
| /api/admin/order-items/{id}/ship | POST | 管理员代替卖家发货 | ADMIN |

### 7.11 Reviews（评价）
| 接口 | 方法 | 说明 | 权限 |
|---|---|---|---|
| /api/reviews | POST | 创建评价（一次写入） | 登录；(buyer归属 或 ADMIN)；order 状态约束见8.6 |
| /api/reviews/my | GET | 我的评价 | 登录 |
| /api/reviews/goods/{goodsId} | GET | 商品评价列表 | 公开 |
| /api/reviews/{id}/reply | POST | 卖家/管理员回复 | 登录；(seller归属 或 ADMIN) |

### 7.12 Message（留言/回复）
> 定位：商品详情页的“留言板”，用于买家提问、交流。V1 仅做两层结构：message（主留言）+ message_reply（回复），不做“回复的回复”。

| 接口 | 方法 | 说明 | 权限 |
|---|---|---|---|
| /api/messages | POST | 对某商品发布留言 | 登录 |
| /api/goods/{goodsId}/messages | GET | 某商品留言列表（含回复） | 公开（仅展示可见） |
| /api/messages/{id}/replies | POST | 回复某条留言 | 登录 |
| /api/admin/messages | GET | 留言列表（治理） | ADMIN |
| /api/admin/message-replies | GET | 留言回复列表（治理） | ADMIN |
| /api/admin/messages/{id}/hide | POST | 隐藏留言 | ADMIN |
| /api/admin/messages/{id}/delete | POST | 删除留言 | ADMIN |
| /api/admin/message-replies/{id}/hide | POST | 隐藏回复 | ADMIN |
| /api/admin/message-replies/{id}/delete | POST | 删除回复 | ADMIN |

归属/权限口径（无歧义，V1）：
- 创建留言：仅需登录；**不限制归属**（任何登录用户均可对任意商品留言）。
- 创建回复：仅需登录；**不限制归属**（任何登录用户均可回复任意留言）。
- message.user_id 与 message_reply.replier_id **由后端从当前登录用户写入**（前端不得传 user_id/replier_id）。
- 管理员治理（hide/delete）：不受归属限制。

请求体：POST /api/messages
```json
{ "goods_id": 101, "content": "请问成色如何？" }
```

请求体：POST /api/messages/{id}/replies
```json
{ "content": "9新，功能正常，可私聊要更多图片。" }
```

响应示例：创建留言（POST /api/messages）
```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "message_id": 3001,
    "goods_id": 101,
    "user_id": 5,
    "content": "请问成色如何？",
    "status": "visible",
    "created_at": "2026-01-27T12:00:00"
  }
}
```

留言区 UI（改进版 ASCII 原型）
```
[留言板]
------------------------------------------------------------
张三  2026-01-27 12:00   (楼层 #1)
请问成色如何？
[回复]
  └─ 李四（卖家） 12:05: 9成新，功能正常，可面交。
  └─ 管理员 12:10: 提醒双方注意交易安全。
------------------------------------------------------------
王五  2026-01-27 12:30   (楼层 #2)
还能小刀吗？
[回复]
  └─ 李四（卖家） 12:32: 价格已很实惠了，谢谢。
  └─ 赵六（用户）[已购买家] 12:40: 同款我买过，物超所值。
------------------------------------------------------------
分页: < 1 2 3 >   [筛选: 全部 ▼] [已购买家的留言]
```

【说明】
• [已购买家] 标签：显示在该买家用户ID后面，表示该用户已购买此商品
• 筛选功能：支持按"已购买家的留言"筛选，查看真实买家反馈
• 判断逻辑：**采用实时JOIN查询方案**，查询留言时 LEFT JOIN order_item 与 orders，判断是否存在 goods_id 匹配且
  - order_item.status ∈ {PAID, SHIPPED, COMPLETED}
  - **orders.status ∈ {PAID, SHIPPED, COMPLETED}**（排除 REFUNDING/REFUNDED/DISPUTED）
• 数据库设计：message.is_purchased 字段保留但设为默认值0，不主动维护该字段，由查询时实时计算
• V1方案理由：数据量不大，实时JOIN性能可接受，且保证数据永远准确，无需额外维护字段更新逻辑

### 7.13 Dispute（争议处理）
> 争议处理机制：买家申请退款被驳回 2 次后，系统强制要求走争议处理流程，由管理员进行最终裁决。

| 接口 | 方法 | 说明 | 权限/校验 |
|---|---|---|---|
| /api/disputes | POST | 发起争议（系统自动触发/内部调用） | 登录；buyer归属；该订单退款申请被驳回次数=2（**前端不暴露此接口**） |
| /api/disputes/{id} | GET | 争议详情 | 登录；applicant归属 或 ADMIN |
| /api/admin/disputes | GET | 争议列表（筛选） | ADMIN |
| /api/admin/disputes/{id}/resolve | POST | 管理员裁决 | ADMIN；resolution=REFUND（退款）或 COMPLETE（完成交易） |

请求体：POST /api/disputes
```json
{
  "order_id": 1001,
  "reason": "卖家拒绝退款，商品与描述不符"
}
```
说明：该接口为**系统内部自动调用**（第3次申请退款时自动创建争议），前端不直接调用。

请求体：POST /api/admin/disputes/{id}/resolve
```json
{
  "resolution": "REFUND",  // 或 "COMPLETE"
  "admin_note": "经核查，买家描述属实，支持退款"
}
```

争议处理业务逻辑：
- **触发条件**：买家对同一订单申请退款达到 2 次并被驳回后，第 3 次申请退款时**系统自动创建争议**
- **状态流转**：PAID → DISPUTED（争议中）→ REFUNDED（退款）或 COMPLETED（完成）
- **管理员权限**：管理员拥有最高权限，可随时介入任何争议进行裁决
- **无时效限制**：争议处理无时间限制，直到管理员做出最终裁决
- **自动退款**：管理员裁决 REFUND 后，订单状态自动更新为 REFUNDED，并释放库存
- **退款次数清零**：管理员裁决后（无论退款还是完成交易），refund_request_count 清零。避免影响后续可能重新申请退款的计数

响应示例：POST /api/disputes
```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "dispute_id": 1001,
    "order_id": 1003,
    "order_no": "O202601270003",
    "applicant_id": 5,
    "applicant_type": "BUYER",
    "reason": "卖家拒绝退款，商品与描述不符",
    "status": "PENDING",
    "created_at": "2026-01-27T12:00:00"
  }
}
```

响应示例：GET /api/disputes/{id}
```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "dispute_id": 1001,
    "order_id": 1003,
    "order_no": "O202601270003",
    "buyer_id": 5,
    "buyer_name": "张三",
    "seller_id": 10,
    "seller_name": "李四",
    "goods_id": 101,
    "goods_title": "二手 iPhone 13 128G",
    "amount": 3999.00,
    "applicant_id": 5,
    "applicant_type": "BUYER",
    "reason": "卖家拒绝退款，商品与描述不符",
    "status": "PENDING",
    "refund_request_count": 2,
    "refund_history": [
      {
        "apply_time": "2026-01-26T10:00:00",
        "reject_time": "2026-01-26T11:00:00",
        "reject_reason": "商品符合描述",
        "reviewer": "卖家李四"
      },
      {
        "apply_time": "2026-01-26T18:00:00",
        "reject_time": "2026-01-26T19:00:00",
        "reject_reason": "买家原因",
        "reviewer": "管理员admin"
      }
    ],
    "created_at": "2026-01-27T12:00:00",
    "resolved_at": null
  }
}
```

响应示例：GET /api/admin/disputes（管理员争议列表）
```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "page": 1,
    "size": 10,
    "total": 25,
    "records": [
      {
        "dispute_id": 1001,
        "order_id": 1003,
        "order_no": "O202601270003",
        "buyer_name": "张三",
        "seller_name": "李四",
        "goods_title": "二手 iPhone 13 128G",
        "amount": 3999.00,
        "applicant_type": "BUYER",
        "reason": "卖家拒绝退款，商品与描述不符",
        "status": "PENDING",
        "refund_request_count": 2,
        "created_at": "2026-01-27T12:00:00"
      },
      {
        "dispute_id": 1002,
        "order_id": 1004,
        "order_no": "O202601270004",
        "buyer_name": "王五",
        "seller_name": "赵六",
        "goods_title": "二手 MacBook Pro 2021",
        "amount": 8999.00,
        "applicant_type": "BUYER",
        "reason": "商品质量问题，卖家不同意退款",
        "status": "PENDING",
        "refund_request_count": 2,
        "created_at": "2026-01-27T14:30:00"
      }
    ]
  }
}
```

响应示例：POST /api/admin/disputes/{id}/resolve
```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "dispute_id": 1001,
    "order_id": 1003,
    "resolution": "REFUND",
    "admin_note": "经核查，买家描述属实，支持退款",
    "resolved_at": "2026-01-27T15:00:00"
  }
}
```

### 7.14 Favorite（收藏）
| 接口 | 方法 | 说明 | 权限 |
|---|---|---|---|
| /api/favorites | GET | 我的收藏列表 | 登录 |
| /api/favorites | POST | 收藏商品 | 登录 |
| /api/favorites/{id} | DELETE | 取消收藏 | 登录（归属） |
| /api/favorites/goods/{goodsId} | DELETE | 按商品取消收藏 | 登录（归属） |

请求体：POST /api/favorites
```json
{ "goods_id": 101 }
```

响应建议（GET /api/favorites）：
- 必须返回 `favorite_id`，便于前端使用 `/api/favorites/{id}` 删除；
- 同时支持 `/api/favorites/goods/{goodsId}` 便于直接用商品维度取消收藏。

### 7.14 Address（地址管理）
| 接口 | 方法 | 说明 | 权限 |
|---|---|---|---|
| /api/addresses | GET | 地址列表 | 登录 |
| /api/addresses | POST | 新增地址 | 登录 |
| /api/addresses/{id} | PUT | 编辑地址 | 登录（归属） |
| /api/addresses/{id} | DELETE | 删除地址 | 登录（归属） |
| /api/addresses/{id}/default | POST | 设为默认 | 登录（归属） |

### 7.15 Notice（公告）
| 接口 | 方法 | 说明 | 权限 |
|---|---|---|---|
| /api/notices | GET | 公告列表 | 公开 |
| /api/notices/{id} | GET | 公告详情 | 公开 |
| /api/admin/notices | POST | 发布公告 | ADMIN |
| /api/admin/notices/{id} | PUT | 编辑公告 | ADMIN |
| /api/admin/notices/{id}/publish | POST | 发布 | ADMIN |
| /api/admin/notices/{id}/offline | POST | 下架 | ADMIN |

### 7.16 Category（分类）
| 接口 | 方法 | 说明 | 权限 |
|---|---|---|---|
| /api/categories | GET | 分类列表 | 公开 |
| /api/admin/categories | POST | 新增分类 | ADMIN |
| /api/admin/categories/{id} | PUT | 编辑分类 | ADMIN |
| /api/admin/categories/{id} | DELETE | 删除分类 | ADMIN |

### 7.17 Admin Users（用户管理）
| 接口 | 方法 | 说明 | 权限 |
|---|---|---|---|
| /api/admin/users | GET | 用户列表 | ADMIN |
| /api/admin/users/{id}/disable | POST | 禁用用户 | ADMIN |
| /api/admin/users/{id}/enable | POST | 启用用户 | ADMIN |
| /api/admin/users/{id}/reset-password | POST | 重置密码为默认值 | ADMIN |

### 7.18 Admin Reviews（评价治理）
| 接口 | 方法 | 说明 | 权限 |
|---|---|---|---|
| /api/admin/reviews | GET | 评价列表 | ADMIN |
| /api/admin/reviews/{id}/hide | POST | 隐藏评价 | ADMIN |
| /api/admin/reviews/{id}/delete | POST | 删除评价 | ADMIN（软删） |

### 7.19 消息中心（拼接展示）
> V1 不单独建表；消息中心由「买家/卖家订单状态变更 + 公告列表」拼接展示。
| 接口 | 方法 | 说明 | 权限 |
|---|---|---|---|
| /api/orders | GET | 买家订单列表 | 登录（买家） |
| /api/seller/orders | GET | 卖家订单列表 | 登录（卖家） |
| /api/notices | GET | 公告列表 | 公开 |

前端拼接说明：
- 买家视角：取 /api/orders（按 updated_at 倒序）+ /api/notices（按 published_at 倒序）合并展示；
- 卖家视角：取 /api/seller/orders（按 updated_at 倒序）+ /api/notices 合并展示；
- 不建消息表，消息中心仅展示拼接结果。

### 7.20 Audit Log（审计日志）
| 接口 | 方法 | 说明 | 权限 |
|---|---|---|---|
| /api/admin/audit-logs | GET | 审计日志列表 | ADMIN |
| /api/admin/audit-logs/{id} | GET | 审计详情 | ADMIN |

查询建议参数：
- `order_id`：按订单筛选
- `action`：按操作类型筛选（如 REFUND_APPROVE / SHIP_BY_ADMIN / GOODS_APPROVE）
- `operator_id`：按操作者筛选

---

## 8. 状态约束表（API × 状态 × 副作用）

> 说明：本章是“后端状态机校验 + 前端按钮显隐/禁用”的唯一来源。

### 8.1 订单主单（orders）状态约束表
| API | 方法 | 允许的当前状态 | 目标状态 | 归属/权限 | 关键副作用（必须做/必须不做） |
|---|---|---|---|---|---|
| /api/orders | POST | - | PENDING_PAY | 登录；buyer=当前用户 | 事务：条件扣库存；按 seller_id 拆单；落库 orders+order_items（order_item.order_status=PENDING_PAY） |
| /api/orders/{id}/pay | POST | PENDING_PAY | PAID | 登录；buyer=当前用户 | 设置 pay_time；将该订单下 order_items.item_status 从 PENDING_PAY 批量置为 PAID；同步 order_item.order_status=PAID；不得再次扣库存 |
| /api/orders/{id}/cancel | POST | PENDING_PAY | CANCELED | 登录；buyer=当前用户 | 释放库存（幂等）；同步 order_item.order_status=CANCELED；不得取消已支付 |
| /api/orders/{id}/confirm | POST | SHIPPED | COMPLETED | 登录；buyer=当前用户 | is_settled=1；settled_time=now；批量更新 order_items.item_status=COMPLETED；同步 order_item.order_status=COMPLETED |
| /api/orders/{id}/refund | POST | PAID | REFUNDING / DISPUTED | 登录；buyer=当前用户 | 必须校验“未发货”；若 refund_request_count>=2，则自动创建 dispute 并将订单置为 DISPUTED；同步 order_item.order_status |
| /api/seller/orders/{id}/refund/approve | POST | REFUNDING | REFUNDED | 登录；seller=orders.seller_id | 幂等：条件 UPDATE（WHERE status='REFUNDING'），affected_rows=1 才释放库存；同步 order_item.order_status=REFUNDED；记录审核人/时间 |
| /api/seller/orders/{id}/refund/reject | POST | REFUNDING | PAID | 登录；seller=orders.seller_id | 幂等：条件 UPDATE（WHERE status='REFUNDING'），affected_rows=1 才回退状态；同步 order_item.order_status=PAID；**refund_request_count +1**；不释放库存；记录审核人/时间 |
| /api/admin/orders/{id}/refund/approve | POST | REFUNDING | REFUNDED | ADMIN | 幂等：条件 UPDATE（WHERE status='REFUNDING'），affected_rows=1 才释放库存；同步 order_item.order_status=REFUNDED；记录审核人/时间 |
| /api/admin/orders/{id}/refund/reject | POST | REFUNDING | PAID | ADMIN | 幂等：条件 UPDATE（WHERE status='REFUNDING'），affected_rows=1 才回退状态；同步 order_item.order_status=PAID；**refund_request_count +1**；不释放库存；记录审核人/时间 |

### 8.2 订单项（order_item）状态约束表（V1）
| API | 方法 | 允许的当前状态 | 目标状态 | 归属/权限 | 关键副作用 |
|---|---|---|---|---|---|
| /api/seller/order-items/{id}/ship | POST | PAID | SHIPPED | 登录；orders.status=PAID 且 item_status=PAID 且 seller=orders.seller_id | 写入物流字段（V1 可选空）；可能触发 orders 聚合→SHIPPED；如主单状态变更，需同步 order_item.order_status=SHIPPED |
| /api/admin/order-items/{id}/ship | POST | PAID | SHIPPED | ADMIN；orders.status=PAID 且 item_status=PAID（无 seller 归属限制） | 同上；并记录“管理员代发货”审计日志（含 admin_id、reason 可选） |

备注（无歧义）：
- 若 orders.status 已变为 REFUNDING/REFUNDED/DISPUTED，则 **不允许发货**（即使 item_status 仍为 PAID）。
- **此限制同时适用于卖家发货和管理员代发货**（两类接口均需校验 orders.status）。
- DISPUTED（争议中）状态需等待管理员裁决后，才能继续后续操作。

### 8.3 “退款审核人”口径（避免歧义）
V1 口径（已确认，避免歧义）：
- **卖家审核接口**：`/api/seller/orders/{id}/refund/approve` 与 `/api/seller/orders/{id}/refund/reject`
  - 仅允许 `orders.seller_id = 当前用户` 的卖家操作。
- **管理员审核接口**：`/api/admin/orders/{id}/refund/approve` 与 `/api/admin/orders/{id}/refund/reject`
  - 仅允许 ADMIN 操作，可审核任意订单退款申请。

说明：
- 卖家与管理员**接口路径分离**，避免"路径是 admin 但卖家能调"的语义混乱。
- 两类审核的业务副作用一致（状态机与库存口径一致），仅权限范围不同。

### 8.4 Dispute（争议处理）状态约束表
> 争议处理：买家申请退款被驳回 2 次后强制走争议流程，由管理员进行最终裁决。

| API | 方法 | 允许的当前状态 | 目标状态 | 归属/权限 | 关键副作用 |
|---|---|---|---|---|---|
| /api/disputes | POST | PAID | DISPUTED | 登录；buyer归属 | 系统自动触发创建争议（第3次申请退款时）；记录退款申请次数 |
| /api/disputes/{id} | GET | DISPUTED | - | 登录；applicant归属 或 ADMIN | 只读；显示争议详情 |
| /api/admin/disputes/{id}/resolve | POST | DISPUTED | REFUNDED/COMPLETED | ADMIN | resolution=REFUND（退款）或 COMPLETE（完成交易）；订单状态同步更新；同步 order_item.order_status |
| /api/admin/disputes | GET | - | - | ADMIN | 支持分页与筛选（order_id/status）；按 created_at 倒序 |

**争议处理业务逻辑**：
- **触发条件**：买家对同一订单申请退款达到 2 次并被驳回后，第 3 次申请时系统自动转为争议处理
- **状态流转**：PAID → DISPUTED（争议中）→ REFUNDED（管理员裁决退款）或 COMPLETED（管理员裁决完成交易）
- **管理员最高权限**：管理员可随时介入任何争议状态，直接进行最终裁决
- **无时效限制**：争议处理无时间限制，直到管理员做出最终裁决
- **自动处理**：管理员裁决后，订单状态自动更新，并同步 order_item.order_status
- **前端口径**：不提供“发起争议”按钮，仅在 DISPUTED 状态显示“查看争议”

**退款申请次数统计**：
- 在 orders 表或单独的 refund_request_count 字段记录每个订单的退款申请次数
- 每次退款申请驳回时 +1，达到 2 次后，第 3 次申请时强制创建争议记录
- 管理员裁决后，退款申请次数清零（V1 口径：不保留历史次数用于统计）

### 8.5 商品（goods）状态约束表（审核/上下架）
| API | 方法 | 允许的当前状态 | 目标状态 | 归属/权限 |
|---|---|---|---|---|
| /api/goods | POST | - | DRAFT 或 PENDING | 登录；seller=当前用户 |
| /api/goods/{id} | PUT | DRAFT/REJECTED/OFFLINE | DRAFT | seller归属或ADMIN |
| /api/goods/{id}/submit | POST | DRAFT/REJECTED/OFFLINE | PENDING | seller归属或ADMIN |
| /api/admin/goods/{id}/approve | POST | PENDING | APPROVED | ADMIN |
| /api/admin/goods/{id}/reject | POST | PENDING | REJECTED | ADMIN（需 audit_reason） |
| /api/goods/{id}/offline | POST | APPROVED | OFFLINE | seller归属或ADMIN |

### 8.6 评价（review）状态约束表
| API | 方法 | 前置条件 | 归属/权限 | 约束/副作用 |
|---|---|---|---|---|
| /api/reviews | POST | order.status ∈ {COMPLETED, REFUNDED}；订单完成后30天内 | 登录；(buyer=当前用户 或 ADMIN) | UNIQUE(order_item_id)；若已评价则返回 40901（不允许修改）；超期返回 40001 |
| /api/reviews/{id}/reply | POST | review 存在 | 登录；(seller=order_item.seller_id 或 ADMIN) | 写入 seller_reply/reply_time |

**评价时限说明**：
- 订单完成后30天内可评价：COMPLETED订单从completed_at计算，REFUNDED订单从refunded_at计算
- 超过30天未评价，系统不再接受评价申请（V1不做自动好评）
- 管理员创建评价不受30天时限限制（仅用于测试/演示）

**管理员评价权限说明**：
- V1 阶段允许管理员代替买家创建评价，主要用于测试/演示场景
- 生产环境应限制为仅买家可评价，可在 V2 中移除管理员的评价权限
- 管理员创建评价时需明确标注，便于后续审核和区分

### 8.7 Message（留言/回复）状态约束表
> 说明：留言/回复属于“内容互动”，不参与订单状态机；但需要明确“可见/隐藏/删除”的治理口径。

V1 口径（无歧义）：
- delete 为**软删除**：将 status 置为 `deleted`，不做物理删除。
- 客户端列表接口仅返回 status=`visible` 的留言/回复；hidden/deleted 不对普通用户展示。

| API | 方法 | 允许的当前状态 | 目标状态 | 归属/权限 | 约束/副作用 |
|---|---|---|---|---|---|
| /api/messages | POST | - | 可见 | 登录 | 写入 user_id=当前用户；goods_id 必须存在且 goods.status=APPROVED |
| /api/messages/{id}/replies | POST | - | 可见 | 登录 | 写入 replier_id=当前用户；message_id 必须存在且为“可见” |
| /api/admin/messages/{id}/hide | POST | 可见 | 隐藏 | ADMIN | 状态更新；记录操作人/时间 |
| /api/admin/messages/{id}/delete | POST | 可见/隐藏 | 删除 | ADMIN | **软删除（V1 口径）**：status=deleted；记录操作人/时间 |
| /api/admin/message-replies/{id}/hide | POST | 可见 | 隐藏 | ADMIN | 状态更新；记录操作人/时间 |
| /api/admin/message-replies/{id}/delete | POST | 可见/隐藏 | 删除 | ADMIN | **软删除（V1 口径）**：status=deleted；记录操作人/时间 |

### 8.8 Favorite（收藏）状态约束表
| API | 方法 | 前置条件 | 归属/权限 | 约束/副作用 |
|---|---|---|---|---|
| /api/favorites | POST | goods.status=APPROVED | 登录 | 写入 user_id=当前用户；UNIQUE(user_id,goods_id) |
| /api/favorites/{id} | DELETE | 收藏存在 | 登录（归属） | 删除收藏 |
| /api/favorites/goods/{goodsId} | DELETE | 收藏存在 | 登录（归属） | 根据 goods_id 删除收藏 |
| /api/favorites | GET | - | 登录 | 返回 favorite_id + goods_id 便于删除 |

### 8.9 Address（地址）状态约束表
| API | 方法 | 前置条件 | 归属/权限 | 约束/副作用 |
|---|---|---|---|---|
| /api/addresses | POST | - | 登录 | 写入 user_id=当前用户 |
| /api/addresses/{id} | PUT/DELETE | 地址存在 | 登录（归属） | 仅操作自己的地址 |
| /api/addresses/{id}/default | POST | 地址存在 | 登录（归属） | 先清空其他默认，再设为默认 |

### 8.10 Notice（公告）状态约束表
| API | 方法 | 允许状态 | 目标状态 | 权限 | 约束/副作用 |
|---|---|---|---|---|---|
| /api/admin/notices | POST | - | DRAFT | ADMIN | 创建草稿 |
| /api/admin/notices/{id}/publish | POST | DRAFT/OFFLINE | PUBLISHED | ADMIN | 写 published_at |
| /api/admin/notices/{id}/offline | POST | PUBLISHED | OFFLINE | ADMIN | 下架 |

### 8.11 Category（分类）状态约束表
| API | 方法 | 前置条件 | 权限 | 约束/副作用 |
|---|---|---|---|---|
| /api/admin/categories | POST | - | ADMIN | 新增分类 |
| /api/admin/categories/{id} | PUT/DELETE | 分类存在 | ADMIN | **强制校验无商品引用**；有引用则拒绝删除并返回 40901 |

### 8.12 Admin Users（用户管理）状态约束表
| API | 方法 | 前置条件 | 权限 | 约束/副作用 |
|---|---|---|---|---|
| /api/admin/users/{id}/disable | POST | user存在 | ADMIN | user.status=DISABLED；**禁用前必须检查订单状态**（见下方规则） |
| /api/admin/users/{id}/enable | POST | user存在 | ADMIN | user.status=ACTIVE |
| /api/admin/users/{id}/reset-password | POST | user存在 | ADMIN | 重置为默认密码（见第11章配置项 admin.reset.default-password） |

禁用卖家账号的强制规则（V1 口径，必须落实到接口层）：
- 若该卖家存在 **SHIPPED/COMPLETED** 订单：**禁止禁用**，返回 40901（状态冲突）
- 若存在 **PAID 且未发货**订单：自动退款（PAID→REFUNDED），释放库存
- 若存在 **PENDING_PAY** 订单：自动取消并释放库存
- 若存在 **REFUNDING/DISPUTED** 订单：**禁止禁用**，待退款/争议处理完成后再禁用
- 禁用前需汇总检查（可在 AdminUserService 中统一处理）

### 8.13 Admin Reviews（评价治理）状态约束表
| API | 方法 | 允许状态 | 目标状态 | 权限 | 约束/副作用 |
|---|---|---|---|---|---|
| /api/admin/reviews/{id}/hide | POST | visible | hidden | ADMIN | status 更新 |
| /api/admin/reviews/{id}/delete | POST | visible/hidden | deleted | ADMIN | 软删除 |

### 8.14 Audit Log（审计日志）状态约束表
| API | 方法 | 前置条件 | 权限 | 约束/副作用 |
|---|---|---|---|---|
| /api/admin/audit-logs | GET | - | ADMIN | 支持分页与筛选（order_id/action/operator_id）；只读 |
| /api/admin/audit-logs/{id} | GET | 日志存在 | ADMIN | 只读 |

---

## 9. 前端交互规格（按钮显隐/禁用矩阵 + 页面 ASCII 原型）

> 原则：前端按钮规则必须与第8章“状态约束表”一致；否则会出现“前端能点、后端报409”的体验问题。

### 9.1 订单主单（买家侧）按钮矩阵
| 订单状态 | 去支付 | 取消订单 | 申请退款 | 确认收货 | 查看争议 | 备注 |
|---|---|---|---|---|---|---|
| PENDING_PAY | 显示/可点 | 显示/可点 | 隐藏 | 隐藏 | 隐藏 | 强提示"15分钟未支付自动取消" |
| PAID | 隐藏 | 隐藏 | 显示/可点（未发货） | 隐藏 | 隐藏 | 若任一订单项已 SHIPPED，则"申请退款"禁用并提示 |
| REFUNDING | 隐藏 | 隐藏 | 显示/禁用 | 隐藏 | 隐藏 | 展示"退款审核中"；第2次驳回后下次申请自动转争议 |
| DISPUTED | 隐藏 | 隐藏 | 隐藏 | 隐藏 | 显示/可点 | 争议处理中，等待管理员最终裁决 |
| REFUNDED | 隐藏 | 隐藏 | 隐藏 | 隐藏 | 隐藏 | 允许进入评价入口（见第13章） |
| SHIPPED | 隐藏 | 隐藏 | 隐藏 | 显示/可点 | 隐藏 | 查看订单详情（仅在详情内展示可选物流字段） |
| COMPLETED | 隐藏 | 隐藏 | 隐藏 | 隐藏 | 隐藏 | 允许评价（见第13章） |
| CANCELED | 隐藏 | 隐藏 | 隐藏 | 隐藏 | 隐藏 | 展示取消原因（超时/手动） |

### 9.2 订单项（卖家侧）按钮矩阵
| 订单状态 | 订单项状态 | 发货按钮 | 备注 |
|---|---|---|---|
| PAID | PAID | 显示/可点 | 发货后该项变 SHIPPED |
| PAID | SHIPPED/COMPLETED | 隐藏 | 不可重复发货 |
| REFUNDING/REFUNDED | 任意 | 隐藏 | V1 退款通过后不得再发货 |
| DISPUTED | 任意 | 隐藏 | 争议处理中，等待管理员最终裁决 |
| SHIPPED/COMPLETED | 任意 | 隐藏 | 主单已聚合发货/完成 |

管理员后台（代发货）：
- 在订单详情页（ADMIN 可见）提供"代发货"按钮，调用 `/api/admin/order-items/{id}/ship`。

**争议处理交互说明**：
- 争议由系统自动触发，无需"发起争议"按钮
- 当 `refund_request_count=2` 时，第3次申请退款系统自动创建 dispute 记录并更新订单状态为 DISPUTED
- 买家在 DISPUTED 状态下可点击"查看争议"按钮查看争议详情
- 管理员在后台可查看所有待处理争议并进行裁决
- 管理员裁决后，订单状态自动变更为 REFUNDED 或 COMPLETED，`refund_request_count` 清零

### 9.3 商品详情页（买卖一体）按钮规则
| 按钮 | 显示条件 | 禁用条件 | 后端校验关键点 |
|---|---|---|---|
| 收藏 | 登录 | - | 归属：user_id=当前用户 |
| 加入购物车 | 登录 且 goods.status=APPROVED | stock<=0 | 下单前仍需二次校验库存 |
| 立即下单 | 登录 且 goods.status=APPROVED | stock<=0 | createOrder 事务条件扣库存 |
| 编辑/提交审核/下架 | 当前用户=goods.seller_id 或 ADMIN | 状态不允许 | 归属 + 状态机（见第8.5） |

### 9.4 页面 ASCII 原型（淘宝风二手版，选定方案）

> 首页：版本 A（封面 Banner + 楼层入口）
> 商品详情：版本 D2（右侧信息紧凑 + 左侧大图）
> 下单成功页：版本 S1（卡片式拆单提示）
> 留言问答：版本 C1（楼层/缩进）

#### 首页版本 A（封面 Banner + 楼层入口）
```text
+--------------------------------------------------------------------------------+
| LOGO | 搜索框 [________________________] [搜索] | 购物车 | 我的订单 | 登录/头像 |
+--------------------------------------------------------------------------------+
| 大促/封面 Banner： [   二手好物·官方担保·包邮专区   ]  -> 点击进入会场          |
+--------------------------------------------------------------------------------+
| 楼层入口（热门二手类目）                                                        |
| [手机数码] [电脑办公] [家用电器] [图书音像] [乐器/兴趣] [校园/教材] [更多]       |
+--------------------------------------------------------------------------------+
| 热门商品瀑布流（示例两列）                                                     |
| [封面] iPhone 13 128G  ￥3999  库存12  [立即查看] [加入购物车]                  |
| [封面] Kindle Scribe   ￥1999  库存 5  [立即查看] [加入购物车]                  |
| [封面] Switch OLED     ￥2099  库存 9  [立即查看] [加入购物车]                  |
| [封面] 索尼耳机 XM5    ￥1899  库存20  [立即查看] [加入购物车]                  |
+--------------------------------------------------------------------------------+
| 分页 / 滚动加载                                                                 |
+--------------------------------------------------------------------------------+
```
+--------------------------------------------------------------+
```

#### 商品详情（D2）
```text
+--------------------------------------------------------------+
| LOGO | 搜索 [_________] [搜] | 购物车 | 我的订单 | 登录/头像 |
+--------------------------------------------------------------+
| [主图区域 400x400]      | 标题：二手 ThinkPad X1 2022         |
|                         | 价格：￥4599  库存：6               |
| ◀ [1][2][3][4][5] ▶    | 卖家：李四 信誉：钻石               |
| 多图切换显示             | 配送：顺丰包邮 | 验机报告：已上传    |
|                         | 按钮：[立即购买] [加入购物车]        |
|                         | 收藏 ❤  分享 ↗                      |
+--------------------------------------------------------------+
| Tabs: [商品详情] [规格参数] [验机报告] [售后说明]             |
| (内容省略，放大图/文本/表格)                                  |
+--------------------------------------------------------------+
| 评价列表（筛选：全部/有图/退款评价）                          |
|  - ★★★★★ 用户B[已购买家]: "机器很新，键盘手感好"              |
|  - ★★★★☆ 用户C: "电池 86%，还能接受"                        |
+--------------------------------------------------------------+
| 问答/留言                                                   |
|  Q: 是否自带原装电源？                                       |
|  A(卖家): 自带原装 65W 电源。                                |
|  A(管理员): 收货请当面验货。                                 |
+--------------------------------------------------------------+
```

【说明】
• 主图区域：显示当前选中的商品图片，支持放大查看
• 缩略图条：显示所有商品图片的缩略图，点击切换主图
• 多图支持：支持上传多张商品图片，不限制数量，每张图片≤20MB
• 图片格式：支持 jpg/png/webp 格式
• 图片切换：点击缩略图或左右箭头切换显示不同图片
• 已购买家标签：评价列表中显示已购买该商品的用户标签

#### 下单成功页（S1 卡片）
```text
下单成功！已拆分为 3 个订单，请分别支付：
+---------------------------+   +---------------------------+
| 订单A（卖家：张三）        |   | 订单B（卖家：李四）        |
| 金额：￥88.00              |   | 金额：￥39.90             |
| 状态：待支付               |   | 状态：待支付              |
| [ 去支付 ] [ 订单详情 ]     |   | [ 去支付 ] [ 订单详情 ]    |
+---------------------------+   +---------------------------+
+---------------------------+
| 订单C（卖家：王五）        |
| 金额：￥12.00              |
| 状态：待支付               |
| [ 去支付 ] [ 订单详情 ]     |
+---------------------------+
提示：V1 暂不支持合并支付；15 分钟未支付将自动取消并释放库存。
```

#### 留言问答（C1 楼层/缩进）
```text
[问答/留言]
#1 张三 12:00
   还能便宜点吗？
   └─ 卖家 12:05: 暂不议价哦。
   └─ 管理员 12:10: 注意当面验货。
#2 李四[已购买家] 12:30
   支持自提吗？
   └─ 卖家 12:32: 支持，地铁口自提。
#3 王五 12:45
   成色怎么样？
   └─ 卖家 12:46: 95新，无划痕。
分页: < 1 2 3 >   [筛选: 全部 ▼] [仅已购买家]   [我要提问] [刷新]
```

【说明】
• [已购买家] 标签：显示在已购买该商品的用户ID后面，增强留言真实性
• 筛选功能：支持"仅已购买家"筛选，查看真实买家评价
• 数据来源：查询 order_item 表判断用户是否购买过该商品

### 9.4.1 全站页面 ASCII 布局清单（补全版）

#### A1 首页（已选，淘宝风二手）
```text
+--------------------------------------------------------------------------------+
| LOGO | 搜索框 [________________________] [搜索] | 购物车 | 我的订单 | 登录/头像 |
+--------------------------------------------------------------------------------+
| Banner/封面区: [ 二手好物·官方担保·包邮专区 ]  -> 点击进入会场                 |
+--------------------------------------------------------------------------------+
| 楼层入口： [手机数码] [电脑办公] [家用电器] [图书音像] [校园专区] [更多]        |
+--------------------------------------------------------------------------------+
| 推荐商品瀑布流                                                                  |
| [封面] iPhone 13   ￥3999  库存12  [查看] [加入购物车]                         |
| [封面] Kindle      ￥1999  库存 5  [查看] [加入购物车]                         |
| [封面] Switch      ￥2099  库存 9  [查看] [加入购物车]                         |
| [封面] 索尼耳机     ￥1899  库存20  [查看] [加入购物车]                         |
+--------------------------------------------------------------------------------+
| 页脚：关于我们 | 交易安全 | 帮助中心 | 联系客服                                |
+--------------------------------------------------------------------------------+
```

#### A2 商品列表页（L1 双列瀑布流）
```text
+--------------------------------------------------------------------------------+
| LOGO | 搜索 [_____________] [搜] | 购物车 | 我的订单 | 登录/头像              |
+--------------------------------------------------------------------------------+
| 分类: 全部 / 数码 / 图书 / 家电 / 服饰 / 校园专区                              |
| 价格: [0-100] [100-500] [500+]     排序: 默认 / 最新 / 价格↑ / 价格↓           |
+--------------------------------------------------------------------------------+
| [封面] 商品A ￥99  库存20  [查看][加购] | [封面] 商品B ￥59 库存5 [查看][加购] |
| [封面] 商品C ￥199 库存12 [查看][加购] | [封面] 商品D ￥29 库存0 [查看][加购] |
| [封面] 商品E ￥899 库存2  [查看][加购] | [封面] 商品F ￥39 库存8 [查看][加购] |
+--------------------------------------------------------------------------------+
| 分页: < 1 2 3 4 >                                                              |
+--------------------------------------------------------------------------------+
```

#### A3 商品详情页（D2 已选）
```text
+--------------------------------------------------------------+
| LOGO | 搜索 [_________] [搜] | 购物车 | 我的订单 | 登录/头像 |
+--------------------------------------------------------------+
| [主图区域 400x400]      | 标题：二手 ThinkPad X1 2022         |
|                         | 价格：￥4599  库存：6               |
| ◀ [1][2][3][4][5] ▶    | 卖家：李四 信誉：钻石               |
| 多图切换显示             | 配送：顺丰包邮 | 验机报告：已上传    |
|                         | 按钮：[立即购买] [加入购物车]        |
|                         | 收藏 ❤  分享 ↗                      |
+--------------------------------------------------------------+
| Tabs: [商品详情] [规格参数] [验机报告] [售后说明]             |
| (内容省略，放大图/文本/表格)                                  |
+--------------------------------------------------------------+
| 评价列表（筛选：全部/有图/退款评价/已购买家）                  |
|  - ★★★★★ 用户B[已购买家]: "机器很新，键盘手感好"              |
|  - ★★★★☆ 用户C: "电池 86%，还能接受"                        |
+--------------------------------------------------------------+
| 问答/留言                                                    |
|  Q: 是否自带原装电源？                                       |
|  A(卖家): 自带原装 65W 电源。                                |
|  A(管理员): 收货请当面验货。                                 |
+--------------------------------------------------------------+
```

【说明】
• 主图区域：显示当前选中的商品图片，支持放大查看
• 缩略图条：显示所有商品图片的缩略图，点击切换主图
• 多图支持：支持上传多张商品图片，不限制数量，每张图片≤20MB
• 已购买家标签：评价列表中显示已购买该商品的用户标签，增强真实性

#### A4 购物车页
```text
+--------------------------------------------------------------+
| LOGO | 搜索 [_________] [搜] | 购物车 | 我的订单 | 登录/头像 |
+--------------------------------------------------------------+
| 购物车                                                       |
| [√] 商品A ￥99   数量[ - 1 + ]   小计￥99   [删除]            |
| [√] 商品B ￥59   数量[ - 2 + ]   小计￥118  [删除]            |
| [ ] 商品C ￥29   数量[ - 1 + ]   小计￥29   [删除]            |
+--------------------------------------------------------------+
| 合计：￥217     [去结算]                                     |
+--------------------------------------------------------------+
```

#### A5 下单确认页
```text
+--------------------------------------------------------------+
| 收货地址: [张三 138****1234] 北京市朝阳区 XXX [更换]          |
+--------------------------------------------------------------+
| 订单商品列表                                                 |
| 商品A ￥99 x1  小计￥99                                      |
| 商品B ￥59 x2  小计￥118                                     |
+--------------------------------------------------------------+
| 备注: [____________________________________]                |
| 合计：￥217                         [提交订单]               |
+--------------------------------------------------------------+
```

#### A6 下单成功页（S1 卡片）
```text
下单成功！已拆分为 3 个订单，请分别支付：
+---------------------------+   +---------------------------+
| 订单A（卖家：张三）        |   | 订单B（卖家：李四）        |
| 金额：￥88.00              |   | 金额：￥39.90             |
| 状态：待支付               |   | 状态：待支付              |
| [ 去支付 ] [ 订单详情 ]     |   | [ 去支付 ] [ 订单详情 ]    |
+---------------------------+   +---------------------------+
+---------------------------+
| 订单C（卖家：王五）        |
| 金额：￥12.00              |
| 状态：待支付               |
| [ 去支付 ] [ 订单详情 ]     |
+---------------------------+
提示：15 分钟未支付自动取消并释放库存。
```

#### A7 我的订单（买家）
```text
[订单筛选] 全部 / 待支付 / 待收货 / 已完成 / 退款 / 争议中
-------------------------------------------------
#1001 待支付 ￥88.00  卖家：张三   [去支付][取消]
#1002 已发货 ￥39.90  卖家：李四   [查看详情][确认收货]
#1003 退款中 ￥12.00  卖家：王五   [查看详情]
#1004 争议中 ￥59.00  卖家：赵六   [查看争议详情]
-------------------------------------------------
分页: < 1 2 3 >
```

【说明】
• 争议中状态：订单进入DISPUTED状态，显示"争议中"标签
• 查看争议详情：点击可查看争议处理进度和管理员裁决结果
• 等待管理员裁决：争议处理期间，订单暂停其他操作，等待管理员最终裁决

#### A8 卖家订单（发货页）
```text
[我卖出的订单]
订单#2001 买家:张三 状态:PAID
  - 商品: 书 x1  [发货]
订单#2002 买家:李四 状态:REFUNDING
  - 商品: 笔 x2  [发货按钮隐藏]
订单#2003 买家:王五 状态:DISPUTED
  - 商品: 笔记本 x1  [等待管理员争议处理]
-------------------------------------------------
分页: < 1 2 3 >
```

【说明】
• DISPUTED状态：订单进入争议处理中，卖家无法操作
• 等待裁决：争议处理期间，订单暂停其他操作，等待管理员最终裁决
• 裁决结果：管理员裁决后，订单状态将变更为REFUNDED或COMPLETED

#### A9 个人中心（买家/卖家通用）
```text
[个人中心]
头像 [上传]  昵称：小明  手机：138****1234  [编辑资料]
-------------------------------------------------
常用入口: [我的订单] [我的收藏] [我的评价] [我的地址] [安全设置]
常用入口补充: [消息中心]
-------------------------------------------------
地址管理:
  北京市朝阳区XXX  张三 138****1234  [默认] [编辑] [删除]
  上海市浦东新区YYY 李四 139****5678  [设为默认] [编辑] [删除]
```

#### A10 我的收藏
```text
[我的收藏]
-------------------------------------------------
[封面] iPhone 13  ￥3999  [查看] [取消收藏]
         (favorite_id: 101)
[封面] Kindle      ￥1999  [查看] [取消收藏]
         (favorite_id: 102)
-------------------------------------------------
取消收藏支持两种方式：按 favorite_id 删除，或按 goods_id 删除（见第7.13/8.8）
分页: < 1 2 3 >
```

#### A11 我的评价
```text
[我的评价]
订单#1002 商品: ThinkPad X1  ★★★★★  2026-01-27
内容：机器很新，满意。
卖家回复：感谢支持！
-------------------------------------------------
分页: < 1 2 3 >
```

#### A12 评价填写页（买家/管理员）
```text
[创建评价]
订单项: #5001  商品: 二手书  卖家: 张三
评分: [★★★★★]
内容: [____________________________]
图片: [上传按钮]
[提交]
```

#### A13 登录页（S2 左图右表单）
```text
+------------------------------------------------------------+
| LOGO                                                       |
+------------------------------------------------------------+
| [品牌/活动图]             | 登录账号                       |
|                           | 用户名: [____________]         |
|                           | 密  码: [____________]         |
|                           | [登录] [注册]                  |
+------------------------------------------------------------+
```

#### A13.1 注册页（S2 同风格左图右表单）
```text
+------------------------------------------------------------+
| LOGO                                                       |
+------------------------------------------------------------+
| [品牌/活动图]             | 新用户注册                     |
|                           | 用户名: [____________]         |
|                           | 密  码: [____________]         |
|                           | 确认密码: [__________]         |
|                           | 昵称(可选): [________]         |
|                           | [注册] [返回登录]              |
+------------------------------------------------------------+
```

#### A24 订单详情页（买家）
```text
[订单详情 #1002]
状态: 已发货 | 卖家: 李四 | 金额: ￥39.90
收货地址: 张三 138****1234 北京市朝阳区XXX
-------------------------------------------------
商品清单:
- 商品A ￥39.90 x1
-------------------------------------------------
物流信息: 顺丰  单号 SF123456789 (可选)
操作: [确认收货]  [申请退款(未发货可用)]
```

[订单详情 #1003 - 争议中状态]
```text
[订单详情 #1003]
状态: 争议中 (DISPUTED) | 卖家: 赵六 | 金额: ￥59.00
收货地址: 王五 139****5678 上海市浦东新区YYY
-------------------------------------------------
商品清单:
- 商品B ￥59.00 x1
-------------------------------------------------
⚠️ 争议处理中
该订单已进入争议处理流程，等待管理员最终裁决。
争议原因: 商品与描述不符，卖家拒绝退款
申请时间: 2026-01-27 12:00
[查看争议详情]
```

【说明】
• 争议中状态：订单进入DISPUTED状态后，买家无法进行其他操作
• 等待裁决：争议处理期间，订单暂停其他操作，等待管理员最终裁决
• 查看争议详情：可查看争议处理进度和退款历史记录

#### A26 退款详情页（买家）
```text
[退款详情 #3001]
状态: 退款中 / 已退款 / 驳回
原因: 未发货想取消
申请时间: 2026-01-27 10:00
处理记录:
- 2026-01-27 10:05 卖家审核中
- 2026-01-27 11:00 管理员通过
```

#### A27 退款审核详情页（管理员）
```text
[退款审核 #3001]
订单: #1002  买家: 张三  金额: ￥39.90
状态: REFUNDING  申请原因: 未发货想取消
操作: [通过] [驳回]
驳回原因: [________________________]
```

#### A28 评价管理页（管理员）
```text
[评价管理]
商品A  评分:★★★★☆  用户:张三  状态:visible [隐藏][删除]
商品B  评分:★★☆☆☆  用户:李四  状态:visible [隐藏][删除]
分页: < 1 2 3 >
```

#### A29 用户管理页（管理员）
```text
[用户管理]
用户A  状态:ACTIVE   角色:USER  [禁用] [重置密码]
用户B  状态:DISABLED 角色:USER  [启用]
管理员  状态:ACTIVE  角色:ADMIN
分页: < 1 2 3 >
```

#### A30 分类管理页（管理员）
```text
[分类管理]
分类: 数码  [编辑] [删除]
分类: 图书  [编辑] [删除]
[新增分类]
提示：若分类下已有商品，禁止删除（返回 40901）
```

#### A31 公告详情页（前台）
```text
[公告详情]
标题: 平台交易须知
发布时间: 2026-01-27
内容: (公告内容正文...)
```

#### A32 我的地址管理页（买家）
```text
[地址管理]
张三 138****1234 北京市朝阳区XXX  [默认] [编辑] [删除]
李四 139****5678 上海市浦东新区YYY [设为默认] [编辑] [删除]
[新增地址]
```

#### A33 我的发布（卖家）
```text
[我的发布]
商品A 状态:APPROVED  浏览:120  [编辑][下架]
商品B 状态:PENDING   浏览:30   [查看][撤回]
商品C 状态:REJECTED  浏览:5    [编辑][重新提交]
分页: < 1 2 3 >
```

#### A34 我的消息中心（买家/卖家）
```text
[消息中心]
- 订单#1002 已发货，请及时确认收货
- 商品A 审核通过，已上架
- 退款申请已通过
分页: < 1 2 3 >
```

#### A35 支付页（模拟支付）
```text
[订单支付]
订单号: O202601270001   金额: ￥88.00
支付方式: ( ) 支付宝  ( ) 微信  ( ) 银行卡
[确认支付]   [取消返回]
提示：V1 为模拟支付，确认后订单状态变更为 PAID。
```

#### A36 卖家订单详情页
```text
[卖家订单详情 #2001]
买家: 张三  状态: PAID  金额: ￥99.00
收货地址: 北京市朝阳区XXX
商品清单:
 - 商品A ￥99 x1  [发货]
备注: 买家留言: "请尽快发货"
```

[卖家订单详情 #2002 - 争议中状态]
```text
[卖家订单详情 #2002]
买家: 王五  状态: DISPUTED (争议中)  金额: ￥59.00
收货地址: 上海市浦东新区YYY
商品清单:
 - 商品B ￥59 x1  [等待管理员争议处理]
备注: 买家留言: "商品与描述不符"
-------------------------------------------------
⚠️ 该订单已进入争议处理流程
争议原因: 商品与描述不符，买家要求退款
申请时间: 2026-01-27 12:00
状态: 等待管理员裁决
```

【说明】
• DISPUTED状态：订单进入争议处理中，卖家无法操作
• 等待裁决：争议处理期间，订单暂停其他操作，等待管理员最终裁决
• 裁决结果：管理员裁决后，订单状态将变更为REFUNDED或COMPLETED

#### A37 管理员订单详情页
```text
[管理员订单详情 #1002]
买家: 张三  卖家: 李四  状态: SHIPPED  金额: ￥39.90
订单明细: 商品A ￥39.90 x1
操作: [代发货] [查看详情] [退款审核]
审计: 最近操作日志（管理员代发货/退款审核记录）
```

[管理员订单详情 #1003 - 争议中状态]
```text
[管理员订单详情 #1003]
买家: 王五  卖家: 赵六  状态: DISPUTED (争议中)  金额: ￥59.00
订单明细: 商品B ￥59.00 x1
-------------------------------------------------
⚠️ 争议处理
申请人: 买家 王五
申请原因: 商品与描述不符，卖家拒绝退款
申请时间: 2026-01-27 12:00
退款次数: 2次 (已达争议触发条件)
-------------------------------------------------
退款历史:
- 第1次: 2026-01-26 10:00  原因:商品与描述不符  结果:驳回(卖家)
- 第2次: 2026-01-26 18:00  原因:商品与描述不符  结果:驳回(管理员)
-------------------------------------------------
操作: [查看争议详情] [争议裁决]
```

【说明】
• 争议中订单：管理员可查看完整的争议信息和退款历史
• 争议裁决：点击可进入争议裁决页面，进行最终裁决
• 裁决结果：退款(订单状态→REFUNDED) 或 完成交易(订单状态→COMPLETED)


#### A14 卖家商品管理（发布/编辑/上下架）
```text
[商品管理]
[发布商品]
-------------------------------------------------
商品A 状态:APPROVED 库存:12 [编辑][下架]
商品B 状态:PENDING  库存:8  [查看][撤回]
商品C 状态:REJECTED 库存:5  [编辑][重新提交]
-------------------------------------------------
分页: < 1 2 3 >
```

#### A15 卖家发布商品表单
```text
[发布/编辑商品]
标题: [________________________] (1-80字符)
分类: [级联选择: 一级 > 二级 > 三级]  (必选)
副标题: [________________________] (可选)
价格: [____] 元  库存: [____] 件

商品图片:
[上传图片] (支持多张，不限制数量)
  [图片1] [图片2] [图片3] [图片4] [图片5]
   ✓      ✓      ✓      ✓      ✓
  [删除]  [删除]  [删除]  [删除]  [删除]
说明: jpg/png/webp，单张≤20MB，可拖拽排序

详情:
[富文本/Markdown 编辑区]
(支持文字、图片、格式化)

[保存草稿] [提交审核]
```

【说明】
• 多图上传：支持上传多张商品图片，不限制数量
• 图片排序：可拖拽调整图片显示顺序
• 图片大小：单张图片最大20MB
• 图片格式：支持 jpg/png/webp 格式
• 级联分类：支持3级分类选择（一级 > 二级 > 三级）
• 草稿保存：保存为DRAFT状态，可稍后编辑
• 提交审核：提交后进入PENDING状态，等待管理员审核

#### A16 管理员后台首页
```text
后台菜单: 用户 | 商品审核 | 订单 | 退款 | 争议 | 留言 | 公告 | 系统
------------------------------------------------------------
待处理提醒: 待审核商品(12)  待退款(3)  待争议处理(2)  待处理留言(8)
```

#### A17 管理员审核商品
```text
[待审核商品]
商品A  卖家:张三  状态:PENDING  [通过] [驳回]
商品B  卖家:李四  状态:PENDING  [通过] [驳回]
-------------------------------------------------
驳回原因: [________________________]
```

#### A18 管理员退款审核
```text
[退款审核]
订单#3001 买家:张三 金额:￥99 状态:REFUNDING [通过][驳回]
订单#3002 买家:李四 金额:￥59 状态:REFUNDING [通过][驳回]
-------------------------------------------------
驳回原因: [________________________]
```

#### A18.1 管理员争议处理
```text
[争议处理列表]
筛选: [全部 ▼] [待处理 PENDING] [已解决 RESOLVED]  [搜索订单号/买家]
------------------------------------------------------------
争议#1001  订单:#3001  买家:张三  卖家:李四  状态:PENDING
   申请原因: 卖家拒绝退款，商品与描述不符
   退款次数: 2次  申请时间: 2026-01-27 12:00
   [查看详情] [裁决]

争议#1002  订单:#3002  买家:王五  卖家:赵六  状态:PENDING
   申请原因: 商品质量问题，卖家不同意退款
   退款次数: 2次  申请时间: 2026-01-27 14:30
   [查看详情] [裁决]

争议#1003  订单:#3003  买家:李四  卖家:孙七  状态:RESOLVED
   申请原因: 发货商品与描述不符
   退款次数: 2次  申请时间: 2026-01-26 10:00
   裁决结果: 退款  管理员:admin  裁决时间: 2026-01-26 15:00
   [查看详情]
------------------------------------------------------------
分页: < 1 2 3 >

[争议详情 - 争议#1001]
订单信息:
  订单号: #3001
  买家: 张三 (ID: 1001)
  卖家: 李四 (ID: 2001)
  商品: 二手 iPhone 13 128G
  金额: ￥3999
  订单状态: DISPUTED (争议中)

争议信息:
  申请人: 买家 张三
  申请时间: 2026-01-27 12:00
  申请原因: 卖家拒绝退款，商品与描述不符
  争议状态: PENDING (待处理)

退款历史:
  第1次申请: 2026-01-26 10:00  原因: 商品与描述不符  结果: 驳回 (卖家)
  第2次申请: 2026-01-26 18:00  原因: 商品与描述不符  结果: 驳回 (管理员)

[管理员裁决]
裁决结果: ○ 裁决退款 (订单状态→REFUNDED，释放库存)
          ○ 裁决完成交易 (订单状态→COMPLETED，买家不可再申请退款)

管理员备注: [__________________________________________________]
(请说明裁决理由，便于后续查阅和审计)

[确认裁决] [取消]
```

【说明】
• 争议触发：买家申请退款被驳回2次后，系统强制创建争议记录
• 订单状态：进入争议处理后，订单状态变更为DISPUTED
• 管理员权限：管理员拥有最高权限，可随时介入任何争议进行裁决
• 裁决退款：订单状态变更为REFUNDED，自动释放库存
• 裁决完成：订单状态变更为COMPLETED，买家不可再申请退款
• 无时效限制：争议处理无时间限制，直到管理员做出最终裁决
• 管理员备注：记录裁决理由，便于后续查阅和审计

#### A19 管理员代发货
```text
[订单详情]
订单#2001 买家:张三 状态:PAID
商品: iPhone 13  x1
[代发货] (原因可选: [________________])
```

#### A20 管理员留言治理
```text
[留言治理]
商品A  留言: “还能便宜吗？”  状态:visible  [隐藏][删除]
商品B  留言: “支持自提？”    状态:visible  [隐藏][删除]
-------------------------------------------------
分页: < 1 2 3 >
```

#### A21 公告管理
```text
[公告管理]
[发布公告]
标题: [__________________]
内容: [__________________]
[发布]
-------------------------------------------------
公告A  状态:已发布 [编辑][下架]
公告B  状态:草稿   [编辑][发布]
```

#### A23 搜索结果为空（空态）
```text
[搜索结果]
没有找到相关商品
[返回首页]  [重新搜索]
```

#### A38 管理员审计日志
```text
[审计日志]
筛选: 订单号[______]  动作[退款通过/代发货/商品审核]  操作人[______] [搜索]
-------------------------------------------------
2026-01-27 15:10  订单#1002  REFUND_APPROVE  操作人:admin1
2026-01-27 15:20  订单#1003  SHIP_BY_ADMIN  操作人:admin2
2026-01-27 16:00  商品#5001  GOODS_APPROVE  操作人:admin1
-------------------------------------------------
分页: < 1 2 3 >
```

---

### 9.6 图表-需求映射检查表（逐图逐条）

#### 9.6.1 流程/状态/时序图映射
| 图表编号 | 图表名称 | 覆盖核心逻辑 | 对应章节 | 一致性检查点（结论） |
|---|---|---|---|---|
| 6.2.1 | 下单拆单流程 | 条件扣库存；按 seller_id 拆单；落库 orders+order_items | 4.1/4.3/7.9/8.1 | 订单项初始 PENDING_PAY；orders.seller_id 必填；一致 |
| 6.2.2 | 订单生命周期流转 | PENDING_PAY→PAID→SHIPPED→COMPLETED；CANCELED/REFUNDING/REFUNDED | 4.1/6.1/8.1/9.1 | 与前端按钮矩阵一致；一致 |
| 6.2.3 | 超时取消流程 | 15 分钟未支付自动取消；幂等释放库存 | 4.5/8.1 | 条件 UPDATE 门闩；一致 |
| 6.2.4 | 退款完整流程 | 仅 PAID 未发货可退款；审核通过释放库存 | 4.6/8.1 | V1 不支持已发货退款；一致 |
| 6.2.5 | 商品审核状态机 | DRAFT/PENDING/APPROVED/REJECTED/OFFLINE | 4.2/7.7/8.4 | 可见性仅 APPROVED；一致 |
| 6.2.6 | 用户注册登录 | 注册/登录/JWT | 7.5/11 | access_token 过期需重登；一致 |
| 6.2.7 | 商品发布流程 | 发布/提交审核/下架 | 2.2/7.7/8.4 | 买卖一体；归属校验；一致 |
| 6.2.8 | 购物车流程 | 加购/改数量/删除 | 4.3/7.8 | 下单为原子操作；一致 |
| 6.2.9 | 发货流程 | 订单项发货；触发主单聚合 SHIPPED | 4.1/8.2/9.2 | orders.status=PAID 且 item_status=PAID；一致 |
| 6.2.10 | 确认收货流程 | SHIPPED→COMPLETED；is_settled=1 | 4.1/8.1/9.1 | 仅主单确认收货；一致 |
| 6.2.11 | 评价流程 | order_item 一项一评；退款评价不计均分 | 2.7/8.6/13 | REFUNDED 可评但不计均分；一致 |
| 6.2.12 | 留言回复流程 | message+reply 两层；治理软删 | 7.12/8.7 | 创建不限制归属；治理 ADMIN；一致 |
| 6.2.13 | 收藏流程 | UNIQUE(user_id, goods_id)；取消收藏 | 7.13/8.8 | 支持按 favorite_id 或 goods_id 删除；一致 |
| 6.2.14 | 搜索流程 | SQL LIKE；prefix/contains | 7.2 | prefix 可走索引；一致 |
| 6.2.15.1 | 下单锁库存时序图 | 事务扣库存+拆单 | 4.1/4.3/8.1 | affected_rows=0 返回 40902；一致 |
| 6.2.15.2 | 退款审核时序图 | REFUNDING→REFUNDED/PAID；幂等 | 4.6/8.1 | 条件 UPDATE；一致 |
| 6.2.15.3 | 发货聚合时序图 | 全部子项 SHIPPED 聚合主单 | 4.1/8.2 | count=0 才更新主单；一致 |

#### 9.6.2 页面 ASCII 原型映射（逐页）
| 页面编号 | 页面名称 | 主要 API | 关键规则/状态矩阵 |
|---|---|---|---|
| A1 | 首页 | /api/goods, /api/categories, /api/notices | 仅 APPROVED 可见 |
| A2 | 商品列表 | /api/goods | 搜索/筛选/分页 |
| A3 | 商品详情 | /api/goods/{id}, /api/messages, /api/favorites, /api/cart, /api/orders | 登录才可收藏/加购/下单 |
| A4 | 购物车 | /api/cart | 归属校验；下单原子性 |
| A5 | 下单确认 | /api/addresses, /api/orders | 拆单；库存条件扣减 |
| A6 | 下单成功 | /api/orders | 逐单支付提示 |
| A7 | 我的订单 | /api/orders, /api/orders/{id}/pay, /api/orders/{id}/cancel, /api/orders/{id}/confirm, /api/orders/{id}/refund | 按 9.1 按钮矩阵 |
| A8 | 卖家订单 | /api/seller/orders, /api/seller/order-items/{id}/ship | 按 9.2 发货矩阵 |
| A9 | 个人中心 | /api/auth/me, /api/addresses | 入口包含消息中心 |
| A10 | 我的收藏 | /api/favorites, /api/favorites/{id}, /api/favorites/goods/{goodsId} | 返回 favorite_id |
| A11 | 我的评价 | /api/reviews/my | 一项一评 |
| A12 | 评价填写 | /api/reviews, /api/upload | order.status ∈ {COMPLETED, REFUNDED} |
| A13 | 登录 | /api/auth/login | access_token |
| A13.1 | 注册 | /api/auth/register | 用户名唯一 |
| A14 | 卖家商品管理 | /api/seller/goods, /api/goods/{id} | 归属校验 |
| A15 | 发布商品表单 | /api/goods, /api/upload | 可提交审核 |
| A16 | 管理员后台首页 | 多模块入口 | ADMIN 权限 |
| A17 | 管理员审核商品 | /api/admin/goods/{id}/approve, /api/admin/goods/{id}/reject | 审核状态机 |
| A18 | 管理员退款审核 | /api/admin/orders, /api/admin/orders/{id}/refund/approve, /api/admin/orders/{id}/refund/reject | REFUNDING 才可审 |
| A19 | 管理员代发货 | /api/admin/order-items/{id}/ship | 仅 PAID 可发货 |
| A20 | 管理员留言治理 | /api/admin/messages, /api/admin/message-replies | 软删除治理 |
| A21 | 公告管理 | /api/admin/notices | DRAFT/PUBLISHED/OFFLINE |
| A23 | 搜索空态 | /api/goods | 无数据提示 |
| A24 | 订单详情（买家） | /api/orders/{id} | 物流仅在详情显示 |
| A26 | 退款详情（买家） | /api/orders/{id} | REFUNDING/REFUNDED 状态展示 |
| A27 | 退款审核详情（管理员） | /api/orders/{id} | 审核幂等 |
| A28 | 评价治理（管理员） | /api/admin/reviews | hidden/deleted |
| A29 | 用户管理 | /api/admin/users | ACTIVE/DISABLED |
| A30 | 分类管理 | /api/admin/categories | 仅无引用可删 |
| A31 | 公告详情 | /api/notices/{id} | 仅 PUBLISHED |
| A32 | 地址管理 | /api/addresses | 归属校验 |
| A33 | 我的发布 | /api/seller/goods | 自己商品全量 |
| A34 | 我的消息中心 | /api/orders, /api/seller/orders, /api/notices | 买家/卖家拼接展示 |
| A35 | 支付页 | /api/orders/{id}/pay | 仅 PENDING_PAY |
| A36 | 卖家订单详情 | /api/orders/{id} | 归属校验（seller） |
| A37 | 管理员订单详情 | /api/orders/{id} | ADMIN 可查看 |
| A38 | 管理员审计日志 | /api/admin/audit-logs | 只读审计 |

---

## 10. 技术架构与工程目录（前后端分离）

### 10.1 系统架构图

```text
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              系统架构图                                           │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                                    浏览器层                                        │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│
│  │  Vue 3 前端应用 (localhost:5173)                                              ││
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        ││
│  │  │  商品模块   │  │  订单模块   │  │  用户模块   │  │  管理后台   │        ││
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘        ││
│  │         │                │                │                │                ││
│  │         └────────────────┬────────────────┴────────────────┘                ││
│  │                          │                                                 ││
│  │                    ┌─────┴─────┐                                            ││
│  │                    │   Axios   │  (HTTP Client + JWT Bearer Token)         ││
│  │                    └─────┬─────┘                                            ││
│  └──────────────────────────┼──────────────────────────────────────────────────┘│
└─────────────────────────────┼───────────────────────────────────────────────────┘
                              │
                    ┌─────────▼─────────┐
                    │   Nginx (可选)    │  反向代理 / 静态资源
                    └─────────┬─────────┘
                              │
┌─────────────────────────────┼───────────────────────────────────────────────────┐
│                    ┌─────────▼──────────────────────────────────────────────┐   │
│                    │              Spring Boot 后端 (:9090)                   │   │
│                    │  ┌────────────────────────────────────────────────────┐│   │
│                    │  │           Spring Security + JWT Filter             ││   │
│                    │  │  (认证/授权/权限校验: ROLE_USER / ROLE_ADMIN)      ││   │
│                    │  └────────────────────┬───────────────────────────────┘│   │
│                    │                       │                                   │   │
│                    │  ┌────────────────────▼───────────────────────────────┐│   │
│                    │  │              Controller 层                          ││   │
│                    │  │  AuthController | OrderController | GoodsController││   │
│                    │  └────────────────────┬───────────────────────────────┘│   │
│                    │                       │                                   │   │
│                    │  ┌────────────────────▼───────────────────────────────┐│   │
│                    │  │              Service 层                             ││   │
│                    │  │  OrderService | GoodsService | UserService         ││   │
│                    │  │  (业务逻辑: 拆单/锁库存/聚合/幂等)                 ││   │
│                    │  └────────────────────┬───────────────────────────────┘│   │
│                    │                       │                                   │   │
│                    │  ┌────────────────────▼───────────────────────────────┐│   │
│                    │  │           MyBatis Plus Mapper 层                   ││   │
│                    │  └────────────────────┬───────────────────────────────┘│   │
│                    └──────────────────────┼──────────────────────────────────┘   │
│                                           │                                       │
│                    ┌──────────────────────▼──────────────────────────────────┐   │
│                    │                   MySQL 8.0 数据库                      │   │
│                    │  ┌────────────────────────────────────────────────────┐│   │
│                    │  │  user | goods | orders | order_item | review ...   ││   │
│                    │  └────────────────────────────────────────────────────┘│   │
│                    └────────────────────────────────────────────────────────┘   │
│                                                                           │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                     定时任务 (Spring @Scheduled)                      │ │
│  │  OrderTimeoutCancelJob: 每分钟扫描 15 分钟未支付订单 → CANCELED      │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                     文件上传/存储                                    │ │
│  │  FileStorageService → ./uploads/{uuid}.jpg → /static/files/{uuid}.jpg│ │
│  └──────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘

数据流向：
───────────────────────────────────────────────────────────────────────────────────
1. 用户操作 → Vue 组件 → Axios HTTP 请求 (Bearer Token)
2. 后端接收 → JWT Filter 认证 → Controller 权限校验
3. Service 层处理业务逻辑 (事务、幂等、状态机)
4. MyBatis 执行 SQL → MySQL 返回结果
5. 响应 → JSON 格式 → 前端渲染

技术栈说明：
───────────────────────────────────────────────────────────────────────────────────
• 前端：Vue 3.4 + Vite 5.0 + Element Plus + Axios + Pinia/Vuex
• 后端：Spring Boot 3.2 + Spring Security + JWT + MyBatis Plus 3.5
• 数据库：MySQL 8.0 + Flyway (DDL 版本管理)
• 文件存储：本地磁盘 + Spring 静态资源映射
• 定时任务：Spring @Scheduled (Cron 表达式)
• 容器化：可选 Docker + Docker Compose
```

### 10.2 工程目录结构

- 架构：Vue → Axios → Spring Boot(API) → Service → MyBatis(+Plus) → MySQL；Scheduler 定时任务处理超时订单；本地文件存储 + 静态映射。
- 目录（建议）：
  - frontend/src/{api,router,store,views,components,utils}
  - backend/src/main/java/com/laidekuai/{config,controller,service,mapper,entity,dto,security,common,modules(upload/order/goods/...)}
  - backend/src/main/resources/{mapper/,application.yml,application-dev.yml,application-prod.yml}
  - uploads/（持久化卷）

### 10.3 生产环境部署架构

```text
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            V1 生产环境部署架构                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

                        ┌───────────────────────────────────┐
                        │          用户浏览器                │
                        └─────────────────┬─────────────────┘
                                          │ HTTPS (443)
                        ┌─────────────────▼─────────────────┐
                        │        云服务器 / ECS              │
                        │  ┌───────────────────────────────┐│
                        │  │  Nginx (80/443)               ││
                        │  │  - 反向代理 → backend:9090    ││
                        │  │  - 静态文件 → /var/www/uploads ││
                        │  │  - SSL 证书配置                ││
                        │  │  - Gzip 压缩                   ││
                        │  └───────────┬───────────────────┘│
                        │              │                     │
                        │  ┌───────────▼───────────────────┐│
                        │  │  Docker / Java Process        ││
                        │  │  Spring Boot :9090            ││
                        │  │  - JAR 包部署                 ││
                        │  │  - JVM: -Xms512m -Xmx1024m   ││
                        │  │  - G1GC 垃圾回收器            ││
                        │  └───────────┬───────────────────┘│
                        │              │                     │
                        │  ┌───────────▼───────────────────┐│
                        │  │  MySQL 8.0 (:3306)            ││
                        │  │  - InnoDB 引擎                ││
                        │  │  - READ_COMMITTED 隔离级别     ││
                        │  │  - 慢查询日志                 ││
                        │  └───────────┬───────────────────┘│
                        └─────────────────────────────────────┘

                        ┌───────────────────────────────────┐
                        │    持久化存储 (EBS / OSS)         │
                        │  - ./uploads/ (文件上传目录)      │
                        │  - MySQL 数据目录                 │
                        │  - Flyway DDL 版本管理            │
                        │  - 每日备份 (保留 30 天)          │
                        └───────────────────────────────────┘

环境变量配置：
───────────────────────────────────────────────────────────────────────────────────
SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/laidekuai
SPRING_DATASOURCE_USERNAME=laidekuai_user
SPRING_DATASOURCE_PASSWORD=********(生产环境强密码)
SPRING_PROFILES_ACTIVE=prod
JWT_SECRET=********(生产环境不得使用默认值，建议 32+ 字符)
UPLOAD_DIR=/var/www/uploads
SERVER_PORT=9090

定时任务：
───────────────────────────────────────────────────────────────────────────────────
@Scheduled(cron = "0 */1 * * * ?")  // 每分钟执行
- 扫描 15 分钟未支付订单 → CANCELED + 释放库存
- 条件 UPDATE 幂等保证，避免重复处理

监控与日志：
───────────────────────────────────────────────────────────────────────────────────
• 日志目录: /var/log/laidekuai/
• 日志级别: INFO (生产) / DEBUG (开发)
• 日志轮转: logback-spring.xml 配置按天轮转，保留 30 天
• 监控指标:
  - 响应时间 p95/p99 (目标: p95 < 500ms)
  - 数据库连接池使用率 (HikariCP)
  - JVM 内存使用率
  - 定时任务执行状态
• 告警通知: 可接入钉钉/企业微信机器人

防火墙配置：
───────────────────────────────────────────────────────────────────────────────────
• 入站规则:
  - 80 (HTTP) → 重定向到 443
  - 443 (HTTPS) → Nginx
  - 22 (SSH) → 仅限管理 IP
• 出站规则:
  - 允许访问外部 API (如支付接口，V2 扩展)

备份策略：
───────────────────────────────────────────────────────────────────────────────────
• 数据库备份:
  - 每日全量备份 (mysqldump)
  - 增量备份 (binlog)
  - 保留 30 天
• 文件备份:
  - uploads 目录定期同步到 OSS
  - 本地保留 7 天

扩容方向（V2+）：
───────────────────────────────────────────────────────────────────────────────────
• 应用服务器: 集群部署 + 负载均衡
• 数据库: 主从复制 + 读写分离
• 缓存: Redis (热点数据、Session)
• 消息队列: RabbitMQ/Kafka (异步处理)
• 搜索: Elasticsearch (全文搜索)
• 文件存储: OSS (对象存储)
• CDN: 静态资源加速
```

---

## 11. 配置与错误码（必须硬编码一致）
- 关键配置：
  - upload.dir=./uploads, upload.url-prefix=/static/files
  - order.timeout-minutes=15（未支付自动取消）
  - cancel.cron=每1分钟
- jwt.secret=自定义，expire=24h（记住我30天可选）
（V2 规划）refresh_token：V1 **不提供** /api/auth/refresh；若未来需要无感续期，可在 V2 增加 refresh_token 机制与 /api/auth/refresh 接口。
  - page.default=10, page.max=50
  - active.order.limit=10
- 错误码（必须前后端硬编码一致；可映射到 i18n key，如 40901 -> error.status.conflict）：
  - 0 成功；
  - 40001 参数错；
  - 40101 未认证；
  - 40301 越权；
  - 40401 不存在；
  - 40901 状态冲突；
  - 40902 库存不足；
  - 40903 风控拦截（活跃订单超限）；
  - 50001 系统异常。

### 11.1 配置项对照表（便于排查）
| 配置键 | 作用 | 典型值 | 备注 |
|---|---|---|---|
| upload.dir | 上传文件存放目录 | ./uploads | 生产挂载持久化卷 |
| upload.url-prefix | 静态访问前缀 | /static/files | Spring 静态映射 |
| order.timeout-minutes | 未支付超时取消 | 15 | 定时任务扫描 |
| cancel.cron | 取消任务 cron | 0 */1 * * * ? | 每分钟 |
| jwt.secret | JWT 密钥 | 随机字符串 | 生产不得默认 |
| jwt.expire | 访问 token 过期 | 24h | V1 无 refresh |
| page.default | 默认分页大小 | 10 | 最大 50 |
| page.max | 最大分页大小 | 50 | |
| active.order.limit | 风控活跃订单上限（PENDING_PAY+PAID） | 10 | 超限返回 40903 |
| admin.reset.default-password | 管理员重置默认密码 | 123456 | 重置接口写死该值 |

### 11.2 错误码速查表
| code | 含义 | 常见触发 |
|---|---|---|
| 0 | 成功 | - |
| 40001 | 参数错误 | 校验失败 |
| 40101 | 未认证 | 缺少/失效 token |
| 40301 | 越权 | 归属/角色不匹配 |
| 40401 | 不存在 | 资源不存在 |
| 40901 | 状态冲突 | 状态机不匹配/幂等失败 |
| 40902 | 库存不足 | 下单扣库存失败 |
| 40903 | 风控拦截 | 活跃订单 > 10 |
| 50001 | 系统异常 | 未捕获异常 |

### 11.3 HTTP状态码映射（前后端接口约定）
| 业务场景 | HTTP状态码 | 响应体code | 说明 |
|---|---|---|---|
| 业务成功 | 200 | 0 | 正常业务流程完成 |
| 业务失败（参数/状态/权限等） | 200 | 非0 | 前端根据code展示具体错误信息 |
| 认证失败 | 401 | 40101 | Token缺失或过期，前端跳转登录 |
| 系统异常 | 500 | 50001 | 服务器内部错误，前端提示"系统异常，请稍后重试" |

### 11.4 事务隔离级别（数据一致性保证）
- **默认隔离级别**：READ_COMMITTED（防止脏读）
- **关键业务场景**（下单/扣库存）：使用 SELECT FOR UPDATE 或悲观锁，防止并发更新丢失
- **说明**：MySQL默认REPEATABLE_READ可防止不可重复读，V1阶段使用READ_COMMITTED已满足需求

### 11.5 安全实现细节说明
- **文件上传**：使用UUID作为文件名，不保留原始文件名；验证扩展名白名单（jpg/png/webp）；限制文件大小≤20MB
- **SQL注入防护**：所有数据库操作使用MyBatis参数绑定，关键词中的特殊字符会被自动转义
- **并发审核冲突处理**：退款审核使用条件UPDATE作为幂等门闩（WHERE status='REFUNDING'），affected_rows=0时返回40901，这是预期行为

---

## 12. 前端接口 Mock 集合（Swagger 示例 / Postman 导出样例）

### 12.1 Swagger/OpenAPI（示例片段）
> 说明：V1 可先覆盖“登录/商品/订单/退款/评价/上传”主链路；其余接口逐步补齐。

### 12.2 Postman Collection（导出格式样例，最小集）
> 说明：这里给一个“结构样例”，后续按接口表补全即可。

```json
{
  "info": { "name": "laidekuai-v1", "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json" },
  "variable": [
    { "key": "baseUrl", "value": "http://localhost:9090" },
    { "key": "token", "value": "" }
  ],
  "item": [
    {
      "name": "Auth - Login",
      "request": {
        "method": "POST",
        "header": [{ "key": "Content-Type", "value": "application/json" }],
        "url": { "raw": "{{baseUrl}}/api/auth/login", "host": ["{{baseUrl}}"], "path": ["api", "auth", "login"] },
        "body": { "mode": "raw", "raw": "{\n  \"username\": \"u1\",\n  \"password\": \"123456\"\n}" }
      }
    },
    {
      "name": "Order - Create (Split)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "Authorization", "value": "Bearer {{token}}" }
        ],
        "url": { "raw": "{{baseUrl}}/api/orders", "host": ["{{baseUrl}}"], "path": ["api", "orders"] },
        "body": { "mode": "raw", "raw": "{\n  \"address_id\": 1,\n  \"items\": [\n    { \"goods_id\": 101, \"qty\": 1 },\n    { \"goods_id\": 202, \"qty\": 2 }\n  ]\n}" }
      }
    },
    {
      "name": "Order - Pay",
      "request": {
        "method": "POST",
        "header": [{ "key": "Authorization", "value": "Bearer {{token}}" }],
        "url": { "raw": "{{baseUrl}}/api/orders/1001/pay", "host": ["{{baseUrl}}"], "path": ["api", "orders", "1001", "pay"] }
      }
    }
  ]
}
```

---

> 交付说明：本文件已合并两份文档的需求与技术方案，采用买卖一体、按卖家拆单、分别支付、极简退款、包邮、结算标记、未支付风控、单套DDL、错误码硬编码等最终决策，可直接作为开发与评审依据。

---

## 13. 评价模块（买家评价 / 卖家回复）

### 13.1 规则
- 维度：按订单项评价（One Item One Review），解决“一单多商品”评价歧义。
- 触发：订单状态 ∈ {COMPLETED, REFUNDED}，由买家或管理员创建；同一 order_item 仅允许创建 1 条评价（不允许修改）。
- 卖家/管理员回复：订单项归属卖家或管理员可回复（可允许覆盖更新）。
- 可见性：默认可见；**V1 已纳入管理员治理**，可隐藏/删除评价（见第8.6与7.18）。
- REFUNDED 订单：允许买家评价（用于投诉/反馈）；前端在商品评分统计时**不计入平均分**，只展示为“退款评价”。

### 13.2 数据表（review）
| 字段 | 类型 | 说明 |
|---|---|---|
| id | bigint PK | 主键 |
| order_id | bigint | 已完成订单ID |
| order_item_id | bigint | 订单项ID（唯一评价） |
| goods_id | bigint | 商品ID（快照） |
| buyer_id | bigint | 买家ID |
| is_refunded | tinyint | 是否“退款评价”：1=订单为REFUNDED时创建；0=订单为COMPLETED时创建 |
| status | varchar | 评价可见性：visible/hidden/deleted |
| rating | tinyint | 1-5 |
| content | text | 评价内容 |
| images | text | 评价图片URL列表（JSON/逗号均可），不限制数量 |
| seller_reply | text | 卖家回复 |
| reply_time | datetime | 卖家回复时间 |
| created_at | datetime | 评价时间 |

索引与约束建议：order_id, order_item_id, buyer_id, goods_id, created_at；唯一约束：UNIQUE(order_item_id)（保留 order_id 便于“按订单查评价”，若不需要可去掉）。

如何判断“退款评价”（无歧义口径）：
- 创建评价时读取订单状态：
  - 若 order.status = REFUNDED，则写入 is_refunded=1；
  - 若 order.status = COMPLETED，则写入 is_refunded=0。
- 说明：`is_refunded` **由业务层在创建评价时写入**（不依赖数据库自动判断）；DDL 中的 `DEFAULT 0` 仅用于兜底。
- 商品详情页展示与统计：
  - 展示：两类评价均展示，但 is_refunded=1 必须标注“退款评价”；
  - 统计均分：必须排除 is_refunded=1（只统计 is_refunded=0）。

### 13.3 接口（最小集）
| 接口 | 方法 | 说明 | 权限/校验 |
|---|---|---|---|
| /api/reviews | POST | 创建评价（一次写入） | 登录；order.status ∈ {COMPLETED, REFUNDED}；buyer归属；一项一评 |
| /api/reviews/my | GET | 我的评价列表 | 登录；buyer归属 |
| /api/reviews/goods/{goodsId} | GET | 商品评价列表 | 公开；仅展示可见评价 |
| /api/reviews/{id}/reply | POST | 卖家回复 | 登录；订单卖家归属（order_item.seller_id） |

请求体示例（POST /api/reviews）：
```json
{
  "order_item_id": 123,
  "rating": 5,
  "content": "很好",
  "images": ["/static/files/rev1.jpg"]
}
```

### 13.4 Mock 示例
- 创建评价
```json
{ "code":0,"message":"ok","data":{"review_id":7001,"order_item_id":5001,"order_id":1001,"is_refunded":0,"rating":5,"content":"很好","images":["/static/files/rev1.jpg"],"created_at":"2026-01-27T12:00:00"} }
```
- 卖家回复
```json
{ "code":0,"message":"ok","data":{"review_id":7001,"seller_reply":"感谢支持","reply_time":"2026-01-27T13:00:00"} }
```

---

## 14. 风险与优先级（开发顺序建议）
| 优先级 | 风险/问题 | 影响 | 落地动作（本文件已要求） |
|---|---|---|---|
| 🔴 高 | orders 缺 seller_id | 拆单后卖家订单查询/权限边界易出漏洞 | orders.seller_id + idx_orders_seller；所有卖家查询必须 where seller_id=当前用户 |
| 🔴 高 | 退款释放库存歧义 | 错放库存会导致超卖/错账 | 仅 PAID→REFUNDED（未发货退款）释放库存；其余场景 V1 不做 |
| 🔴 高 | 风控统计范围不完整 | 恶意锁库存可绕过限制 | 统计活跃订单：PENDING_PAY + PAID（REFUNDING/CANCELED/REFUNDED/COMPLETED不计入）；超过10单拒绝下单 |
| 🔴 高 | 超时取消幂等 | 重复释放库存导致库存虚增 | 条件 UPDATE 作为门闩，affected_rows=1 才释放库存 |
| 🟡 中 | review 维度与字段 | 一单多商品评价歧义/评分不准 | V1 采用订单项维度评价（UNIQUE(order_item_id)） |
| 🟡 中 | 外键约束性能 | 高并发下可能成为瓶颈 | **V1 不使用物理外键（FK）**，仅保留索引并在应用层做存在性校验 |
| 🟢 低 | 搜索 LIKE contains | 可能全表扫描 | V1 可接受；默认 prefix；contains 作为可选 |

### 14.2 已确认点（口径留档）
- 支付体验：保持“拆单分别支付”，前端提示多单需逐个支付，V1 不做合并支付单。
- 角色模型：买卖一体，默认所有新注册用户即具备发布商品权限，不再有“卖家申请”流程。
- 退款软约束：PAID 未发货可申请退款，卖家/管理员可拒绝，拒绝后回到 PAID，用户可再次申请或线下协调；V1 接受该简化逻辑。
- 搜索：V1 用 SQL LIKE（默认 prefix%；contains 接受扫描）。
- 图片存储：V1 本地 + 持久化卷；抽象 FileStorageService 以便未来切换 OSS。
- 错误码：必须硬编码一致；可在前端用 code→i18n key 做多语言。

## 15. DDL/索引/外键策略（Flyway 为唯一来源）
- 必须在 orders 表中加入 seller_id（拆单后单卖家归属），并加索引。
- 迁移脚本示例（用于“从旧库升级”场景，必须由 Flyway 执行；禁止手工执行）：
  - `backend/src/main/resources/db/migration/V2__add_seller_id.sql`
```sql
ALTER TABLE orders ADD COLUMN seller_id BIGINT NOT NULL AFTER buyer_id;
CREATE INDEX idx_orders_seller ON orders(seller_id);
```

### 15.1 外键约束（FK）性能与口径
V1 口径：**不使用物理外键（FK）**，仅保留必要索引，并在应用层做存在性校验与归属校验（例如 buyer_id/seller_id 必须对应 user.id，且在创建/查询/变更时验证）。

原因：
- 降低外键维护成本与潜在写入阻塞风险（并发下更可控）。
- 本项目以“业务校验/状态机/归属校验”为主，FK 不是必须条件。

注意：
- 仍需保证 orders.*_id 与 user.id 类型完全一致（BIGINT）。
- 必须保留 idx_orders_buyer / idx_orders_seller 索引。

### 15.2 建表脚本片段（示例）
（注意：**DDL 由 Flyway 管理并自动执行**；本节仅作为“V1__init.sql 内容片段示例”，不建议人工复制执行。）

补充说明（避免误解）：
- `V1__init.sql` 必须包含**全部表结构**（一次性建库基线）；本节仅展示关键表片段（非完整清单）。

```sql
CREATE TABLE orders (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  order_no VARCHAR(32) NOT NULL,
  buyer_id BIGINT NOT NULL,
  seller_id BIGINT NOT NULL,
  total_amount DECIMAL(12,2) NOT NULL,
  shipping_fee DECIMAL(10,2) NOT NULL DEFAULT 0,
  status VARCHAR(20) NOT NULL,
  cancel_reason VARCHAR(20),
  remark VARCHAR(255),
  pay_time DATETIME,
  address_id BIGINT,
  receiver_name VARCHAR(50),
  receiver_phone VARCHAR(20),
  receiver_full_address VARCHAR(255),
  is_settled TINYINT NOT NULL DEFAULT 0,
  settled_time DATETIME,
  refund_request_count TINYINT NOT NULL DEFAULT 0 COMMENT '退款申请次数，达到2次后第3次申请触发争议',
  created_at DATETIME NOT NULL,
  updated_at DATETIME,
  UNIQUE KEY uk_orders_order_no (order_no)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
CREATE INDEX idx_orders_buyer ON orders(buyer_id);
CREATE INDEX idx_orders_seller ON orders(seller_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created_at ON orders(created_at);
CREATE INDEX idx_orders_is_settled ON orders(is_settled);
CREATE INDEX idx_orders_status_created ON orders(status, created_at);

CREATE TABLE order_item (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  order_id BIGINT NOT NULL,
  goods_id BIGINT NOT NULL,
  seller_id BIGINT NOT NULL,
  goods_title VARCHAR(100) NOT NULL,
  goods_cover VARCHAR(255),
  price DECIMAL(12,2) NOT NULL,
  quantity INT NOT NULL,
  amount DECIMAL(12,2) NOT NULL,
  item_status VARCHAR(20) NOT NULL,
  order_status VARCHAR(20) NOT NULL COMMENT '冗余订单主单状态，便于查询"待发货订单项"时排除REFUNDING/REFUNDED/DISPUTED',
  ship_company VARCHAR(50),
  tracking_no VARCHAR(64),
  ship_time DATETIME
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
CREATE INDEX idx_order_item_order_id ON order_item(order_id);
CREATE INDEX idx_order_item_seller_id ON order_item(seller_id);
CREATE INDEX idx_order_item_status ON order_item(item_status);
CREATE INDEX idx_order_item_order_status ON order_item(order_status);

CREATE TABLE favorite (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  goods_id BIGINT NOT NULL,
  UNIQUE KEY uk_favorite_user_goods (user_id, goods_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE address (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  receiver_name VARCHAR(50) NOT NULL,
  receiver_phone VARCHAR(20) NOT NULL,
  province VARCHAR(50),
  city VARCHAR(50),
  district VARCHAR(50),
  detail VARCHAR(255),
  is_default TINYINT NOT NULL DEFAULT 0,
  status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
  created_at DATETIME NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
CREATE INDEX idx_address_user_id ON address(user_id);

CREATE TABLE category (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(50) NOT NULL,
  parent_id BIGINT,
  level TINYINT NOT NULL DEFAULT 1,
  sort INT DEFAULT 0,
  status VARCHAR(20) NOT NULL DEFAULT 'ENABLED',
  created_at DATETIME NOT NULL,
  INDEX idx_parent_level (parent_id, level)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE notice (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  title VARCHAR(100) NOT NULL,
  content TEXT NOT NULL,
  status VARCHAR(20) NOT NULL,
  published_at DATETIME,
  created_at DATETIME NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE audit_log (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  order_id BIGINT NOT NULL,
  action VARCHAR(50) NOT NULL,
  operator_id BIGINT NOT NULL,
  operator_role VARCHAR(20) NOT NULL,
  reason VARCHAR(255),
  created_at DATETIME NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
CREATE INDEX idx_audit_log_order_id ON audit_log(order_id);

CREATE TABLE review (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  order_id BIGINT NOT NULL,
  order_item_id BIGINT NOT NULL,
  goods_id BIGINT NOT NULL,
  buyer_id BIGINT NOT NULL,
  is_refunded TINYINT NOT NULL DEFAULT 0,
  status VARCHAR(20) NOT NULL DEFAULT 'visible',
  rating TINYINT NOT NULL,
  content TEXT,
  images TEXT,
  seller_reply TEXT,
  reply_time DATETIME,
  created_at DATETIME NOT NULL,
  UNIQUE KEY uk_review_order_item (order_item_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE INDEX idx_review_order_id ON review(order_id);
CREATE INDEX idx_review_goods_id ON review(goods_id);
CREATE INDEX idx_review_buyer_id ON review(buyer_id);
CREATE INDEX idx_review_created_at ON review(created_at);
CREATE INDEX idx_review_status ON review(status);

CREATE TABLE message (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  goods_id BIGINT NOT NULL,
  user_id BIGINT NOT NULL,
  content TEXT NOT NULL,
  is_purchased TINYINT NOT NULL DEFAULT 0 COMMENT '是否已购买该商品',
  status VARCHAR(20) NOT NULL DEFAULT 'visible',
  created_at DATETIME NOT NULL,
  INDEX idx_message_goods_id (goods_id),
  INDEX idx_message_user_id (user_id),
  INDEX idx_message_status (status),
  INDEX idx_message_is_purchased (is_purchased),
  INDEX idx_message_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE message_reply (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  message_id BIGINT NOT NULL,
  replier_id BIGINT NOT NULL,
  content TEXT NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'visible',
  created_at DATETIME NOT NULL,
  INDEX idx_message_reply_message_id (message_id),
  INDEX idx_message_reply_replier_id (replier_id),
  INDEX idx_message_reply_status (status),
  INDEX idx_message_reply_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE user (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) NOT NULL UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  role VARCHAR(20) NOT NULL DEFAULT 'USER',
  status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
  nick_name VARCHAR(50),
  phone VARCHAR(20),
  avatar_url VARCHAR(255),
  created_at DATETIME NOT NULL,
  INDEX idx_user_status (status),
  INDEX idx_user_role (role)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE cart (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  goods_id BIGINT NOT NULL,
  qty INT NOT NULL DEFAULT 1,
  created_at DATETIME NOT NULL,
  updated_at DATETIME,
  UNIQUE KEY uk_cart_user_goods (user_id, goods_id),
  INDEX idx_cart_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE goods (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  seller_id BIGINT NOT NULL,
  category_id BIGINT NOT NULL,
  title VARCHAR(100) NOT NULL,
  sub_title VARCHAR(200),
  price DECIMAL(12,2) NOT NULL,
  stock INT NOT NULL DEFAULT 0,
  detail TEXT,
  image_urls TEXT COMMENT '商品图片URL列表，JSON数组格式，如["url1","url2","url3"]',
  status VARCHAR(20) NOT NULL DEFAULT 'DRAFT',
  audit_reason VARCHAR(500),
  audit_by BIGINT,
  audit_at DATETIME,
  created_at DATETIME NOT NULL,
  updated_at DATETIME,
  INDEX idx_goods_seller_category (seller_id, category_id),
  INDEX idx_goods_status_created (status, created_at),
  INDEX idx_goods_category_id (category_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE dispute (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  order_id BIGINT NOT NULL,
  applicant_id BIGINT NOT NULL,
  applicant_type VARCHAR(20) NOT NULL COMMENT 'BUYER/SELLER',
  reason VARCHAR(500),
  status VARCHAR(20) NOT NULL DEFAULT 'PENDING' COMMENT 'PENDING/RESOLVED',
  resolution VARCHAR(20) COMMENT 'REFUND/COMPLETE',
  admin_id BIGINT,
  admin_note VARCHAR(500),
  created_at DATETIME NOT NULL,
  resolved_at DATETIME,
  INDEX idx_dispute_order_id (order_id),
  INDEX idx_dispute_status (status),
  INDEX idx_dispute_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```
- 影响说明：卖家"我的订单"可直接查询 orders where seller_id = currentUserId；减少依赖 order_item 去重。

---

## 16. 代码改动清单（文件路径 + 关键代码修改点）

> 本章用于后续开发落地时逐项对照，避免“漏改一处导致链路断裂”。

### 16.1 后端（Spring Boot）建议文件与关键改动
| 模块 | 文件（建议） | 必做要点 |
|---|---|---|
| 通用 | backend/src/main/java/.../common/ApiResponse.java | 统一 code/message/data；分页结构固定 |
| 安全 | backend/src/main/java/.../security/JwtAuthFilter.java | JWT 解析与 40101；鉴权失败口径一致 |
| 订单 | backend/src/main/java/.../controller/OrderController.java | create/pay/cancel/confirm/refund；buyer 归属校验 |
| 订单（管理员） | backend/src/main/java/.../controller/AdminOrderController.java | 订单列表（/api/admin/orders）；管理员查询/筛选 |
| 订单 | backend/src/main/java/.../service/impl/OrderServiceImpl.java | 事务拆单 + 条件扣库存；活跃订单风控；状态机校验；幂等；**同步 order_item.order_status** |
| 订单 | backend/src/main/java/.../job/OrderTimeoutCancelJob.java | 每分钟扫超时；条件 UPDATE 门闩；affected_rows=1 才释放库存 |
| 卖家发货 | backend/src/main/java/.../controller/SellerOrderItemController.java | ship；seller 归属校验；item_status 校验 |
| 商品 | backend/src/main/java/.../service/impl/GoodsServiceImpl.java | 审核/上下架状态机；库存扣减/回补 |
| 上传 | backend/src/main/java/.../controller/UploadController.java | MultipartFile；白名单/大小；返回 /static/files/... |
| 上传 | backend/src/main/java/.../service/FileStorageService.java | 抽象接口，便于未来换 OSS |
| 评价 | backend/src/main/java/.../controller/ReviewController.java | create/list/reply；order 状态与归属校验 |
| 留言 | backend/src/main/java/.../controller/MessageController.java | create/list/reply；goods 状态校验；软删除治理 |
| 收藏 | backend/src/main/java/.../controller/FavoriteController.java | add/list/delete；归属校验 |
| 地址 | backend/src/main/java/.../controller/AddressController.java | CRUD + setDefault；归属校验 |
| 公告 | backend/src/main/java/.../controller/NoticeController.java | list/detail；管理员发布/下架 |
| 分类 | backend/src/main/java/.../controller/CategoryController.java | list；管理员 CRUD |
| 用户治理 | backend/src/main/java/.../controller/AdminUserController.java | list/enable/disable/reset |
| 评价治理 | backend/src/main/java/.../controller/AdminReviewController.java | list/hide/delete |
| 审计日志 | backend/src/main/java/.../service/AuditLogService.java | 记录退款/代发货/审核日志 |
| 审计日志 | backend/src/main/java/.../controller/AuditLogController.java | 审计日志列表/详情（ADMIN） |

### 16.2 后端关键逻辑（伪代码级，无歧义）
创建订单（拆单 + 锁库存）
```text
createOrder(buyerId, addressId, items[]):
  if countActiveOrders(buyerId, {PENDING_PAY, PAID}) > 10:
     throw 40903
  校验 address.user_id == buyerId
  事务 begin
    for item in items:
      affected = UPDATE goods SET stock=stock-qty
                 WHERE id=? AND status='APPROVED' AND stock>=qty
      if affected==0: throw 40902 (库存不足)
    groupBy sellerId
    for each sellerGroup:
      insert orders(status=PENDING_PAY, buyer_id=buyerId, seller_id=sellerId)
      insert order_items(order_id, goods snapshot..., item_status=PENDING_PAY, order_status=PENDING_PAY)
  事务 commit
  return orders[]
```

超时取消（幂等）
```text
for order in findTimeoutOrders():
  affected = UPDATE orders SET status='CANCELED' WHERE id=? AND status='PENDING_PAY'
  if affected==1:
     for oi in listOrderItems(order.id):
        UPDATE goods SET stock=stock+oi.qty WHERE id=oi.goods_id
     UPDATE order_item SET order_status='CANCELED' WHERE order_id=?
```

### 16.3 前端（Vue）建议文件与关键改动
| 模块 | 文件（建议） | 必做要点 |
|---|---|---|
| API | frontend/src/api/http.ts | axios 拦截器；40101 跳登录；409xx 提示 |
| API | frontend/src/api/order.ts | create/pay/cancel/confirm/refund 封装 |
| 下单 | frontend/src/views/cart/Checkout.vue | 拆单结果展示；强提示“逐单支付” |
| 订单 | frontend/src/views/order/OrderList.vue | 按 9.1 矩阵控制按钮显隐/禁用 |
| 卖家 | frontend/src/views/seller/SalesOrders.vue | 发货按钮规则（9.2）；仅展示 seller_id 归属单 |
| 上传 | frontend/src/components/UploadImage.vue | 类型/大小校验；上传成功回填 url |
| 评价 | frontend/src/views/review/ReviewForm.vue | 一项一评；仅 COMPLETED/REFUNDED 显示入口 |

### 16.4 非功能指标验收与压测示例（可选）

> 目标：把“p95 < 500ms”落到可执行、可复现的验收方式上，避免“感觉很快”的主观争议。

#### 16.4.1 验收标准（Acceptance Criteria）
| 指标 | 场景 | 目标 | 测量工具 | 通过条件（无歧义） |
|---|---|---|---|---|
| 可用性 | 核心接口：登录/商品列表/下单/支付/发货/确认收货/退款 | 成功率 ≥ 99% | k6/JMeter | HTTP code=200 且业务 code=0 的比例 ≥ 99% |
| 性能 | 商品列表 `GET /api/goods?page=1&size=10` | p95 < 500ms | k6/JMeter | 统计窗口内 p95 响应时长 < 500ms |
| 性能 | 我的订单列表 `GET /api/orders?page=1&size=10` | p95 < 500ms | k6/JMeter | 同上 |
| 性能 | 创建订单 `POST /api/orders` | p95 < 800ms | k6/JMeter | 统计窗口内 p95 响应时长 < 800ms |

测试环境口径（建议写死，便于复现）：
- 数据量：goods ≥ 10,000；orders ≥ 50,000（可用脚本造数，V1 不强制）。
- 运行方式：后端单实例 + 本地 MySQL（或同机 MySQL）。
- 预热：先跑 30 秒预热，不计入统计；再跑 60 秒统计。

#### 16.4.2 k6 压测示例（推荐，轻量）
文件建议路径：`perf/k6/goods_list.js`

```javascript
import http from "k6/http";
import { check, sleep } from "k6";

export const options = {
  vus: 20,
  duration: "60s",
  thresholds: {
    http_req_failed: ["rate<0.01"],          // 失败率 < 1%
    http_req_duration: ["p(95)<500"],        // p95 < 500ms
  },
};

export default function () {
  const url = "http://localhost:9090/api/goods?page=1&size=10&match=prefix&keyword=ip";
  const res = http.get(url);
  check(res, {
    "http 200": (r) => r.status === 200,
    "biz code=0": (r) => {
      try { return JSON.parse(r.body).code === 0; } catch (e) { return false; }
    },
  });
  sleep(1);
}
```

运行示例：
```bash
k6 run perf/k6/goods_list.js
```

文件建议路径：`perf/k6/order_create.js`

> 说明：下单涉及事务与库存条件更新，更能反映系统瓶颈。V1 验收口径允许使用“每次迭代先登录再下单”的最小脚本（端到端、实现最简单，但会把登录开销算进去）；若要更贴近纯下单性能，可将 token 缓存到 setup()（V2/优化阶段再做）。

```javascript
import http from "k6/http";
import { check, sleep } from "k6";

export const options = {
  vus: 10,
  duration: "60s",
  thresholds: {
    http_req_failed: ["rate<0.01"],
    http_req_duration: ["p(95)<800"]       // 下单比列表更重，V1 可先给更宽的门槛，再逐步压到 500ms
  },
};

export default function () {
  const loginRes = http.post(
    "http://localhost:9090/api/auth/login",
    JSON.stringify({ username: "user1", password: "123456" }),
    { headers: { "Content-Type": "application/json" } }
  );
  check(loginRes, { "login ok": (r) => r.status === 200 && JSON.parse(r.body).code === 0 });
  const token = JSON.parse(loginRes.body).data.access_token;

  const orderRes = http.post(
    "http://localhost:9090/api/orders",
    JSON.stringify({ address_id: 1, items: [{ goods_id: 1, qty: 1 }] }),
    {
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`,
      },
    }
  );
  check(orderRes, { "order created": (r) => r.status === 200 && JSON.parse(r.body).code === 0 });
  sleep(1);
}
```

运行示例：
```bash
k6 run perf/k6/order_create.js
```

#### 16.4.3 JMeter 压测示例（可选）
JMeter 测试计划建议：
- Thread Group：并发用户数（如 20），Ramp-up（如 10s），Duration（如 60s）
- HTTP Request：目标接口（如 GET /api/goods）
- JSON Extractor：提取响应 code
- Assertion：code==0 断言
- Summary Report / Aggregate Report：查看 p95（或 90/99 分位）

---

## 17. 可选项口径（已确认）
| 主题 | 选项 | 推荐（V1） | 你需要确认的问题 |
|---|---|---|---|
| refresh_token | A 不做（过期重登） / B 做 refresh | **已确认：A** | access_token 过期需重新登录（V1） |
| 评价是否允许修改 | A 允许覆盖更新 / B 只允许一次写入 | **已确认：B** | 同一 order_item 仅允许写入一次评价 |
| 退款审核接口路径 | A 统一 /api/admin 下分流 / B 拆成 /api/seller + /api/admin | **已确认：B** | 卖家审核与管理员审核接口路径分离 |
| REFUNDED 评价是否计入均分 | A 计入 / B 不计入（仅展示） | **已确认：B** | “退款评价”不计入商品均分，只用于展示/反馈 |

---

## 18. 上线前检查清单（部署检查）
| 检查项 | 目的 | 验收方式 |
|---|---|---|
| 数据库索引已创建 | 保证列表/查询性能 | 执行 `SHOW INDEX FROM orders;` 等确认关键索引存在 |
| 定时任务已启用（超时取消） | 防止库存长期被锁 | 观察日志：每分钟扫描一次；超时订单可被取消并释放库存 |
| uploads/ 已持久化 | 防止重启丢图片 | Docker/服务器挂载持久化目录；重启后图片仍可访问 |
| JWT secret 已替换 | 防止默认 secret 被撞库 | 生产环境使用随机强 secret；不提交到仓库 |
| 错误码前后端已对齐 | 防止交互歧义与提示错误 | 前端常量表与后端枚举/常量一致；抽样接口验证 |
| 环境配置已分离 | 防止误连生产库 | application-dev.yml / application-prod.yml 指向不同数据库 |
| 日志与审计关键点可追踪 | 出问题可定位 | 登录/下单/取消/退款/审核/发货均有日志 |
| Flyway 迁移已成功 | 保证结构一致 | 启动日志确认 Flyway migrate 成功；flyway_schema_history 存在且版本符合预期 |
| 禁止手工改表 | 防止环境漂移 | 约束流程：一切结构变更必须以新迁移脚本提交 |
| 访问控制回归 | 防越权/越界操作 | 抽测关键接口：发货/退款审核/评价/留言隐藏 |
| 状态机回归 | 防状态错乱 | 抽测支付/取消/发货/退款链路的非法操作返回 40901 |
| 静态资源 | 防 404/跨域 | 上传访问 URL 可正常打开；CORS 允许前端域 |

---

## 19. 数据迁移与版本管理（DDL 升级约定）

> 目标：从第一天起强制使用 Flyway 管理 DDL，保证所有环境（开发/测试/生产）结构**绝对一致**，并支持未来字段/索引调整的可追溯升级。

### 19.1 强制 Flyway（V1 口径）
V1 口径（无歧义）：
- **DDL 的唯一来源是 Flyway 迁移脚本**；禁止手工执行 SQL 改动表结构。
- “单套 DDL”不再是一个孤立的 .sql 文档，而是 **`V1__init.sql`** 本身（作为 V1 基线）。
- 后续任何结构变更都必须新增迁移脚本（V2/V3...），并通过应用启动或 CI/CD 执行 migrate。

迁移脚本存放路径：
- `backend/src/main/resources/db/migration/V1__init.sql`（V1 基线：可一次性建库）
- `backend/src/main/resources/db/migration/V2__xxx.sql`（未来变更示例：加字段/索引/表）
- `backend/src/main/resources/db/migration/V3__xxx.sql`

命名规则（无歧义）：
- `V{版本号}__{描述}.sql`（双下划线分隔；Flyway 默认前缀为 `V`，如需可通过配置修改）
- 版本号必须递增且不可回退

### 19.2 与“单套 DDL”的关系
- `V1__init.sql` 承担“单套 DDL（最终结构）”的角色：新人可用它一次性建库；线上环境也由 Flyway 自动执行。
- 后续迁移脚本用于线上升级：可回放、可审计；回滚策略见 19.3。

### 19.2.1 推荐配置（Spring Boot）
建议配置项（示例，具体以工程落地为准）：
- `spring.flyway.enabled=true`
- `spring.flyway.locations=classpath:db/migration`
- `spring.flyway.baseline-on-migrate=true`（若接入已有库可用；新库可不必）
- `spring.flyway.clean-disabled=true`（生产环境强烈建议禁用 clean）

### 19.3 回滚策略建议（V1 可选）
> 说明：Flyway 默认是"只向前迁移"。V1 阶段可先给出建议口径，不强制落地自动回滚。

- 方案 A（推荐）：只向前迁移；需要回滚时编写"反向脚本"（示例：`V2_1__rollback_add_seller_id.sql`），并由运维在应急时执行。
- 方案 B：启用 Flyway 的 undo（需要额外配置与版本策略约束）。
- 方案 C（V1 可接受）：不提供自动回滚；回滚时人工执行 SQL（配合备份/快照）。

### 19.4 运维配置补充说明（V1 参考）
- **数据库连接池**：使用 HikariCP（Spring Boot 默认），建议配置：
  - `spring.datasource.hikari.maximum-pool-size=10`（最大连接数）
  - `spring.datasource.hikari.minimum-idle=5`（最小空闲连接）
- **审计日志保留**：audit_log 表建议保留至少 6 个月，可按月归档到历史表
- **备份策略**：每日全量备份 + 增量备份（binlog），保留至少 30 天
- **监控指标**：应用层监控响应时间（p95/p99）、数据库连接池使用率、JVM 内存使用率
- **日志级别**：生产环境建议 INFO 级别，开发环境 DEBUG 级别
