# 改进方案文档（improvement-plan）

## 背景与目标
- 背景：当前实现已覆盖主要交易链路，但对照 需求.md 存在若干功能缺口与口径偏差（见 Gap 明细）。
- 目标：以最小改动补齐“核心功能 + 口径一致性 + 可发布要求”，形成可执行的阶段性改进计划与验收标准。

## 需求对标结论摘要（完成率）
- 统计口径：基于 `docs/requirement-traceability.md` 表格条目。
- 总条目：277
- 已完成：173
- 部分完成：56
- 未完成：32
- 实现偏差：16
- 完成率：62.45%
- 结论：未达到“100% 完成”。

## Gap 明细表（仅列非“已完成”项）
> 说明：为可执行性，将同主题缺口合并成单条事项。

| 优先级 | 现状 | 与需求差异 | 影响范围 | 最小可行修复方案 |
|---|---|---|---|---|
| P0 | 错误码体系与需求不一致（如 40903/40902 等） | ErrorCode.java 与 需求.md 第11章不一致 | 前后端提示与风控/库存处理口径混乱 | 统一错误码表；同步前端拦截与文案；补回归测试 |
| P0 | 上传访问前缀 /files | 需求为 /static/files | 静态资源访问与部署口径不一致 | 统一 URL 前缀与资源映射；补上传回归 |
| P1 | audit_log 表与接口缺失 | 需求要求审计日志落库与管理端展示 | 管理端“审计日志”页面空转，关键操作不可追踪 | 增加 audit_log 表 + 写入点 + API；或移除页面并在需求中确认降级 |
| P1 | 买卖一体权限不一致 | submit 仅 SELLER/ADMIN，默认用户为 BUYER | 普通用户无法提交审核，违背“买卖一体” | 调整权限或新增角色升级入口；补对应校验 |
| P1 | 超时取消幂等条件不完整 | 缺 updated_at 条件/取消原因口径不同 | 并发取消与重复释放风险 | 增加 updated_at 条件、统一 cancel_reason；补测试 |
| P1 | 退款审核幂等仅管理员路径 | 卖家审核无条件更新 | 并发/重复操作冲突风险 | 卖家审核改为条件更新；补单测 |
| P1 | 收藏功能缺前端 | 后端已有收藏接口，前端无页面/入口 | 功能不可用 | 增加收藏入口/列表页；补最小 e2e |
| P1 | 公告管理缺前端 | 后端已有管理接口，前端缺管理页 | 管理员无法发布/下线 | 增加管理端公告页面；补最小回归 |
| P1 | 游客访问公告被安全策略拦截 | /notices 未公开 | 游客无法浏览公告 | SecurityConfig 放行 /notices（仅 GET） |
| P2 | A26 买家退款详情页缺失 | 需求有独立页面 | 买家流程不完整 | 新增页面或在订单详情页补齐并更新需求说明 |
| P2 | Mock/Swagger/Postman 示例缺失 | 需求要求提供示例 | 交付与联调成本上升 | 补最小 OpenAPI 或 Postman collection |
| P2 | 架构图/部署架构/上线检查清单未落地 | 需求有文档要求 | 交付材料不完整 | 补充 docs/ 架构与部署说明 |

## Gap 关闭状态（2026-03-01）

| Gap | 状态 | 证据 |
|---|---|---|
| 错误码体系与需求不一致 | 已关闭 | 后端 ErrorCode 与相关测试已对齐 |
| 上传访问前缀 /files | 已关闭 | 上传返回 `/static/files/...`，上传测试已回归 |
| audit_log 表与接口缺失 | 已关闭 | 已有 `V6__add_audit_log.sql`、`/admin/audit-logs`、前端管理页接入 |
| 买卖一体权限不一致 | 已关闭 | 商品提审/发布接口允许 BUYER/ADMIN |
| 超时取消幂等条件不完整 | 已关闭 | 调度与订单幂等测试覆盖 TIMEOUT 语义 |
| 退款审核幂等仅管理员路径 | 已关闭 | 卖家退款审核改为条件更新，相关测试通过 |
| 收藏功能缺前端 | 已关闭 | 收藏入口、列表页与最小 e2e 已落地 |
| 公告管理缺前端 | 已关闭 | 管理端公告页面与接口联动已落地 |
| 游客访问公告被安全策略拦截 | 已关闭 | `/notices` 已放行 |
| A26 买家退款详情页缺失 | 已关闭 | 退款详情页与回归测试已落地 |
| Mock/Swagger/Postman 示例缺失 | 已关闭 | `deliverables/api-spec` 已交付 |
| 架构图/部署架构/上线检查清单未落地 | 已关闭 | `deliverables/release` 架构与 runbook 已交付 |

## 分阶段改进计划
### 阶段 1（P0 口径一致性与发布阻断）
- 目标：消除发布口径冲突，确保前后端行为一致。
- 范围：错误码体系、上传 URL 前缀。
- 验收标准：
  - ErrorCode 与前端拦截码一致；相关用例通过。
  - 上传返回 URL 与静态映射一致且可访问。
- 测试计划：
  - 后端：FileStorageServiceTest、FileControllerTest。
  - 前端：tests/upload.spec.js + 访问 URL 验证。

### 阶段 2（P1 核心功能闭环）
- 目标：补齐核心流程缺口，保证业务可用。
- 范围：audit_log、买卖一体权限、超时取消幂等、退款审核幂等、收藏、公告管理、游客公告访问。
- 验收标准：
  - 关键操作落 audit_log；审计日志页面可查询。
  - 普通用户可完成“发布→提交审核”链路。
  - 超时取消与退款审核幂等测试通过。
  - 收藏/公告管理前端可用，基础 e2e 通过。
- 测试计划：
  - 后端：OrderSchedulerTest、OrderServiceTest、Message/Notice/Review 服务测试。
  - 前端：tests/admin.spec.js + 新增收藏/公告 e2e。

### 阶段 3（P2 体验/交付补全）
- 目标：补齐页面与交付材料，降低验收阻力。
- 范围：A26 退款详情页、Mock/Swagger、架构/部署文档。
- 验收标准：页面可达、文档可用、联调资料齐全。
- 测试计划：最小页面回归 + 文档审查。

### 阶段 4（非功能与稳定性）
- 目标：补齐性能/日志/上线检查的可验证证据。
- 范围：压测脚本、上线检查清单、日志指标。
- 验收标准：有可重复执行的验证步骤。
- 测试计划：k6/JMeter（可选）+ 线上模拟验证。

## 技术风险与回滚策略
- 风险：错误码与 URL 前缀调整将影响前端与历史数据展示。
- 风险：新增 audit_log 表需迁移，涉及历史库兼容。
- 回滚策略：
  - 配置与路由类变更可通过回滚 commit 恢复。
  - 新增表结构需提供兼容迁移与回滚脚本；若出现异常，按 Flyway 版本回退或应用降级关闭审计写入。

## 工时预估与依赖项
- 预估：
  - 阶段1：0.5-1 人日
  - 阶段2：2-3 人日
  - 阶段3：1-2 人日
  - 阶段4：1 人日
- 依赖项：
  - 明确错误码口径与上传 URL 前缀最终标准
  - 明确审计日志字段与展示范围
  - 前端页面规范（A26/A21/A10）确认

## 发布建议
- 结论：**有条件可发布**。
- 条件：
  - 使用 `deliverables/release/check-env.ps1` 与 `verify-smoke.ps1` 通过发布前检查。
  - 保持现有未提交的历史改动不混入正式发布分支（尤其前端禁止文件清单）。
  - 发布后执行核心用例回归（auth/goods/order/message/upload/admin/dispute）。

