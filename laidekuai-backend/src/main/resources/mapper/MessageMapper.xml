<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.laidekuai.message.mapper.MessageMapper">

    <resultMap id="BaseResultMap" type="com.laidekuai.message.entity.Message">
        <id column="id" property="id"/>
        <result column="goods_id" property="goodsId"/>
        <result column="user_id" property="userId"/>
        <result column="sender_id" property="senderId"/>
        <result column="parent_id" property="parentId"/>
        <result column="content" property="content"/>
        <result column="status" property="status"/>
        <result column="is_purchased" property="isPurchased"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="updated_by" property="updatedBy"/>
        <result column="deleted" property="deleted"/>
    </resultMap>

    <sql id="PurchasedExists">
        EXISTS (
            SELECT 1
            FROM order_item oi
            JOIN orders o ON o.id = oi.order_id
            WHERE oi.goods_id = m.goods_id
              AND o.buyer_id = m.user_id
              AND oi.item_status IN ('PAID', 'SHIPPED', 'COMPLETED')
              AND o.status IN ('PAID', 'SHIPPED', 'COMPLETED')
              AND oi.deleted = 0
              AND o.deleted = 0
        )
    </sql>

    <!-- 商品留言列表（仅主留言） -->
    <select id="selectByGoodsId" resultMap="BaseResultMap">
        SELECT
            m.id,
            m.goods_id,
            m.user_id,
            m.sender_id,
            m.parent_id,
            m.content,
            m.status,
            CASE WHEN <include refid="PurchasedExists"/> THEN 1 ELSE 0 END AS is_purchased,
            m.created_at,
            m.updated_at,
            m.updated_by,
            m.deleted
        FROM message m
        WHERE m.goods_id = #{goodsId}
          AND m.parent_id IS NULL
          AND COALESCE(m.status, 'visible') = 'visible'
          AND m.deleted = 0
        <if test="purchasedOnly != null and purchasedOnly">
          AND <include refid="PurchasedExists"/>
        </if>
        ORDER BY m.created_at DESC
    </select>

    <!-- 兼容旧结构：message.parent_id 回复 -->
    <select id="selectReplies" resultMap="BaseResultMap">
        SELECT
            m.id,
            m.goods_id,
            m.user_id,
            m.sender_id,
            m.parent_id,
            m.content,
            m.status,
            m.is_purchased,
            m.created_at,
            m.updated_at,
            m.updated_by,
            m.deleted
        FROM message m
        WHERE m.parent_id = #{parentId}
          AND COALESCE(m.status, 'visible') = 'visible'
          AND m.deleted = 0
        ORDER BY m.created_at ASC
    </select>

</mapper>
